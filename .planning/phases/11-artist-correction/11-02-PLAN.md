---
phase: 11-artist-correction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/correction/artist/preview/types.ts
  - src/lib/correction/artist/preview/diff-engine.ts
  - src/lib/correction/artist/preview/preview-service.ts
autonomous: true

must_haves:
  truths:
    - "Preview shows field-by-field diffs between current artist and MusicBrainz data"
    - "Preview includes album count for admin impact awareness"
    - "Diff classifies changes as ADDED, MODIFIED, REMOVED, or UNCHANGED"
  artifacts:
    - path: "src/lib/correction/artist/preview/types.ts"
      provides: "ArtistCorrectionPreview, ArtistFieldDiff types"
      exports: ["ArtistCorrectionPreview", "ArtistFieldDiff", "MBArtistData"]
    - path: "src/lib/correction/artist/preview/diff-engine.ts"
      provides: "ArtistDiffEngine class for field comparison"
      exports: ["ArtistDiffEngine"]
    - path: "src/lib/correction/artist/preview/preview-service.ts"
      provides: "ArtistCorrectionPreviewService class"
      exports: ["ArtistCorrectionPreviewService"]
  key_links:
    - from: "src/lib/correction/artist/preview/preview-service.ts"
      to: "prisma.artist"
      via: "Prisma query for current artist"
      pattern: "prisma\\.artist\\.findUnique"
    - from: "src/lib/correction/artist/preview/preview-service.ts"
      to: "prisma.albumArtist"
      via: "Count albums by artist"
      pattern: "prisma\\.albumArtist\\.count"
    - from: "src/lib/correction/artist/preview/preview-service.ts"
      to: "src/lib/musicbrainz/queue-service.ts"
      via: "Fetch full MusicBrainz artist data"
      pattern: "mbService\\.getArtist"
---

<objective>
Create the artist correction preview service that generates field diffs between current database artist and MusicBrainz artist data.

Purpose: Enable admins to see exactly what will change before applying an artist correction.
Output: ArtistCorrectionPreviewService class that returns detailed field comparisons with album impact count.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-artist-correction/11-RESEARCH.md
@.planning/phases/11-artist-correction/11-CONTEXT.md

# Album preview service for pattern reference
@src/lib/correction/preview/types.ts
@src/lib/correction/preview/diff-engine.ts
@src/lib/correction/preview/preview-service.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create artist preview types and diff engine</name>
  <files>
    src/lib/correction/artist/preview/types.ts
    src/lib/correction/artist/preview/diff-engine.ts
  </files>
  <action>
Create types and diff engine for artist preview, mirroring album preview pattern.

In types.ts, define:
- MBArtistData: Full MusicBrainz artist response (id, name, sortName, disambiguation, type, country, area, lifeSpan, gender, ipis[], isnis[], aliases[])
- ArtistFieldDiff: { field: string, changeType: ChangeType, current: string|null, source: string|null }
  - Reuse ChangeType enum from src/lib/correction/preview/types.ts
- ArtistCorrectionPreview: { currentArtist: Artist, mbArtistData: MBArtistData|null, fieldDiffs: ArtistFieldDiff[], albumCount: number, summary: { totalFields, changedFields, addedFields, modifiedFields } }

In diff-engine.ts, create ArtistDiffEngine:
- generateFieldDiffs(currentArtist: Artist, mbData: MBArtistData): ArtistFieldDiff[]
- Compare fields: name, disambiguation, countryCode, artistType, area, beginDate, endDate, gender, musicbrainzId, ipi, isni
- classifyChange(current, source) helper: returns UNCHANGED, ADDED, MODIFIED, REMOVED
- generateSummary(diffs) helper: counts by change type

Key decision from RESEARCH.md: Only show gender field diff when MB type is "Person"
  </action>
  <verify>Run `pnpm type-check` - types and diff engine compile</verify>
  <done>ArtistFieldDiff and ArtistDiffEngine exported with all artist fields covered</done>
</task>

<task type="auto">
  <name>Task 2: Create artist preview service</name>
  <files>src/lib/correction/artist/preview/preview-service.ts</files>
  <action>
Create ArtistCorrectionPreviewService that generates full preview including album count.

Implementation:
1. Constructor accepts optional PrismaClient (for testing)
2. generatePreview(artistId: string, artistMbid: string) method:
   - Fetch current artist from database via prisma.artist.findUnique
   - Throw if artist not found
   - Count albums: prisma.albumArtist.count({ where: { artistId } })
   - Fetch full MB artist via mbService.getArtist with includes: ['aliases', 'area-rels', 'tags']
   - Use ArtistDiffEngine to generate field diffs
   - Return ArtistCorrectionPreview with all data

3. fetchMBArtistData(artistMbid) private helper:
   - Call getQueuedMusicBrainzService().getArtist()
   - Use PRIORITY_TIERS.ADMIN
   - Transform response to MBArtistData shape
   - Handle errors: log and return null

4. transformMBArtist(mbResponse) private helper:
   - Extract lifeSpan.begin/end (preserve partial dates as strings)
   - Extract first IPI and ISNI from arrays
   - Map area.name to area string

Export: ArtistCorrectionPreviewService class and getArtistCorrectionPreviewService factory
  </action>
  <verify>Run `pnpm type-check` - preview service compiles without errors</verify>
  <done>ArtistCorrectionPreviewService.generatePreview() returns ArtistCorrectionPreview with albumCount</done>
</task>

</tasks>

<verification>
```bash
pnpm type-check
# Verify all types and services compile

# Manual verification:
# - Check preview types cover all artist fields from research
# - Check diff engine compares all 11 fields listed
# - Verify albumCount query uses albumArtist join table
```
</verification>

<success_criteria>
1. ArtistFieldDiff covers name, disambiguation, countryCode, artistType, area, beginDate, endDate, gender, musicbrainzId, ipi, isni
2. ArtistCorrectionPreview includes albumCount for impact awareness
3. Preview service fetches full MB data with ADMIN priority
4. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-artist-correction/11-02-SUMMARY.md`
</output>
