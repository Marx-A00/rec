---
phase: 25-discogs-artist-apply
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/correction/artist/preview/preview-service.ts
  - src/lib/correction/artist/preview/types.ts
autonomous: true

must_haves:
  truths:
    - "ArtistCorrectionPreviewService.generatePreview() accepts source parameter"
    - "Discogs artists are fetched via UnifiedArtistService.getArtistDetails()"
    - "Field diffs include discogsId when source is discogs"
    - "MusicBrainz-only fields (artistType, area) skipped for Discogs source"
    - "Biography built from Discogs profile, realname, members, groups"
  artifacts:
    - path: "src/lib/correction/artist/preview/preview-service.ts"
      provides: "Discogs-aware artist preview generation"
      contains: "fetchDiscogsArtistData"
    - path: "src/lib/correction/artist/preview/types.ts"
      provides: "CorrectionSource type for artist preview"
      contains: "CorrectionSource"
  key_links:
    - from: "src/lib/correction/artist/preview/preview-service.ts"
      to: "src/lib/api/unified-artist-service.ts"
      via: "calls unifiedArtistService.getArtistDetails()"
      pattern: "getArtistDetails"
---

<objective>
Extend artist preview service for Discogs source support.

Purpose: Enable generating artist correction previews from Discogs data. When admin selects a Discogs artist from search results, the preview service fetches full artist details and generates field diffs.

Output: Preview service accepts source parameter and can fetch/transform Discogs artist data to generate field diffs alongside current artist data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-discogs-artist-apply/25-RESEARCH.md
@.planning/phases/25-discogs-artist-apply/25-CONTEXT.md
@.planning/phases/23-discogs-album-apply/23-02-SUMMARY.md

@src/lib/correction/artist/preview/preview-service.ts
@src/lib/correction/artist/preview/types.ts
@src/lib/correction/artist/preview/diff-engine.ts
@src/lib/api/unified-artist-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CorrectionSource type and update preview service signature</name>
  <files>src/lib/correction/artist/preview/types.ts, src/lib/correction/artist/preview/preview-service.ts</files>
  <action>
**In src/lib/correction/artist/preview/types.ts:**

Add CorrectionSource type after the re-export line (around line 8):

```typescript
/** Source for correction data - determines which external service to query */
export type CorrectionSource = 'musicbrainz' | 'discogs';
```

**In src/lib/correction/artist/preview/preview-service.ts:**

1. Add import for CorrectionSource:
```typescript
import type { CorrectionSource, ... } from './types';
```

2. Add import for UnifiedArtistService:
```typescript
import { unifiedArtistService } from '@/lib/api/unified-artist-service';
```

3. Update generatePreview method signature to accept source parameter with default:

```typescript
async generatePreview(
  artistId: string,
  artistMbid: string,
  source: CorrectionSource = 'musicbrainz'
): Promise<ArtistCorrectionPreview> {
```

4. Inside generatePreview, add conditional fetch based on source. Replace the existing mbArtistData fetch with:

```typescript
// Fetch source data based on correction source
let mbArtistData: MBArtistData | null;
if (source === 'discogs') {
  mbArtistData = await this.fetchDiscogsArtistData(artistMbid);
} else {
  mbArtistData = await this.fetchMBArtistData(artistMbid);
}
```

5. Update the diff generation call to pass source:

```typescript
// Generate field diffs
const fieldDiffs = this.diffEngine.generateFieldDiffs(
  currentArtist,
  mbArtistData,
  source
);
```
  </action>
  <verify>TypeScript compiles: pnpm type-check (may have errors until Task 2 adds the methods)</verify>
  <done>generatePreview accepts source parameter and conditionally routes to Discogs/MB fetch</done>
</task>

<task type="auto">
  <name>Task 2: Add fetchDiscogsArtistData method</name>
  <files>src/lib/correction/artist/preview/preview-service.ts</files>
  <action>
Add fetchDiscogsArtistData private method after fetchMBArtistData (around line 130):

```typescript
/**
 * Fetch Discogs artist data and transform to MBArtistData format.
 * Uses UnifiedArtistService for API access (handles rate limiting).
 */
private async fetchDiscogsArtistData(
  discogsId: string
): Promise<MBArtistData | null> {
  try {
    const discogsArtist = await unifiedArtistService.getArtistDetails(
      discogsId,
      { source: 'discogs', skipLocalCache: true }
    );

    return this.transformDiscogsArtist(discogsArtist, discogsId);
  } catch (error) {
    console.error('Failed to fetch Discogs artist data:', error);
    return null;
  }
}

/**
 * Transform UnifiedArtistDetails (from Discogs) to MBArtistData format.
 * Builds biography from profile, realname, members, groups per CONTEXT.md.
 */
private transformDiscogsArtist(
  artist: { 
    name: string;
    realName?: string;
    profile?: string;
    imageUrl?: string;
    country?: string;
    members?: Array<{ id?: string | number; name?: string; active?: boolean }>;
    groups?: Array<{ id?: string | number; name?: string; active?: boolean }>;
  },
  discogsId: string
): MBArtistData {
  // Build biography from Discogs fields
  const biography = this.buildDiscogsArtistBiography(artist);
  
  return {
    id: discogsId,
    name: artist.name,
    sortName: artist.name, // Discogs doesn't have sort name
    disambiguation: biography, // Store combined biography in disambiguation
    type: undefined, // Discogs doesn't categorize Person/Group/Other
    country: undefined, // Discogs country not standardized
    area: undefined, // Discogs doesn't have area
    lifeSpan: undefined, // Discogs doesn't provide structured dates
    gender: undefined, // Discogs doesn't provide gender
    ipis: undefined,
    isnis: undefined,
    aliases: undefined,
  };
}

/**
 * Build artist biography from Discogs profile and related data.
 * Combines profile text, realname, members, and groups into structured sections.
 */
private buildDiscogsArtistBiography(
  artist: {
    profile?: string;
    realName?: string;
    members?: Array<{ id?: string | number; name?: string; active?: boolean }>;
    groups?: Array<{ id?: string | number; name?: string; active?: boolean }>;
  }
): string | undefined {
  const parts: string[] = [];

  // Strip BBCode from profile (Discogs uses [b], [i], [url=] etc.)
  if (artist.profile) {
    const cleanProfile = this.stripBBCode(artist.profile);
    if (cleanProfile.trim()) {
      parts.push(cleanProfile);
    }
  }

  // Add realname if different from display name
  if (artist.realName) {
    parts.push(`Real name: ${artist.realName}`);
  }

  // Add members (for groups)
  if (artist.members && artist.members.length > 0) {
    const memberNames = artist.members
      .map(m => m.name || String(m.id))
      .filter(Boolean)
      .join(', ');
    if (memberNames) {
      parts.push(`Members: ${memberNames}`);
    }
  }

  // Add groups (for solo artists)
  if (artist.groups && artist.groups.length > 0) {
    const groupNames = artist.groups
      .map(g => g.name || String(g.id))
      .filter(Boolean)
      .join(', ');
    if (groupNames) {
      parts.push(`Groups: ${groupNames}`);
    }
  }

  return parts.length > 0 ? parts.join('\n\n') : undefined;
}

/**
 * Strip BBCode formatting from Discogs text.
 * Removes [b], [i], [u], [url=], [artist], [label] tags.
 */
private stripBBCode(text: string): string {
  return text
    .replace(/\[b\](.*?)\[\/b\]/gi, '$1')
    .replace(/\[i\](.*?)\[\/i\]/gi, '$1')
    .replace(/\[u\](.*?)\[\/u\]/gi, '$1')
    .replace(/\[url=(.*?)\](.*?)\[\/url\]/gi, '$2')
    .replace(/\[url\](.*?)\[\/url\]/gi, '$1')
    .replace(/\[a=?(.*?)\](.*?)\[\/a\]/gi, '$2') // [a=123]Name[/a] or [a]Name[/a]
    .replace(/\[l=?(.*?)\](.*?)\[\/l\]/gi, '$2') // [l=123]Name[/l] or [l]Name[/l]
    .replace(/\[[^\]]+\]/g, ''); // Remove any remaining tags
}
```
  </action>
  <verify>TypeScript compiles: pnpm type-check (may have errors until Task 3 updates diff-engine)</verify>
  <done>fetchDiscogsArtistData method fetches and transforms Discogs artist data with biography building</done>
</task>

<task type="auto">
  <name>Task 3: Update diff-engine for source-conditional field comparison</name>
  <files>src/lib/correction/artist/preview/diff-engine.ts</files>
  <action>
Update the ArtistDiffEngine class to accept source parameter and generate source-conditional diffs.

1. Update the generateFieldDiffs method signature:

```typescript
generateFieldDiffs(
  currentArtist: Artist,
  mbData: MBArtistData | null,
  source: 'musicbrainz' | 'discogs' = 'musicbrainz'
): ArtistFieldDiff[] {
```

2. Inside generateFieldDiffs, make artistType and area comparisons conditional on MusicBrainz source:

Find the artistType comparison and wrap it:
```typescript
// Artist type (MusicBrainz only - Discogs doesn't have this field)
if (source === 'musicbrainz') {
  diffs.push(this.compareField('artistType', currentArtist.artistType, mbData?.type));
}
```

Find the area comparison and wrap it:
```typescript
// Area (MusicBrainz only - Discogs doesn't have this field)
if (source === 'musicbrainz') {
  diffs.push(this.compareField('area', currentArtist.area, mbData?.area?.name));
}
```

3. Add external ID comparison with source-conditional field name. At the end of generateFieldDiffs before returning diffs:

```typescript
// External ID (conditional on source)
if (source === 'musicbrainz') {
  diffs.push(this.compareField('musicbrainzId', currentArtist.musicbrainzId, mbData?.id));
} else if (source === 'discogs') {
  diffs.push(this.compareField('discogsId', currentArtist.discogsId, mbData?.id));
}
```

4. Make country comparison source-conditional (MusicBrainz has standardized country codes):

```typescript
// Country code (MusicBrainz only - Discogs country not standardized)
if (source === 'musicbrainz') {
  diffs.push(this.compareField('countryCode', currentArtist.countryCode, mbData?.country));
}
```

Note: Keep the name and disambiguation comparisons as-is since both sources provide these.
  </action>
  <verify>pnpm type-check passes</verify>
  <done>Diff engine generates source-conditional field diffs with correct external ID field</done>
</task>

</tasks>

<verification>
- [ ] pnpm type-check passes
- [ ] generatePreview accepts source parameter
- [ ] fetchDiscogsArtistData method exists and calls UnifiedArtistService
- [ ] Biography built from profile, realname, members, groups
- [ ] BBCode stripped from Discogs profile text
- [ ] Field diffs are source-conditional (artistType/area/countryCode only for MB)
- [ ] External ID field is musicbrainzId or discogsId based on source
</verification>

<success_criteria>
Artist preview service is source-agnostic:
- Preview can be generated from MusicBrainz or Discogs based on source parameter
- Discogs artist data is transformed to common format for diff generation
- Source-specific fields (artistType, area, countryCode) only compared for MusicBrainz
- Correct external ID field (musicbrainzId vs discogsId) used in diff based on source
</success_criteria>

<output>
After completion, create .planning/phases/25-discogs-artist-apply/25-01-SUMMARY.md
</output>
