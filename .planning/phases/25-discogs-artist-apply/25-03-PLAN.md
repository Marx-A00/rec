---
phase: 25-discogs-artist-apply
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - src/graphql/schema.graphql
  - src/lib/graphql/resolvers/queries.ts
  - src/lib/graphql/resolvers/mutations.ts
  - src/graphql/queries/artist-correction.graphql
autonomous: true

must_haves:
  truths:
    - "artistCorrectionPreview query accepts source parameter"
    - "artistCorrectionApply mutation accepts source parameter"
    - "Preview resolver routes to getArtistDetails for Discogs source"
    - "Apply resolver passes source to preview service"
    - "Frontend can pass source when calling preview/apply"
  artifacts:
    - path: "src/graphql/schema.graphql"
      provides: "source parameter on artist correction queries/mutations"
      contains: "source: CorrectionSource"
    - path: "src/lib/graphql/resolvers/queries.ts"
      provides: "Source-aware artistCorrectionPreview resolver"
      contains: "getArtistDetails"
    - path: "src/lib/graphql/resolvers/mutations.ts"
      provides: "Source-aware artistCorrectionApply resolver"
      contains: "source"
  key_links:
    - from: "src/lib/graphql/resolvers/queries.ts"
      to: "src/lib/correction/artist/preview/preview-service.ts"
      via: "passes source to generatePreview"
      pattern: "generatePreview.*source"
    - from: "src/lib/graphql/resolvers/queries.ts"
      to: "src/lib/api/unified-artist-service.ts"
      via: "calls getArtistDetails for Discogs"
      pattern: "getArtistDetails"
---

<objective>
Extend GraphQL layer for Discogs artist correction preview and apply.

Purpose: Enable the frontend to request artist correction previews and apply corrections from Discogs source. The resolvers route requests to appropriate services based on source parameter.

Output: GraphQL schema, queries, and resolvers support source parameter for artist correction preview and apply operations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-discogs-artist-apply/25-RESEARCH.md
@.planning/phases/25-discogs-artist-apply/25-CONTEXT.md
@.planning/phases/25-discogs-artist-apply/25-01-SUMMARY.md
@.planning/phases/23-discogs-album-apply/23-03-SUMMARY.md

@src/graphql/schema.graphql
@src/lib/graphql/resolvers/queries.ts
@src/lib/graphql/resolvers/mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source parameter to artistCorrectionPreview query in schema</name>
  <files>src/graphql/schema.graphql</files>
  <action>
Find the artistCorrectionPreview query definition (around line 2385) and add source parameter:

Before:
```graphql
  artistCorrectionPreview(
    artistId: UUID!
    artistMbid: String!
  ): ArtistCorrectionPreview!
```

After:
```graphql
  """
  Generate a preview of corrections for an artist from MusicBrainz or Discogs.
  """
  artistCorrectionPreview(
    """
    Artist ID in our database
    """
    artistId: UUID!
    """
    MusicBrainz artist ID or Discogs artist ID (depending on source)
    """
    artistMbid: String!
    """
    Data source (default: MUSICBRAINZ)
    """
    source: CorrectionSource = MUSICBRAINZ
  ): ArtistCorrectionPreview!
```

Also update the ArtistCorrectionPreview type to include source field (around line 2798):

Add source field after albumCount:
```graphql
type ArtistCorrectionPreview {
  """
  Current artist data from database
  """
  currentArtist: Artist!
  """
  Full MusicBrainz artist data
  """
  mbArtistData: JSON
  """
  Field-by-field diffs
  """
  fieldDiffs: [ArtistFieldDiff!]!
  """
  Number of albums by this artist
  """
  albumCount: Int!
  """
  Data source used for this preview
  """
  source: String
  """
  Summary statistics
  """
  summary: ArtistPreviewSummary!
}
```
  </action>
  <verify>Run pnpm codegen - should complete without errors</verify>
  <done>GraphQL schema has source parameter on artistCorrectionPreview query</done>
</task>

<task type="auto">
  <name>Task 2: Update artistCorrectionPreview resolver for Discogs source</name>
  <files>src/lib/graphql/resolvers/queries.ts</files>
  <action>
Find the artistCorrectionPreview resolver (around line 2956) and update it to handle Discogs source.

**1. Add imports near top of file (if not already present):**

```typescript
import { unifiedArtistService } from '@/lib/api/unified-artist-service';
```

**2. Update the resolver to extract and use source:**

```typescript
artistCorrectionPreview: async (_, { artistId, artistMbid, source }, { user }) => {
  // Authentication check
  if (!user) {
    throw new GraphQLError('Authentication required', {
      extensions: { code: 'UNAUTHENTICATED' },
    });
  }

  // Authorization check - admin only
  if (!isAdmin(user.role)) {
    throw new GraphQLError('Admin access required', {
      extensions: { code: 'FORBIDDEN' },
    });
  }

  try {
    // Convert GraphQL enum to lowercase string for service layer
    const correctionSource = source?.toLowerCase() || 'musicbrainz';
    
    const { getArtistCorrectionPreviewService } = await import(
      '@/lib/correction/artist/preview/preview-service'
    );
    const previewService = getArtistCorrectionPreviewService();

    // Generate preview with source parameter
    const preview = await previewService.generatePreview(
      artistId,
      artistMbid,
      correctionSource as 'musicbrainz' | 'discogs'
    );

    return {
      currentArtist: preview.currentArtist,
      mbArtistData: preview.mbArtistData,
      fieldDiffs: preview.fieldDiffs.map(diff => ({
        field: diff.field,
        changeType: diff.changeType,
        current: diff.current,
        source: diff.source,
      })),
      albumCount: preview.albumCount,
      source: correctionSource,  // Include source in response
      summary: {
        totalFields: preview.summary.totalFields,
        changedFields: preview.summary.changedFields,
        addedFields: preview.summary.addedFields,
        modifiedFields: preview.summary.modifiedFields,
      },
    };
  } catch (error) {
    if (error instanceof GraphQLError) throw error;
    console.error('Error in artistCorrectionPreview:', error);
    throw new GraphQLError(
      'Artist correction preview failed: ' +
        (error instanceof Error ? error.message : 'Unknown error'),
      { extensions: { code: 'INTERNAL_SERVER_ERROR' } }
    );
  }
},
```
  </action>
  <verify>pnpm type-check passes</verify>
  <done>artistCorrectionPreview resolver routes to correct service based on source</done>
</task>

<task type="auto">
  <name>Task 3: Add source parameter to artistCorrectionApply mutation and update resolver</name>
  <files>src/graphql/schema.graphql, src/lib/graphql/resolvers/mutations.ts</files>
  <action>
**In src/graphql/schema.graphql:**

Find the ArtistCorrectionApplyInput type (or create if missing) and add source field.

If ArtistCorrectionApplyInput doesn't exist, find the artistCorrectionApply mutation and update its input type:

Look for the mutation definition and ensure it accepts source. If it uses inline parameters, update to:

```graphql
  """
  Apply a correction to an artist based on a previously generated preview.
  """
  artistCorrectionApply(
    """
    Artist ID to apply correction to
    """
    artistId: UUID!
    """
    Field selections for what to apply
    """
    selections: ArtistFieldSelectionsInput!
    """
    Expected updatedAt timestamp for optimistic locking
    """
    expectedUpdatedAt: DateTime!
    """
    The preview that was generated (serialized)
    """
    preview: JSON!
    """
    Data source (default: MUSICBRAINZ)
    """
    source: CorrectionSource = MUSICBRAINZ
  ): ArtistCorrectionApplyResult!
```

Also ensure ArtistFieldSelectionsInput has the discogsId field in externalIds:

Find or add the input type:
```graphql
input ArtistExternalIdSelectionsInput {
  musicbrainzId: Boolean
  discogsId: Boolean
  ipi: Boolean
  isni: Boolean
}
```

**In src/lib/graphql/resolvers/mutations.ts:**

Find the artistCorrectionApply resolver and update it to handle source:

1. Extract source from input and pass to apply service
2. Log the actual source used

The resolver should look something like:

```typescript
artistCorrectionApply: async (
  _,
  { artistId, selections, expectedUpdatedAt, preview, source },
  { user }
) => {
  // Auth checks...
  
  // Convert GraphQL enum to lowercase for service
  const correctionSource = source?.toLowerCase() || 'musicbrainz';
  
  // The apply service determines source from preview.mbArtistData.id format
  // (numeric = discogs, UUID = musicbrainz)
  // But we can also pass it explicitly if needed
  
  const { getArtistCorrectionApplyService } = await import(
    '@/lib/correction/artist/apply/apply-service'
  );
  const applyService = getArtistCorrectionApplyService();
  
  const result = await applyService.applyCorrection({
    artistId,
    preview,
    selections,
    expectedUpdatedAt: new Date(expectedUpdatedAt),
    adminUserId: user.id,
  });
  
  // ... return result
},
```
  </action>
  <verify>pnpm codegen && pnpm type-check passes</verify>
  <done>artistCorrectionApply mutation accepts source parameter</done>
</task>

<task type="auto">
  <name>Task 4: Update GraphQL query file and regenerate types</name>
  <files>src/graphql/queries/artist-correction.graphql</files>
  <action>
Find the artist correction query file (might be in a different location, check with grep).

If there's an ARTIST_CORRECTION_PREVIEW query, add source parameter:

```graphql
query ArtistCorrectionPreview(
  $artistId: UUID!
  $artistMbid: String!
  $source: CorrectionSource = MUSICBRAINZ
) {
  artistCorrectionPreview(
    artistId: $artistId
    artistMbid: $artistMbid
    source: $source
  ) {
    currentArtist {
      id
      name
      biography
      countryCode
      artistType
      area
      formedYear
      imageUrl
      musicbrainzId
      discogsId
      updatedAt
    }
    mbArtistData
    fieldDiffs {
      field
      changeType
      current
      source
    }
    albumCount
    source
    summary {
      totalFields
      changedFields
      addedFields
      modifiedFields
    }
  }
}
```

If there's an ARTIST_CORRECTION_APPLY mutation, add source parameter:

```graphql
mutation ArtistCorrectionApply(
  $artistId: UUID!
  $selections: ArtistFieldSelectionsInput!
  $expectedUpdatedAt: DateTime!
  $preview: JSON!
  $source: CorrectionSource = MUSICBRAINZ
) {
  artistCorrectionApply(
    artistId: $artistId
    selections: $selections
    expectedUpdatedAt: $expectedUpdatedAt
    preview: $preview
    source: $source
  ) {
    success
    artist {
      id
      name
      discogsId
      musicbrainzId
    }
    changes {
      metadata
      externalIds
    }
    error {
      code
      message
    }
  }
}
```

Then run:
```bash
pnpm codegen
```

This regenerates TypeScript types to include source parameter.
  </action>
  <verify>
1. pnpm codegen runs without errors
2. Generated types include source parameter
3. pnpm type-check passes
  </verify>
  <done>GraphQL types regenerated with source support for artist correction</done>
</task>

</tasks>

<verification>
- [ ] pnpm codegen runs successfully
- [ ] pnpm type-check passes
- [ ] artistCorrectionPreview query has source parameter in schema
- [ ] ArtistCorrectionPreview type has source field
- [ ] artistCorrectionApply mutation has source parameter in schema
- [ ] ArtistExternalIdSelectionsInput has discogsId field
- [ ] Resolver imports and uses unifiedArtistService
- [ ] Preview resolver passes source to generatePreview
- [ ] Apply resolver handles source parameter
</verification>

<success_criteria>
GraphQL layer supports Discogs artist corrections:
- Schema has source parameter on artistCorrectionPreview query
- Schema has source parameter on artistCorrectionApply mutation
- Resolver routes to appropriate service based on source
- Frontend can request Discogs artist previews by passing source: DISCOGS
- Types are regenerated and type-safe
</success_criteria>

<output>
After completion, create .planning/phases/25-discogs-artist-apply/25-03-SUMMARY.md
</output>
