---
phase: 04-apply-service
plan: 02
type: execute
wave: 2
depends_on: ['04-01']
files_modified:
  - src/lib/correction/apply/field-selector.ts
  - src/lib/correction/apply/index.ts
autonomous: true

must_haves:
  truths:
    - 'Field selector builds Prisma update objects conditionally'
    - 'Only selected fields are included in update data'
    - 'Album, Track, and Artist update data can be generated separately'
    - 'Cover art handles three-way choice (use_source, keep_current, clear)'
  artifacts:
    - path: 'src/lib/correction/apply/field-selector.ts'
      provides: 'Selective field update logic'
      exports:
        ['buildAlbumUpdateData', 'buildTrackUpdateData', 'buildTrackCreateData']
  key_links:
    - from: 'src/lib/correction/apply/field-selector.ts'
      to: 'src/lib/correction/apply/types.ts'
      via: 'imports FieldSelections'
      pattern: 'import.*FieldSelections.*from.*types'
    - from: 'src/lib/correction/apply/field-selector.ts'
      to: '@prisma/client'
      via: 'Prisma.AlbumUpdateInput type'
      pattern: "Prisma\\.AlbumUpdateInput"
---

<objective>
Implement selective field update logic that builds Prisma update objects based on admin selections.

Purpose: Enable partial corrections where admins choose which fields to update. This prevents unwanted overwrites and gives admins fine-grained control.
Output: field-selector.ts with functions to build conditional Prisma update payloads
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-apply-service/04-CONTEXT.md
@.planning/phases/04-apply-service/04-RESEARCH.md
@.planning/phases/04-apply-service/04-01-SUMMARY.md
@src/lib/correction/apply/types.ts
@src/lib/correction/preview/types.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement album field selector</name>
  <files>src/lib/correction/apply/field-selector.ts</files>
  <action>
Create field selector functions that build Prisma update data objects conditionally:

1. **Album Update Data Builder**

   ```typescript
   function buildAlbumUpdateData(
     preview: CorrectionPreview,
     selections: FieldSelections
   ): Prisma.AlbumUpdateInput;
   ```

   Logic:
   - Initialize empty object `data: Prisma.AlbumUpdateInput = {}`
   - For each field in selections.metadata, if true, add to data:
     - title: preview.sourceResult.title
     - releaseDate: parse preview.sourceResult.firstReleaseDate to Date or null
     - releaseType: preview.sourceResult.primaryType
     - releaseCountry: preview.mbReleaseData?.country || null
     - barcode: preview.mbReleaseData?.barcode || null
     - label: null (MusicBrainz doesn't have simple label field - leave unchanged)
   - For external IDs in selections.externalIds:
     - musicbrainzId: preview.sourceResult.releaseGroupMbid (release GROUP, not release)
     - spotifyId: keep undefined (not updated from MB - MB doesn't have Spotify IDs)
     - discogsId: keep undefined (not updated from MB)
   - For cover art based on selections.coverArt:
     - 'use_source': data.coverArtUrl = preview.sourceResult.coverArtUrl
     - 'clear': data.coverArtUrl = null, data.cloudflareImageId = null
     - 'keep_current': don't set coverArtUrl (undefined = no change)
   - Always set lastEnriched = new Date() if any changes
   - Return data (may be empty if nothing selected)

2. **Date Parsing Helper**

   ```typescript
   function parseReleaseDate(dateStr: string | undefined | null): Date | null;
   ```

   - Handle YYYY, YYYY-MM, YYYY-MM-DD formats
   - Return null for invalid/missing dates
   - Use UTC to avoid timezone issues

3. **Utility: hasAnyMetadataSelected**

   ```typescript
   function hasAnyMetadataSelected(selections: FieldSelections): boolean;
   ```

   - Check if any metadata or externalId field is selected
   - Used to decide if album update is needed
     </action>
     <verify>Run `pnpm type-check` - field-selector.ts has no errors</verify>
     <done>buildAlbumUpdateData correctly builds partial Prisma update objects</done>
     </task>

<task type="auto">
  <name>Task 2: Implement track field selectors</name>
  <files>src/lib/correction/apply/field-selector.ts</files>
  <action>
Add track-related field selector functions:

1. **Track Update Data Builder** (for MODIFIED tracks)

   ```typescript
   function buildTrackUpdateData(
     mbRecording: MBRecording,
     existingTrack: Track,
     selections: FieldSelections
   ): Prisma.TrackUpdateInput | null;
   ```

   Logic:
   - Check if this track is selected: `selections.tracks.get(existingTrack.id)`
   - If not selected, return null
   - Build update data:
     - title: mbRecording.title
     - trackNumber: mbRecording.position
     - durationMs: mbRecording.length || null (MB uses `length` not `durationMs`)
     - musicbrainzId: mbRecording.id
   - Return data

2. **Track Create Data Builder** (for NEW tracks)

   ```typescript
   function buildTrackCreateData(
     mbRecording: MBRecording,
     albumId: string,
     discNumber: number
   ): Prisma.TrackCreateInput;
   ```

   Logic:
   - Return complete track data for creation:
     - album: { connect: { id: albumId } }
     - title: mbRecording.title
     - trackNumber: mbRecording.position
     - discNumber: discNumber
     - durationMs: mbRecording.length || null
     - musicbrainzId: mbRecording.id
     - source: 'MUSICBRAINZ'
     - dataQuality: 'HIGH' (from admin-verified correction)
     - enrichmentStatus: 'COMPLETED'

3. **Track IDs to Delete Helper**

   ```typescript
   function getTrackIdsToDelete(
     orphanedTrackIds: string[],
     selections: FieldSelections
   ): string[];
   ```

   - Filter orphanedTrackIds to only those where selections.tracks.get(id) is true
   - If track is not selected for update, don't delete it either
     </action>
     <verify>Run `pnpm type-check` - all track functions compile correctly</verify>
     <done>Track create/update data builders handle all track fields</done>
     </task>

<task type="auto">
  <name>Task 3: Export and integrate</name>
  <files>src/lib/correction/apply/field-selector.ts, src/lib/correction/apply/index.ts</files>
  <action>
1. Add JSDoc comments to all exported functions in field-selector.ts explaining:
   - Purpose
   - Parameters
   - Return value
   - Example usage

2. Export from field-selector.ts:
   - buildAlbumUpdateData
   - buildTrackUpdateData
   - buildTrackCreateData
   - getTrackIdsToDelete
   - hasAnyMetadataSelected
   - parseReleaseDate (useful for testing)

3. Update src/lib/correction/apply/index.ts:
   - Add exports from './field-selector'

4. Verify all imports are correct:
   - Prisma types from '@prisma/client'
   - FieldSelections, CoverArtChoice from './types'
   - CorrectionPreview, MBRecording from '../preview/types'
   - Track from '@prisma/client'
     </action>
     <verify>Run `pnpm type-check` - entire apply module compiles</verify>
     <done>Field selector functions exported and integrated with module</done>
     </task>

</tasks>

<verification>
- [ ] `pnpm type-check` passes
- [ ] `buildAlbumUpdateData` returns partial Prisma.AlbumUpdateInput
- [ ] `buildTrackUpdateData` returns null for unselected tracks
- [ ] `buildTrackCreateData` creates complete track with proper defaults
- [ ] Cover art three-way choice is implemented correctly
- [ ] Date parsing handles YYYY, YYYY-MM, YYYY-MM-DD formats
</verification>

<success_criteria>

1. Album update data only includes selected fields (undefined for unselected)
2. Track update data respects per-track selection
3. New tracks are created with HIGH data quality (admin-verified)
4. Cover art choice handles all three cases correctly
5. No `any` types used - full type safety with Prisma types
   </success_criteria>

<output>
After completion, create `.planning/phases/04-apply-service/04-02-SUMMARY.md`
</output>
