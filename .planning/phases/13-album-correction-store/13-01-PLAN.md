---
phase: 13-album-correction-store
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/useCorrectionStore.ts
autonomous: true

must_haves:
  truths:
    - "Store exports a factory function that returns a typed Zustand store instance per albumId"
    - "Only step, mode, searchQuery, searchOffset, selectedMbid, and manualEditState persist to sessionStorage"
    - "Transient fields (previewData, applySelections, shouldEnrich, pendingAction, manualPreviewData, showAppliedState) are excluded from persistence"
    - "Atomic actions update multiple fields in a single set() call with no intermediate states"
    - "Derived selectors (isFirstStep, isLastStep, maxStep, stepLabels, isManualEditMode) are exported as standalone functions"
    - "Store cache prevents recreation on re-renders and supports cleanup on modal close"
  artifacts:
    - path: "src/stores/useCorrectionStore.ts"
      provides: "Zustand store factory with persist middleware, atomic actions, derived selectors, cache management"
      contains: "createCorrectionStore"
  key_links:
    - from: "src/stores/useCorrectionStore.ts"
      to: "zustand/middleware"
      via: "persist + createJSONStorage import"
      pattern: "persist.*createJSONStorage"
    - from: "src/stores/useCorrectionStore.ts"
      to: "sessionStorage"
      via: "createJSONStorage(() => sessionStorage)"
      pattern: "createJSONStorage.*sessionStorage"
---

<objective>
Create the `useCorrectionStore` Zustand store with persist middleware, atomic actions, and derived selectors.

Purpose: This is the foundation store that replaces `useCorrectionModalState.ts`. It centralizes all album correction modal state into a single Zustand store per albumId, with sessionStorage persistence for navigation resilience and atomic actions for consistent state transitions.

Output: `src/stores/useCorrectionStore.ts` -- a complete, fully-typed store ready for consumption by CorrectionModal and child components in Plans 02 and 03.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-album-correction-store/13-RESEARCH.md

Source files to study for patterns:
@src/stores/useSearchStore.ts (existing Zustand store with persist middleware -- follow this pattern)
@src/stores/useTourStore.ts (existing Zustand store with persist middleware)
@src/hooks/useCorrectionModalState.ts (legacy hook being replaced -- extract all state fields and actions)
@src/components/admin/correction/CorrectionModal.tsx (consumer -- understand all local state that must move to store)
@src/components/admin/correction/manual/types.ts (ManualEditFieldState type needed for store interface)
@src/components/admin/correction/apply/types.ts (UIFieldSelections type and createDefaultUISelections needed for store)
@src/lib/correction/preview/types.ts (CorrectionPreview type needed for store interface)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useCorrectionStore with full state, persist middleware, and store factory</name>
  <files>src/stores/useCorrectionStore.ts</files>
  <action>
Create `src/stores/useCorrectionStore.ts` implementing a Zustand store factory pattern with persist middleware.

**State interface (`CorrectionState`):**

Persisted fields (survive page navigation via sessionStorage):
- `step: number` (default: 0) -- current wizard step
- `mode: 'search' | 'manual'` (default: 'search') -- current correction mode
- `searchQuery: { albumTitle: string; artistName: string } | undefined` (default: undefined)
- `searchOffset: number` (default: 0) -- pagination offset
- `selectedMbid: string | undefined` (default: undefined) -- selected MusicBrainz release group MBID
- `manualEditState: ManualEditFieldState | undefined` (default: undefined)

Transient fields (NOT persisted -- excluded via partialize):
- `previewData: CorrectionPreview | null` (default: null) -- loaded preview for search mode
- `applySelections: UIFieldSelections | null` (default: null) -- field selections for apply step
- `manualPreviewData: CorrectionPreview | null` (default: null) -- computed preview for manual mode
- `shouldEnrich: boolean` (default: false) -- enrichment checkbox state
- `showAppliedState: boolean` (default: false) -- success animation flag
- `pendingAction: (() => void) | null` (default: null) -- unsaved changes dialog closure (not serializable)
- `showUnsavedDialog: boolean` (default: false) -- unsaved changes dialog visibility

**Actions interface (`CorrectionActions`):**

Step navigation:
- `setStep(step: number): void` -- validates against maxStep for current mode
- `nextStep(): void` -- increments step if not at max
- `prevStep(): void` -- decrements step if not at 0

Atomic mode switching:
- `enterSearch(): void` -- sets `{ mode: 'search', step: 1, manualEditState: undefined, manualPreviewData: null }` in single set()
- `enterManualEdit(): void` -- sets `{ mode: 'manual', step: 1, searchQuery: undefined, selectedMbid: undefined }` in single set()

Search state:
- `setSearchQuery(query: { albumTitle: string; artistName: string }): void` -- sets query AND resets offset to 0
- `setSearchOffset(offset: number): void`

Atomic result selection:
- `selectResult(mbid: string): void` -- sets `{ selectedMbid: mbid, step: 2 }` in single set() (ASTORE-05)

Atomic preview loading:
- `setPreviewLoaded(preview: CorrectionPreview): void` -- sets `{ previewData: preview, applySelections: createDefaultUISelections(preview), shouldEnrich: false }` in single set() (ASTORE-06)

Manual edit state:
- `setManualEditState(state: ManualEditFieldState): void`
- `setManualPreviewData(preview: CorrectionPreview | null): void`
- `clearManualEditState(): void` -- sets `{ manualEditState: undefined, manualPreviewData: null }`

Apply state:
- `setApplySelections(selections: UIFieldSelections): void`
- `setShouldEnrich(value: boolean): void`
- `setShowAppliedState(value: boolean): void`

Unsaved changes dialog:
- `setPendingAction(action: (() => void) | null): void`
- `setShowUnsavedDialog(show: boolean): void`
- `confirmUnsavedDiscard(): void` -- executes pendingAction then clears both (ASTORE-08)
- `cancelUnsavedDialog(): void` -- clears both pendingAction and showUnsavedDialog

Reset:
- `clearState(): void` -- resets ALL fields to defaults AND removes sessionStorage entry

**Store factory pattern:**

```typescript
const createCorrectionStore = (albumId: string) =>
  create<CorrectionStore>()(
    persist(
      (set, get) => ({
        // ...state + actions
      }),
      {
        name: `correction-modal-${albumId}`,
        storage: createJSONStorage(() => sessionStorage),
        partialize: (state) => ({
          step: state.step,
          mode: state.mode,
          searchQuery: state.searchQuery,
          searchOffset: state.searchOffset,
          selectedMbid: state.selectedMbid,
          manualEditState: state.manualEditState,
        }),
      }
    )
  );
```

**Cache management:**
- `storeCache` as module-level `Map<string, StoreApi<CorrectionStore>>`
- `getCorrectionStore(albumId: string)` -- returns cached store or creates new one
- `clearCorrectionStoreCache(albumId: string)` -- calls clearState(), removes from cache, removes sessionStorage key

**Derived selectors (exported as standalone functions):**
- `isFirstStep(state: CorrectionState): boolean` -- `state.step === 0`
- `isLastStep(state: CorrectionState): boolean` -- `state.step === (state.mode === 'manual' ? 2 : 3)`
- `maxStep(state: CorrectionState): number` -- `state.mode === 'manual' ? 2 : 3`
- `stepLabels(state: CorrectionState): string[]` -- manual: `['Current Data', 'Edit', 'Apply']`, search: `['Current Data', 'Search', 'Compare', 'Apply']`
- `isManualEditMode(state: CorrectionState): boolean` -- `state.mode === 'manual'`

**Type exports:**
- Export `CorrectionState`, `CorrectionActions`, `CorrectionStore` types
- Export `SearchQueryState` type (for `{ albumTitle: string; artistName: string }`)
- Export `getCorrectionStore`, `clearCorrectionStoreCache`
- Export all derived selectors

**Import the `createDefaultUISelections` function from `@/components/admin/correction/apply/types`** for use in `setPreviewLoaded`.

**IMPORTANT constraints:**
- Zero `any` types -- every field, action parameter, and return type must be explicitly typed
- Follow `useSearchStore.ts` pattern for persist middleware setup
- Use `import type` for type-only imports (ManualEditFieldState, CorrectionPreview, UIFieldSelections)
- The store hook returned by `getCorrectionStore` should be `UseBoundStore<StoreApi<CorrectionStore>>` (the standard Zustand create() return type)
- Do NOT use `require()` -- use proper ES module imports for createDefaultUISelections
  </action>
  <verify>
Run TypeScript type check:
```bash
pnpm type-check
```
Should pass with zero errors. The store file should compile cleanly since it only creates types and exports -- no consumers yet.

Verify the file exists and has no `any` types:
```bash
grep -n "any" src/stores/useCorrectionStore.ts
```
Should return zero matches (or only matches inside comments/string literals, not type annotations).

Verify key exports exist:
```bash
grep -n "export" src/stores/useCorrectionStore.ts
```
Should show exports for: CorrectionState, CorrectionActions, CorrectionStore, SearchQueryState, getCorrectionStore, clearCorrectionStoreCache, isFirstStep, isLastStep, maxStep, stepLabels, isManualEditMode.
  </verify>
  <done>
`src/stores/useCorrectionStore.ts` exists with:
- Full CorrectionState interface (6 persisted + 7 transient fields)
- Full CorrectionActions interface (all actions listed above)
- Persist middleware with sessionStorage and partialize excluding transient fields
- Store factory with Map cache and cleanup function
- 5 derived selectors exported as standalone functions
- Zero `any` types
- `pnpm type-check` passes
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes with zero errors
2. `src/stores/useCorrectionStore.ts` exists and is well-formed
3. Zero `any` types in the file
4. Persist middleware uses sessionStorage (not localStorage)
5. partialize excludes: previewData, applySelections, manualPreviewData, shouldEnrich, showAppliedState, pendingAction, showUnsavedDialog
6. Atomic actions (selectResult, setPreviewLoaded, enterSearch, enterManualEdit, confirmUnsavedDiscard) each use a single `set()` call
7. All derived selectors are pure functions taking CorrectionState and returning computed values
</verification>

<success_criteria>
- Store compiles with zero TypeScript errors
- Store follows established patterns from useSearchStore.ts and useTourStore.ts
- All state fields from useCorrectionModalState.ts AND CorrectionModal.tsx local state are covered
- Store is ready for consumption in Plans 02 and 03
</success_criteria>

<output>
After completion, create `.planning/phases/13-album-correction-store/13-01-SUMMARY.md`
</output>
