---
phase: 13-album-correction-store
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/components/admin/correction/CorrectionModal.tsx
  - src/components/admin/correction/search/SearchView.tsx
autonomous: true

must_haves:
  truths:
    - "CorrectionModal reads step, mode, and all state from useCorrectionStore instead of useCorrectionModalState hook"
    - "CorrectionModal initializes store via getCorrectionStore(albumId) when modal opens"
    - "CorrectionModal clears store via clearCorrectionStoreCache(albumId) when modal closes or apply succeeds"
    - "CorrectionModal local useState calls for previewData, applySelections, manualPreviewData, shouldEnrich, showAppliedState, pendingAction, showUnsavedDialog are removed -- all read from store"
    - "SearchView receives only album prop -- reads searchQuery, searchOffset, selectedMbid from store"
    - "SearchView no longer imports useCorrectionModalState type or receives modalState prop"
    - "Mutation callbacks (onSuccess/onError) remain in CorrectionModal orchestrating toast + store + queryClient"
    - "Modal opens and displays identical UI as before (zero visual changes)"
  artifacts:
    - path: "src/components/admin/correction/CorrectionModal.tsx"
      provides: "Refactored modal shell using Zustand store instead of useState/hook"
    - path: "src/components/admin/correction/search/SearchView.tsx"
      provides: "Search view reading state from store with album-only prop"
  key_links:
    - from: "src/components/admin/correction/CorrectionModal.tsx"
      to: "src/stores/useCorrectionStore.ts"
      via: "getCorrectionStore and clearCorrectionStoreCache imports"
      pattern: "getCorrectionStore|clearCorrectionStoreCache"
    - from: "src/components/admin/correction/search/SearchView.tsx"
      to: "src/stores/useCorrectionStore.ts"
      via: "getCorrectionStore import for reading search state"
      pattern: "getCorrectionStore"
---

<objective>
Refactor CorrectionModal and SearchView to read all state from useCorrectionStore, eliminating the useCorrectionModalState hook import and removing all local useState calls for shared state.

Purpose: This wires the new Zustand store into the two primary consumers -- the modal shell (which orchestrates everything) and SearchView (which is the heaviest prop-drilled component). After this plan, the modal uses the store for all state and SearchView's props are reduced from 4 to 1 (album only).

Output: Refactored `CorrectionModal.tsx` and `SearchView.tsx` that use Zustand store selectors instead of props/hooks for shared state.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-album-correction-store/13-RESEARCH.md
@.planning/phases/13-album-correction-store/13-01-SUMMARY.md

Source files being modified:
@src/components/admin/correction/CorrectionModal.tsx (full current source -- the primary refactor target)
@src/components/admin/correction/search/SearchView.tsx (second refactor target)
@src/stores/useCorrectionStore.ts (created in Plan 01 -- the store being consumed)

Type references (read-only, not modified):
@src/components/admin/correction/manual/types.ts (ManualEditFieldState, createInitialEditState, hasUnsavedChanges)
@src/components/admin/correction/apply/types.ts (UIFieldSelections, createDefaultUISelections, toGraphQLSelections, calculateHasSelections)
@src/lib/correction/preview/types.ts (CorrectionPreview)
@src/components/admin/correction/StepIndicator.tsx (stays prop-driven -- verify props unchanged)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor CorrectionModal to use Zustand store</name>
  <files>src/components/admin/correction/CorrectionModal.tsx</files>
  <action>
Refactor `CorrectionModal.tsx` to replace all local state management with the Zustand store.

**Remove these imports:**
- `import { useCorrectionModalState } from '@/hooks/useCorrectionModalState';`

**Add these imports:**
- `import { getCorrectionStore, clearCorrectionStoreCache, isFirstStep as isFirstStepSelector, isLastStep as isLastStepSelector, maxStep as maxStepSelector, stepLabels as stepLabelsSelector, isManualEditMode as isManualEditModeSelector } from '@/stores/useCorrectionStore';`
- Use `import type { ... }` for type-only imports from the store

**Store initialization:**
Replace the `useCorrectionModalState(albumId)` call with:
```typescript
const store = albumId ? getCorrectionStore(albumId) : null;
```

Then subscribe to individual state fields using the store hook with selectors:
```typescript
const step = store?.((s) => s.step) ?? 0;
const mode = store?.((s) => s.mode) ?? 'search';
const selectedMbid = store?.((s) => s.selectedMbid);
const manualEditState = store?.((s) => s.manualEditState);
const previewData = store?.((s) => s.previewData) ?? null;
const applySelections = store?.((s) => s.applySelections);
const manualPreviewData = store?.((s) => s.manualPreviewData) ?? null;
const shouldEnrich = store?.((s) => s.shouldEnrich) ?? false;
const showAppliedState = store?.((s) => s.showAppliedState) ?? false;
const showUnsavedDialog = store?.((s) => s.showUnsavedDialog) ?? false;
const pendingAction = store?.((s) => s.pendingAction) ?? null;
```

Use derived selectors:
```typescript
const isFirstStepVal = store ? store(isFirstStepSelector) : true;
const isLastStepVal = store ? store(isLastStepSelector) : false;
const maxStepVal = store ? store(maxStepSelector) : 3;
const stepLabelsVal = store ? store(stepLabelsSelector) : ['Current Data', 'Search', 'Compare', 'Apply'];
const isManualEditModeVal = store ? store(isManualEditModeSelector) : false;
```

Get action references:
```typescript
const storeActions = store?.getState();
// Or access actions via selectors:
const setStep = store?.getState().setStep;
const nextStep = store?.getState().nextStep;
const prevStep = store?.getState().prevStep;
// ... etc
```

**Remove these useState calls (they move to the store):**
- `const [previewData, setPreviewData] = useState<CorrectionPreview | null>(null);`
- `const [applySelections, setApplySelections] = useState<UIFieldSelections | null>(null);`
- `const [manualPreviewData, setManualPreviewData] = useState<CorrectionPreview | null>(null);`
- `const [showAppliedState, setShowAppliedState] = useState(false);`
- `const [showUnsavedDialog, setShowUnsavedDialog] = useState(false);`
- `const [pendingAction, setPendingAction] = useState<(() => void) | null>(null);`
- `const [shouldEnrich, setShouldEnrich] = useState(false);`

**Refactor handler functions to use store actions:**

`handleClose`:
- Replace `clearState()` with `clearCorrectionStoreCache(albumId!)` (also clears sessionStorage)
- Replace `clearManualEditState()` -- now handled by clearState in store
- Replace `setPreviewData(null)`, `setManualPreviewData(null)`, `setShowAppliedState(false)` -- all handled by store reset
- For unsaved changes check: use `store?.getState().setPendingAction(...)` and `store?.getState().setShowUnsavedDialog(true)`

`handleResultSelect`:
- Replace `modalState.setSelectedResult(result.releaseGroupMbid); nextStep();` with `store?.getState().selectResult(result.releaseGroupMbid);` (atomic action handles both)

`handleEnterManualEdit`:
- Replace `setManualEditMode(true); setCurrentStep(1);` with `store?.getState().enterManualEdit();` (atomic action)

`handleEnterSearch`:
- Replace the multi-setState block with `store?.getState().enterSearch();` (atomic action)
- Keep the unsaved changes check before switching, using store actions for dialog

`handleManualPreview`:
- Use `store?.getState().setManualEditState(editedState)` and `store?.getState().setManualPreviewData(preview)` and `store?.getState().setStep(2)`

`handlePreviewLoaded`:
- Replace with `store?.getState().setPreviewLoaded(preview);` (atomic action)

`handleUnsavedConfirm`:
- Replace with `store?.getState().confirmUnsavedDiscard();`

`handleUnsavedCancel`:
- Replace with `store?.getState().cancelUnsavedDialog();`

**Mutation callbacks stay in CorrectionModal** (AMODAL-03):
- `applyMutation.onSuccess`: orchestrates toast + store actions + queryClient.invalidateQueries + auto-close timer
- `manualApplyMutation.onSuccess`: same pattern
- Replace `setShowAppliedState(true)` with `store?.getState().setShowAppliedState(true)`
- Replace `setShouldEnrich(...)` with `store?.getState().setShouldEnrich(...)`
- Replace `clearState(); onClose()` with `clearCorrectionStoreCache(albumId!); onClose()`

**StepIndicator props remain unchanged** (CLEAN-04):
- Still receives `currentStep`, `onStepClick`, `steps` as props
- Use the store-derived values: `<StepIndicator currentStep={step} onStepClick={setStep!} steps={stepLabelsVal} />`

**Pass props to child components with reduced interface:**
- `SearchView`: `<SearchView album={album} />` (remove onResultSelect, onManualEdit, modalState)
- `PreviewView`: `<PreviewView albumId={albumId} releaseGroupMbid={selectedMbid} onPreviewLoaded={handlePreviewLoaded} />` (keep for now -- Plan 03 removes the remaining props)
- `ApplyView`: Keep current props for now -- Plan 03 reduces them
- `ManualEditView`: Keep current props for now -- Plan 03 reduces them

**IMPORTANT:** PreviewView, ApplyView, and ManualEditView keep their current props in THIS plan. They will be refactored in Plan 03. Only SearchView is fully migrated here because it directly depends on `modalState` which is being removed.

**Verify:** The `useCorrectionModalState` import is REMOVED from CorrectionModal.tsx. The `modalState` destructuring is REMOVED.
  </action>
  <verify>
```bash
# Verify useCorrectionModalState is no longer imported in CorrectionModal
grep -n "useCorrectionModalState" src/components/admin/correction/CorrectionModal.tsx
# Should return zero matches

# Type check passes
pnpm type-check

# Verify no any types introduced
grep -n ": any" src/components/admin/correction/CorrectionModal.tsx
# Should return zero matches
```
  </verify>
  <done>
CorrectionModal.tsx:
- Imports getCorrectionStore and clearCorrectionStoreCache from store
- No longer imports useCorrectionModalState
- No longer has useState calls for previewData, applySelections, manualPreviewData, shouldEnrich, showAppliedState, pendingAction, showUnsavedDialog
- All state reads go through store selectors
- All state mutations go through store actions
- Mutation callbacks remain in component (toast + store + queryClient orchestration)
- StepIndicator still receives props (not refactored)
- SearchView receives album prop only
- pnpm type-check passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor SearchView to read from store (album-only prop)</name>
  <files>src/components/admin/correction/search/SearchView.tsx</files>
  <action>
Refactor `SearchView.tsx` to read search state from the Zustand store instead of receiving it through `modalState` prop.

**Remove these imports:**
- `import type { useCorrectionModalState } from '@/hooks/useCorrectionModalState';`

**Add these imports:**
- `import { getCorrectionStore } from '@/stores/useCorrectionStore';`

**Change props interface (ACHILD-01):**

Before:
```typescript
export interface SearchViewProps {
  album: CurrentDataViewAlbum;
  onResultSelect: (result: GraphQLScoredResult) => void;
  onManualEdit: () => void;
  modalState: ReturnType<typeof useCorrectionModalState>;
}
```

After:
```typescript
export interface SearchViewProps {
  album: CurrentDataViewAlbum;
}
```

**Wire up store inside component:**
```typescript
const store = getCorrectionStore(album.id);
const searchQuery = store((s) => s.searchQuery);
const searchOffset = store((s) => s.searchOffset);
```

Get actions from store:
```typescript
const setSearchQuery = store.getState().setSearchQuery;
const setSearchOffset = store.getState().setSearchOffset;
const selectResult = store.getState().selectResult;
const enterManualEdit = store.getState().enterManualEdit;
```

**Update handler functions:**

`handleSearch`:
- Use `setSearchQuery(query)` from store (already resets offset atomically)

`handleLoadMore`:
- Use `store.getState().setSearchOffset(searchOffset + 10)`

`handleResultClick`:
- Replace `setSelectedResult(result.releaseGroupMbid); onResultSelect(result);` with `selectResult(result.releaseGroupMbid);` (atomic: sets mbid + advances to step 2)

**Replace `onManualEdit` callback:**
- Where `onManualEdit` was called, use `enterManualEdit()` from store (atomic action that sets mode + step)

**Keep the rest of the component logic unchanged:**
- GraphQL query hook (`useSearchCorrectionCandidatesQuery`) stays the same
- `SearchInputs` and `SearchResults` sub-components stay the same
- Skeleton, error state, "before first search" placeholder all stay the same
- `isSearchTriggered` local state stays (UI-only, not shared)

**Update function signature:**
```typescript
export function SearchView({ album }: SearchViewProps) {
```
  </action>
  <verify>
```bash
# Verify useCorrectionModalState is no longer referenced in SearchView
grep -n "useCorrectionModalState\|modalState\|onResultSelect\|onManualEdit" src/components/admin/correction/search/SearchView.tsx
# Should only match the new store-based logic, not old prop names

# Verify store import exists
grep -n "getCorrectionStore" src/components/admin/correction/search/SearchView.tsx
# Should return at least one match

# Type check passes
pnpm type-check

# Verify no any types
grep -n ": any" src/components/admin/correction/search/SearchView.tsx
# Should return zero matches
```
  </verify>
  <done>
SearchView.tsx:
- Props reduced to `{ album: CurrentDataViewAlbum }` only
- Reads searchQuery, searchOffset from store via selectors
- Uses store actions: setSearchQuery, setSearchOffset, selectResult, enterManualEdit
- No longer imports useCorrectionModalState type
- No longer receives modalState, onResultSelect, or onManualEdit props
- All existing functionality preserved (search, pagination, result selection, manual edit switch)
- pnpm type-check passes
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes with zero errors
2. `useCorrectionModalState` is no longer imported in CorrectionModal.tsx or SearchView.tsx
3. CorrectionModal.tsx has zero useState calls for shared state (only useToast and useQueryClient remain)
4. SearchView.tsx props interface only contains `album`
5. SearchView.tsx imports getCorrectionStore from store
6. CorrectionModal.tsx uses getCorrectionStore and clearCorrectionStoreCache
7. StepIndicator still receives props (unchanged)
8. Zero `any` types introduced in either file
9. `pnpm lint` passes (no unused imports/variables)
</verification>

<success_criteria>
- Modal opens and displays identical UI as before (zero visual changes)
- Search query persists across page navigations
- Step navigation works identically (mode switches, preview loading)
- SearchView receives album prop only
- useCorrectionModalState import removed from both files
- pnpm type-check and pnpm lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-album-correction-store/13-02-SUMMARY.md`
</output>
