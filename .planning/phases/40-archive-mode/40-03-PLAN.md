---
phase: 40-archive-mode
plan: 03
type: execute
wave: 3
depends_on: [40-02]
files_modified:
  - src/components/ui/calendar.tsx
  - src/components/uncover/ArchiveCalendar.tsx
  - src/app/(main)/game/archive/page.tsx
  - src/app/(main)/game/archive/[date]/page.tsx
  - src/app/m/game/archive/page.tsx
  - src/app/m/game/archive/[date]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Player can access past daily puzzles via calendar"
    - "Calendar shows which days were played/missed"
    - "Calendar color-codes: green = won, red = lost, gray = missed"
  artifacts:
    - path: "src/components/ui/calendar.tsx"
      provides: "shadcn Calendar component"
      contains: "Calendar"
    - path: "src/components/uncover/ArchiveCalendar.tsx"
      provides: "Archive calendar with play status"
      exports: ["ArchiveCalendar"]
    - path: "src/app/(main)/game/archive/page.tsx"
      provides: "Desktop archive calendar page"
    - path: "src/app/m/game/archive/page.tsx"
      provides: "Mobile archive calendar page"
  key_links:
    - from: "src/components/uncover/ArchiveCalendar.tsx"
      to: "useMyUncoverSessionsQuery"
      via: "GraphQL hook"
      pattern: "useMyUncoverSessionsQuery"
---

<objective>
Add shadcn Calendar component and create archive calendar UI with routes.

Purpose: ARCHIVE-01 requires player access to past puzzles. ARCHIVE-02 requires calendar showing played/missed status. Calendar provides visual navigation to any past challenge since game epoch.

Output: Calendar component installed, ArchiveCalendar component, desktop and mobile archive routes.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-archive-mode/40-CONTEXT.md
@.planning/phases/40-archive-mode/40-RESEARCH.md
@.planning/phases/40-archive-mode/40-02-SUMMARY.md
@src/app/(main)/game/page.tsx (existing game page pattern)
@src/app/m/game/page.tsx (existing mobile game pattern)
@src/lib/daily-challenge/date-utils.ts (GAME_EPOCH, toUTCMidnight)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Calendar component</name>
  <files>src/components/ui/calendar.tsx</files>
  <action>
Install the shadcn/ui Calendar component which includes react-day-picker:

```bash
pnpm dlx shadcn@latest add calendar
```

This will:
1. Add react-day-picker dependency
2. Create src/components/ui/calendar.tsx
3. Update tailwind config if needed

Verify installation:
```bash
pnpm list react-day-picker
```

If shadcn prompts for overwrite, choose "yes" to get latest version.
  </action>
  <verify>
File src/components/ui/calendar.tsx exists.
`pnpm list react-day-picker` shows version installed.
`pnpm type-check` passes.
  </verify>
  <done>
shadcn Calendar component installed at src/components/ui/calendar.tsx.
react-day-picker dependency added to package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ArchiveCalendar component</name>
  <files>src/components/uncover/ArchiveCalendar.tsx</files>
  <action>
Create `src/components/uncover/ArchiveCalendar.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Calendar } from '@/components/ui/calendar';
import { useMyUncoverSessionsQuery } from '@/generated/graphql';
import { GAME_EPOCH, toUTCMidnight } from '@/lib/daily-challenge/date-utils';
import {
  format,
  isBefore,
  isAfter,
  isSameDay,
  startOfMonth,
  endOfMonth,
} from 'date-fns';
import { CalendarDays, ArrowLeft } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface ArchiveCalendarProps {
  /** Whether this is mobile view (affects navigation routes) */
  mobile?: boolean;
}

/**
 * Calendar view for browsing and accessing past daily challenges.
 * ARCHIVE-02: Color codes days - green = won, red = lost, gray = missed
 */
export function ArchiveCalendar({ mobile = false }: ArchiveCalendarProps) {
  const router = useRouter();
  const [currentMonth, setCurrentMonth] = useState(new Date());

  // Fetch sessions for current month (efficient date-range query)
  const { data, isLoading } = useMyUncoverSessionsQuery({
    fromDate: startOfMonth(currentMonth).toISOString(),
    toDate: endOfMonth(currentMonth).toISOString(),
  });

  // Build lookup map: dateKey -> 'won' | 'lost'
  const sessionMap = new Map<string, 'won' | 'lost'>();
  data?.myUncoverSessions?.forEach((session) => {
    const dateKey = format(new Date(session.challengeDate), 'yyyy-MM-dd');
    sessionMap.set(dateKey, session.won ? 'won' : 'lost');
  });

  const today = toUTCMidnight(new Date());

  // Custom modifiers for day cell styling
  const modifiers = {
    won: (date: Date) => {
      const key = format(date, 'yyyy-MM-dd');
      return sessionMap.get(key) === 'won';
    },
    lost: (date: Date) => {
      const key = format(date, 'yyyy-MM-dd');
      return sessionMap.get(key) === 'lost';
    },
    missed: (date: Date) => {
      const key = format(date, 'yyyy-MM-dd');
      const normalized = toUTCMidnight(date);
      const isPast = isBefore(normalized, today);
      const isAfterEpoch =
        isAfter(normalized, GAME_EPOCH) || isSameDay(normalized, GAME_EPOCH);
      return isPast && isAfterEpoch && !sessionMap.has(key);
    },
  };

  // Modifier styles for color-coding
  const modifiersClassNames = {
    won: 'bg-green-500/30 text-green-700 dark:text-green-400 hover:bg-green-500/40',
    lost: 'bg-red-500/20 text-red-700 dark:text-red-400 hover:bg-red-500/30',
    missed: 'bg-muted text-muted-foreground hover:bg-muted/80',
  };

  const handleDayClick = (date: Date | undefined) => {
    if (!date) return;

    const normalized = toUTCMidnight(date);

    // Don't allow clicks before epoch or future dates
    if (isBefore(normalized, GAME_EPOCH) || isAfter(normalized, today)) {
      return;
    }

    // If today, navigate to main game page (per CONTEXT.md)
    if (isSameDay(normalized, today)) {
      router.push(mobile ? '/m/game' : '/game');
      return;
    }

    // Navigate to archive game for this date
    const dateStr = format(normalized, 'yyyy-MM-dd');
    router.push(mobile ? `/m/game/archive/${dateStr}` : `/game/archive/${dateStr}`);
  };

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <CalendarDays className="h-5 w-5" />
          <h2 className="text-lg font-semibold">Archive</h2>
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={() => router.push(mobile ? '/m/game' : '/game')}
        >
          <ArrowLeft className="mr-2 h-4 w-4" />
          Today's Game
        </Button>
      </div>

      {/* Calendar */}
      {isLoading ? (
        <div className="flex h-80 items-center justify-center rounded-md border">
          <div className="text-muted-foreground">Loading calendar...</div>
        </div>
      ) : (
        <Calendar
          mode="single"
          selected={undefined}
          onSelect={handleDayClick}
          month={currentMonth}
          onMonthChange={setCurrentMonth}
          modifiers={modifiers}
          modifiersClassNames={modifiersClassNames}
          disabled={(date) => {
            const normalized = toUTCMidnight(date);
            return isBefore(normalized, GAME_EPOCH) || isAfter(normalized, today);
          }}
          fromDate={GAME_EPOCH}
          toDate={today}
          className="rounded-md border"
        />
      )}

      {/* Legend */}
      <div className="flex flex-wrap gap-4 text-xs text-muted-foreground">
        <div className="flex items-center gap-2">
          <div className="h-4 w-4 rounded bg-green-500/30" />
          <span>Won</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="h-4 w-4 rounded bg-red-500/20" />
          <span>Lost</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="h-4 w-4 rounded bg-muted" />
          <span>Missed</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="h-4 w-4 rounded border" />
          <span>Not Played</span>
        </div>
      </div>
    </div>
  );
}
```

Key implementation notes:
- Uses date-fns for all date operations (already in package.json)
- Queries only current month's sessions (efficient)
- Disabled dates before GAME_EPOCH and after today
- Today redirects to main game (not archive)
- Mobile prop controls navigation routes
  </action>
  <verify>
Run `pnpm type-check` - no TypeScript errors.
File exports ArchiveCalendar component.
  </verify>
  <done>
ArchiveCalendar.tsx created with month navigation and status color-coding.
Uses myUncoverSessions query with date range filter.
Handles today redirect and disabled dates correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create archive route pages (desktop and mobile)</name>
  <files>
    src/app/(main)/game/archive/page.tsx,
    src/app/(main)/game/archive/[date]/page.tsx,
    src/app/m/game/archive/page.tsx,
    src/app/m/game/archive/[date]/page.tsx
  </files>
  <action>
Create 4 route files:

1. Desktop calendar page - `src/app/(main)/game/archive/page.tsx`:
```typescript
import { ArchiveCalendar } from '@/components/uncover/ArchiveCalendar';

export const metadata = {
  title: 'Archive | Daily Uncover',
  description: 'Play past daily album art puzzles',
};

export default function ArchivePage() {
  return (
    <div className="container mx-auto max-w-lg py-8 px-4">
      <ArchiveCalendar mobile={false} />
    </div>
  );
}
```

2. Desktop archive game page - `src/app/(main)/game/archive/[date]/page.tsx`:
```typescript
import { notFound } from 'next/navigation';
import { parseISO, isBefore, isAfter, isSameDay } from 'date-fns';
import { GAME_EPOCH, toUTCMidnight } from '@/lib/daily-challenge/date-utils';

interface PageProps {
  params: Promise<{ date: string }>;
}

export async function generateMetadata({ params }: PageProps) {
  const { date } = await params;
  return {
    title: `Archive: ${date} | Daily Uncover`,
    description: `Play the daily album art puzzle from ${date}`,
  };
}

export default async function ArchiveGamePage({ params }: PageProps) {
  const { date: dateParam } = await params;

  // Validate date format
  let challengeDate: Date;
  try {
    challengeDate = toUTCMidnight(parseISO(dateParam));
  } catch {
    notFound();
  }

  // Validate date is within valid range
  const today = toUTCMidnight(new Date());

  if (isBefore(challengeDate, GAME_EPOCH)) {
    notFound();
  }

  // Don't allow today or future via archive route
  if (isAfter(challengeDate, today) || isSameDay(challengeDate, today)) {
    notFound();
  }

  // Render placeholder - actual game component in Plan 04
  return (
    <div className="container mx-auto max-w-4xl py-8 px-4">
      <div className="text-center">
        <h1 className="text-xl font-bold mb-4">Archive: {dateParam}</h1>
        <p className="text-muted-foreground">Game component will be added in next plan.</p>
      </div>
    </div>
  );
}
```

3. Mobile calendar page - `src/app/m/game/archive/page.tsx`:
```typescript
import { ArchiveCalendar } from '@/components/uncover/ArchiveCalendar';

export const metadata = {
  title: 'Archive | Daily Uncover',
  description: 'Play past daily album art puzzles',
};

export default function MobileArchivePage() {
  return (
    <div className="px-4 py-6">
      <ArchiveCalendar mobile={true} />
    </div>
  );
}
```

4. Mobile archive game page - `src/app/m/game/archive/[date]/page.tsx`:
```typescript
import { notFound } from 'next/navigation';
import { parseISO, isBefore, isAfter, isSameDay } from 'date-fns';
import { GAME_EPOCH, toUTCMidnight } from '@/lib/daily-challenge/date-utils';

interface PageProps {
  params: Promise<{ date: string }>;
}

export async function generateMetadata({ params }: PageProps) {
  const { date } = await params;
  return {
    title: `Archive: ${date} | Daily Uncover`,
    description: `Play the daily album art puzzle from ${date}`,
  };
}

export default async function MobileArchiveGamePage({ params }: PageProps) {
  const { date: dateParam } = await params;

  // Validate date format
  let challengeDate: Date;
  try {
    challengeDate = toUTCMidnight(parseISO(dateParam));
  } catch {
    notFound();
  }

  // Validate date is within valid range
  const today = toUTCMidnight(new Date());

  if (isBefore(challengeDate, GAME_EPOCH)) {
    notFound();
  }

  // Don't allow today or future via archive route
  if (isAfter(challengeDate, today) || isSameDay(challengeDate, today)) {
    notFound();
  }

  // Render placeholder - actual game component in Plan 04
  return (
    <div className="px-4 py-6">
      <div className="text-center">
        <h1 className="text-xl font-bold mb-4">Archive: {dateParam}</h1>
        <p className="text-muted-foreground">Game component will be added in next plan.</p>
      </div>
    </div>
  );
}
```

Create directories as needed:
```bash
mkdir -p src/app/\(main\)/game/archive/\[date\]
mkdir -p src/app/m/game/archive/\[date\]
```
  </action>
  <verify>
Run `pnpm type-check` - no TypeScript errors.
All 4 route files exist.
Run `pnpm dev` briefly and visit `/game/archive` - calendar should render.
  </verify>
  <done>
Desktop archive routes created: /game/archive and /game/archive/[date].
Mobile archive routes created: /m/game/archive and /m/game/archive/[date].
Date validation enforces GAME_EPOCH <= date < today.
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes
2. `pnpm lint` passes
3. shadcn Calendar component installed
4. ArchiveCalendar component renders month grid
5. All 4 archive routes exist and validate dates
6. Calendar color-codes won/lost/missed days
</verification>

<success_criteria>
- Calendar component from shadcn/ui installed
- ArchiveCalendar shows month grid with play status colors
- Desktop routes /game/archive and /game/archive/[date] work
- Mobile routes /m/game/archive and /m/game/archive/[date] work
- Date validation rejects before-epoch and today/future dates
- Today's date in calendar links to main game (not archive)
</success_criteria>

<output>
After completion, create `.planning/phases/40-archive-mode/40-03-SUMMARY.md`
</output>
