---
phase: 40-archive-mode
plan: 02
type: execute
wave: 2
depends_on: [40-01]
files_modified:
  - src/graphql/schema.graphql
  - src/graphql/queries/archive.graphql
  - src/lib/graphql/resolvers/queries.ts
  - src/lib/graphql/resolvers/mutations.ts
autonomous: true

must_haves:
  truths:
    - "Client can query user's session history for calendar display"
    - "Client can query archive stats separately from daily stats"
    - "Archive game mutations work with date parameter"
  artifacts:
    - path: "src/graphql/schema.graphql"
      provides: "Archive GraphQL types and operations"
      contains: "UncoverArchiveStats"
    - path: "src/graphql/queries/archive.graphql"
      provides: "Client-side archive queries"
      contains: "myArchiveStats"
    - path: "src/lib/graphql/resolvers/queries.ts"
      provides: "Archive query resolvers"
      contains: "myUncoverSessions"
  key_links:
    - from: "src/lib/graphql/resolvers/queries.ts"
      to: "src/lib/uncover/archive-stats-service.ts"
      via: "dynamic import"
      pattern: "getArchiveStats"
---

<objective>
Add GraphQL schema types and resolvers for archive mode.

Purpose: ARCHIVE-02 requires calendar to show played/missed status (needs session history query). ARCHIVE-04 requires archive stats display (needs archive stats query). Archive game flow needs mutation support with date parameter.

Output: GraphQL types for archive stats, session history query, archive stats query, and archive session mutations.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-archive-mode/40-CONTEXT.md
@.planning/phases/40-archive-mode/40-RESEARCH.md
@.planning/phases/40-archive-mode/40-01-SUMMARY.md
@src/graphql/schema.graphql (existing Uncover types)
@src/lib/graphql/resolvers/queries.ts
@src/lib/graphql/resolvers/mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add archive types to GraphQL schema</name>
  <files>src/graphql/schema.graphql</files>
  <action>
Add new types near existing Uncover types in schema.graphql:

1. UncoverArchiveStats type (mirror daily stats but NO streaks):
```graphql
"""
Archive game statistics (separate from daily stats).
Archive games don't affect streaks.
"""
type UncoverArchiveStats {
  id: UUID!
  gamesPlayed: Int!
  gamesWon: Int!
  totalAttempts: Int!
  "Win count by attempt number (index 0 = 1-guess wins, etc.)"
  winDistribution: [Int!]!
  "Computed: gamesWon / gamesPlayed (0 if no games)"
  winRate: Float!
}
```

2. UncoverSessionHistory type for calendar:
```graphql
"""
Session history entry for calendar display.
Shows which days were played and won/lost.
"""
type UncoverSessionHistory {
  id: UUID!
  challengeDate: DateTime!
  won: Boolean!
  attemptCount: Int!
  completedAt: DateTime
}
```

3. Add to Query type:
```graphql
"""
Get user's archive stats (separate from daily stats).
Returns null if no archive games played.
"""
myArchiveStats: UncoverArchiveStats

"""
Get user's session history for calendar display (ARCHIVE-02).
Optional date filters for efficient month-by-month loading.
"""
myUncoverSessions(fromDate: DateTime, toDate: DateTime): [UncoverSessionHistory!]!
```

4. Add to Mutation type:
```graphql
"""
Start an archive session for a specific date (not today).
Used for playing past puzzles.
"""
startArchiveSession(date: DateTime!): StartSessionResult!
```

5. Update existing submitGuess and skipGuess mutations to optionally accept mode:
```graphql
"""
Submit a guess for the current session (requires auth).
Mode defaults to 'daily'. Use 'archive' for archive games.
"""
submitGuess(sessionId: UUID!, albumId: UUID!, mode: String): GuessResult!

"""
Skip current guess - counts as wrong guess (requires auth).
Mode defaults to 'daily'. Use 'archive' for archive games.
"""
skipGuess(sessionId: UUID!, mode: String): GuessResult!
```
  </action>
  <verify>
Run `pnpm codegen` - should complete without GraphQL syntax errors.
New types appear in generated/graphql.ts.
  </verify>
  <done>
UncoverArchiveStats and UncoverSessionHistory types added.
myArchiveStats and myUncoverSessions queries added.
startArchiveSession mutation added.
submitGuess and skipGuess have optional mode parameter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side archive queries</name>
  <files>src/graphql/queries/archive.graphql</files>
  <action>
Create new file `src/graphql/queries/archive.graphql`:

```graphql
# Archive Mode Queries
# Used for calendar display and archive stats

"""
Get user's archive stats for stats modal display.
"""
query MyArchiveStats {
  myArchiveStats {
    id
    gamesPlayed
    gamesWon
    totalAttempts
    winDistribution
    winRate
  }
}

"""
Get user's session history for archive calendar.
Filters by date range for efficient month loading.
"""
query MyUncoverSessions($fromDate: DateTime, $toDate: DateTime) {
  myUncoverSessions(fromDate: $fromDate, toDate: $toDate) {
    id
    challengeDate
    won
    attemptCount
    completedAt
  }
}

"""
Start an archive session for a past date.
"""
mutation StartArchiveSession($date: DateTime!) {
  startArchiveSession(date: $date) {
    session {
      id
      status
      attemptCount
      won
      startedAt
      completedAt
      guesses {
        id
        guessNumber
        guessedAlbum {
          id
          title
          cloudflareImageId
          artistName
        }
        isSkipped
        isCorrect
        guessedAt
      }
    }
    challengeId
    imageUrl
    cloudflareImageId
  }
}
```

Run `pnpm codegen` to generate hooks.
  </action>
  <verify>
Run `pnpm codegen` - generates useMyArchiveStatsQuery, useMyUncoverSessionsQuery, useStartArchiveSessionMutation.
Check src/generated/graphql.ts for new hooks.
  </verify>
  <done>
archive.graphql file created with queries and mutation.
Generated hooks available: useMyArchiveStatsQuery, useMyUncoverSessionsQuery, useStartArchiveSessionMutation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement archive resolvers</name>
  <files>src/lib/graphql/resolvers/queries.ts, src/lib/graphql/resolvers/mutations.ts</files>
  <action>
1. In queries.ts, add myArchiveStats resolver:
```typescript
myArchiveStats: async (_parent: unknown, _args: unknown, context: GraphQLContext) => {
  if (!context.user) {
    throw new GraphQLError('Authentication required');
  }

  const { getArchiveStats } = await import('@/lib/uncover/archive-stats-service');
  const stats = await getArchiveStats(context.user.id, context.prisma);

  // Return null if no games played (consistent with daily stats behavior)
  if (stats.gamesPlayed === 0) {
    return null;
  }

  return {
    id: context.user.id, // Use as pseudo-ID for GraphQL
    ...stats,
  };
},
```

2. In queries.ts, add myUncoverSessions resolver:
```typescript
myUncoverSessions: async (
  _parent: unknown,
  args: { fromDate?: Date; toDate?: Date },
  context: GraphQLContext
) => {
  if (!context.user) {
    throw new GraphQLError('Authentication required');
  }

  const sessions = await context.prisma.uncoverSession.findMany({
    where: {
      userId: context.user.id,
      completedAt: { not: null }, // Only completed games
      challenge: {
        date: {
          ...(args.fromDate && { gte: args.fromDate }),
          ...(args.toDate && { lte: args.toDate }),
        },
      },
    },
    include: {
      challenge: {
        select: {
          date: true,
        },
      },
    },
    orderBy: {
      challenge: {
        date: 'desc',
      },
    },
  });

  return sessions.map(session => ({
    id: session.id,
    challengeDate: session.challenge.date,
    won: session.won,
    attemptCount: session.attemptCount,
    completedAt: session.completedAt,
  }));
},
```

3. In mutations.ts, add startArchiveSession resolver:
```typescript
startArchiveSession: async (
  _parent: unknown,
  args: { date: Date },
  context: GraphQLContext
) => {
  if (!context.user) {
    throw new GraphQLError('Authentication required');
  }

  const { startArchiveSession } = await import('@/lib/uncover/game-service');
  const { toUTCMidnight, GAME_EPOCH } = await import('@/lib/daily-challenge/date-utils');

  const challengeDate = toUTCMidnight(new Date(args.date));
  const today = toUTCMidnight(new Date());

  // Validate date range
  if (challengeDate < GAME_EPOCH) {
    throw new GraphQLError('Cannot access challenges before game launch');
  }
  if (challengeDate >= today) {
    throw new GraphQLError('Cannot access future or today\\'s challenge via archive');
  }

  const result = await startArchiveSession(context.user.id, challengeDate, context.prisma);

  return {
    session: {
      id: result.session.id,
      status: result.session.status,
      attemptCount: result.session.attemptCount,
      won: result.session.won,
      startedAt: result.session.startedAt,
      completedAt: result.session.completedAt,
      guesses: result.session.guesses.map(g => ({
        id: g.id,
        guessNumber: g.guessNumber,
        guessedAlbum: g.guessedAlbumId ? {
          id: g.guessedAlbumId,
          title: '', // Will be populated by field resolver
          cloudflareImageId: null,
          artistName: '',
        } : null,
        isSkipped: !g.guessedAlbumId,
        isCorrect: g.isCorrect,
        guessedAt: g.guessedAt,
      })),
    },
    challengeId: result.challenge.id,
    imageUrl: result.challenge.album.cloudflareImageId
      ? `https://imagedelivery.net/${process.env.CLOUDFLARE_ACCOUNT_HASH}/${result.challenge.album.cloudflareImageId}/public`
      : result.challenge.album.coverArtUrl || '',
    cloudflareImageId: result.challenge.album.cloudflareImageId,
  };
},
```

4. Update submitGuess and skipGuess in mutations.ts to accept mode parameter:
```typescript
// Add mode to args type and pass to game service
submitGuess: async (
  _parent: unknown,
  args: { sessionId: string; albumId: string; mode?: string },
  context: GraphQLContext
) => {
  // ... existing validation ...
  const { submitGuess } = await import('@/lib/uncover/game-service');
  const result = await submitGuess(
    args.sessionId,
    args.albumId,
    context.user.id,
    context.prisma,
    (args.mode as 'daily' | 'archive') || 'daily'
  );
  // ... rest unchanged ...
},

skipGuess: async (
  _parent: unknown,
  args: { sessionId: string; mode?: string },
  context: GraphQLContext
) => {
  // ... existing validation ...
  const { skipGuess } = await import('@/lib/uncover/game-service');
  const result = await skipGuess(
    args.sessionId,
    context.user.id,
    context.prisma,
    (args.mode as 'daily' | 'archive') || 'daily'
  );
  // ... rest unchanged ...
},
```

Remember to add necessary imports (GraphQLError if not present).
  </action>
  <verify>
Run `pnpm type-check` - no TypeScript errors.
Run `pnpm codegen` - regenerates types.
Run `pnpm lint:fix` to fix any formatting.
  </verify>
  <done>
myArchiveStats resolver returns archive stats (no streaks).
myUncoverSessions resolver returns session history with date filters.
startArchiveSession resolver validates date and starts archive session.
submitGuess and skipGuess accept mode parameter.
  </done>
</task>

</tasks>

<verification>
1. `pnpm codegen` succeeds
2. `pnpm type-check` passes
3. `pnpm lint` passes
4. Generated hooks exist: useMyArchiveStatsQuery, useMyUncoverSessionsQuery, useStartArchiveSessionMutation
5. GraphQL schema has all new types and operations
</verification>

<success_criteria>
- UncoverArchiveStats type exists without streak fields
- myUncoverSessions query supports date range filtering
- startArchiveSession mutation validates date range (epoch to yesterday)
- submitGuess and skipGuess accept optional mode parameter
- All resolvers use dynamic imports for game services
</success_criteria>

<output>
After completion, create `.planning/phases/40-archive-mode/40-02-SUMMARY.md`
</output>
