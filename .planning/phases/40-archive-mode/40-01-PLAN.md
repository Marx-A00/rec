---
phase: 40-archive-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/uncover/archive-stats-service.ts
  - src/lib/uncover/game-service.ts
autonomous: true

must_haves:
  truths:
    - "Archive stats are stored separately from daily stats"
    - "Archive games never affect daily streaks"
    - "Archive wins/losses increment archive games played and win rate"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "UncoverArchiveStats model"
      contains: "model UncoverArchiveStats"
    - path: "src/lib/uncover/archive-stats-service.ts"
      provides: "Archive stats CRUD operations"
      exports: ["updateArchiveStats", "getArchiveStats"]
    - path: "src/lib/uncover/game-service.ts"
      provides: "Mode-aware game service"
      contains: "mode.*archive"
  key_links:
    - from: "src/lib/uncover/game-service.ts"
      to: "src/lib/uncover/archive-stats-service.ts"
      via: "import and conditional call"
      pattern: "updateArchiveStats"
---

<objective>
Add database model and service layer for archive mode stats tracking.

Purpose: ARCHIVE-03 requires archive games not affect daily streaks. ARCHIVE-04 requires archive games still track win/loss stats. A separate stats table cleanly separates daily vs archive tracking without mixing concerns.

Output: UncoverArchiveStats Prisma model, archive stats service, game service extended with mode flag.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-archive-mode/40-CONTEXT.md
@.planning/phases/40-archive-mode/40-RESEARCH.md
@prisma/schema.prisma (UncoverPlayerStats model pattern)
@src/lib/uncover/stats-service.ts (existing stats service pattern)
@src/lib/uncover/game-service.ts (existing game service)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UncoverArchiveStats Prisma model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add UncoverArchiveStats model after UncoverPlayerStats model. This model tracks archive game stats SEPARATELY from daily stats.

Model fields (mirror UncoverPlayerStats but NO streak fields):
- id: UUID primary key (gen_random_uuid())
- userId: String @unique (one-to-one with User)
- gamesPlayed: Int @default(0)
- gamesWon: Int @default(0)
- totalAttempts: Int @default(0)
- winDistribution: Int[] @default([0,0,0,0,0,0]) - same as daily
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- user: User relation

NO lastPlayedDate (archive games can be played in any order).
NO currentStreak/maxStreak (ARCHIVE-03: streaks are daily-only).

Add relation to User model: `uncoverArchiveStats UncoverArchiveStats?`

Use snake_case table name: `uncover_archive_stats`
Use @map for column names (games_played, etc.)
Add index on userId.

After editing schema, run:
- pnpm prisma migrate dev --name add-uncover-archive-stats
- pnpm prisma generate
  </action>
  <verify>
Run `pnpm prisma generate` - should complete without errors.
Run `pnpm prisma migrate dev --name add-uncover-archive-stats` - migration should apply.
Check that `UncoverArchiveStats` type is available in Prisma client.
  </verify>
  <done>
UncoverArchiveStats model exists in schema.prisma.
Migration created and applied.
Prisma client regenerated with new type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create archive stats service</name>
  <files>src/lib/uncover/archive-stats-service.ts</files>
  <action>
Create new file `src/lib/uncover/archive-stats-service.ts`.

Follow the pattern from stats-service.ts but SIMPLER (no streak logic):

Export interface ArchiveStats:
- gamesPlayed: number
- gamesWon: number
- totalAttempts: number
- winRate: number
- winDistribution: number[]

Export function updateArchiveStats(input: { userId, won, attemptCount }, prisma):
1. Fetch existing stats via findUnique
2. Calculate new winDistribution (same logic as daily stats)
3. Upsert stats (increment gamesPlayed, conditionally increment gamesWon, update winDistribution)
4. NO streak logic, NO lastPlayedDate check

Export function getArchiveStats(userId, prisma) -> ArchiveStats:
1. Fetch stats via findUnique
2. Return zeros if not found
3. Calculate winRate from gamesWon/gamesPlayed

Use proper TypeScript types (no `any`). Import PrismaClient type.
  </action>
  <verify>
Run `pnpm type-check` - no TypeScript errors.
File exports updateArchiveStats and getArchiveStats functions.
  </verify>
  <done>
archive-stats-service.ts exists with updateArchiveStats and getArchiveStats functions.
No streak-related logic present (ARCHIVE-03 compliance).
TypeScript types correct.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend game service with archive mode</name>
  <files>src/lib/uncover/game-service.ts</files>
  <action>
Modify game-service.ts to support archive mode:

1. Import updateArchiveStats from './archive-stats-service'

2. Add mode parameter to submitGuess and skipGuess functions:
   - Add `mode?: 'daily' | 'archive'` parameter (default: 'daily')
   - Update function signatures

3. In submitGuess, after gameOver check:
   ```typescript
   if (gameResult.gameOver) {
     if (mode === 'daily') {
       // Existing: updates streaks
       await updatePlayerStats({ ... }, prisma);
     } else {
       // NEW: archive mode - no streaks
       await updateArchiveStats({ userId, won: isCorrect, attemptCount: newAttemptCount }, prisma);
     }
   }
   ```

4. Same pattern in skipGuess:
   ```typescript
   if (gameResult.gameOver) {
     if (mode === 'daily') {
       await updatePlayerStats({ ... }, prisma);
     } else {
       await updateArchiveStats({ userId, won: false, attemptCount: newAttemptCount }, prisma);
     }
   }
   ```

5. Add new function startArchiveSession for archive games:
   ```typescript
   export async function startArchiveSession(
     userId: string,
     challengeDate: Date,
     prisma: PrismaClient
   ): Promise<StartSessionResult>
   ```
   - Use getOrCreateDailyChallenge(challengeDate) instead of no-arg call
   - Otherwise same logic as startSession
   - Returns same StartSessionResult type

This ensures ARCHIVE-03 (no streak impact) and ARCHIVE-04 (archive stats tracked).
  </action>
  <verify>
Run `pnpm type-check` - no TypeScript errors.
submitGuess and skipGuess have mode parameter.
startArchiveSession function exists.
  </verify>
  <done>
game-service.ts updated with mode parameter.
Archive mode calls updateArchiveStats instead of updatePlayerStats.
startArchiveSession function added for date-based session creation.
  </done>
</task>

</tasks>

<verification>
1. `pnpm prisma generate` succeeds
2. `pnpm type-check` passes
3. `pnpm lint` passes (run `pnpm lint:fix` if needed)
4. UncoverArchiveStats model visible in Prisma client
5. game-service.ts has mode parameter on submitGuess and skipGuess
6. archive-stats-service.ts exports both functions
</verification>

<success_criteria>
- UncoverArchiveStats Prisma model created with no streak fields
- Migration applied successfully
- archive-stats-service.ts handles archive stats without streak logic
- game-service.ts conditionally routes to archive or daily stats based on mode
- All TypeScript types correct (no `any`)
</success_criteria>

<output>
After completion, create `.planning/phases/40-archive-mode/40-01-SUMMARY.md`
</output>
