---
phase: 28-album-creation-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logging/llama-logger.ts
  - src/lib/graphql/resolvers/mutations.ts
autonomous: true

must_haves:
  truths:
    - "Album created via addAlbum mutation produces LlamaLog entry"
    - "LlamaLog entry has category: CREATED"
    - "LlamaLog entry has isRootJob: true"
    - "LlamaLog entry has userId populated from authenticated user"
  artifacts:
    - path: "src/lib/logging/llama-logger.ts"
      provides: "LlamaLogData interface with userId field"
      contains: "userId?: string"
    - path: "src/lib/graphql/resolvers/mutations.ts"
      provides: "addAlbum mutation with creation logging"
      contains: "album:created"
  key_links:
    - from: "addAlbum mutation"
      to: "LlamaLogger.logEnrichment"
      via: "post-commit logging call"
      pattern: "logger\\.logEnrichment.*CREATED"
---

<objective>
Instrument the addAlbum GraphQL mutation with LlamaLog creation tracking.

Purpose: Track all user-initiated album creations with full provenance. The addAlbum mutation is the single entry point for:
- CREATE-01: Recommendation creation (user adds album for rec)
- CREATE-05: Search/save flows (user searches, saves album)
- CREATE-06: Admin manual adds
- CREATE-07: Any other direct album creation

Note: CREATE-02 (addAlbumToCollection) does NOT create albums — that mutation links existing albums to collections using `tx.collectionAlbum.create()` with an existing albumId. See 28-CONTEXT.md for clarification.

Output: addAlbum mutation logs category: CREATED to LlamaLog after successful database commit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-album-creation-tracking/28-CONTEXT.md
@.planning/phases/28-album-creation-tracking/28-RESEARCH.md

@src/lib/logging/llama-logger.ts
@src/lib/graphql/resolvers/mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add userId field to LlamaLogData interface</name>
  <files>src/lib/logging/llama-logger.ts</files>
  <action>
The LlamaLog Prisma model has a `userId` field (line 436 in schema.prisma), but the `LlamaLogData` interface does not expose it.

Add `userId` field to the `LlamaLogData` interface:

```typescript
export interface LlamaLogData {
  // ... existing fields ...
  triggeredBy?: string | null;
  /** User ID for tracking manual/user-initiated operations */
  userId?: string | null;
}
```

Then update the `logEnrichment` method to write userId to the database. In the `this.prisma.llamaLog.create` call, add:

```typescript
userId: data.userId ?? null,
```

Place it near the other optional fields (e.g., after `triggeredBy`).
  </action>
  <verify>
Run `pnpm type-check` — should pass with no errors about userId.
  </verify>
  <done>
LlamaLogData interface has userId?: string | null field, and logEnrichment() writes userId to database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add creation logging to addAlbum mutation</name>
  <files>src/lib/graphql/resolvers/mutations.ts</files>
  <action>
Import createLlamaLogger at the top of the file:
```typescript
import { createLlamaLogger } from '@/lib/logging/llama-logger';
```

In the addAlbum mutation, AFTER the existing logActivity call (around line 900), add LlamaLogger creation logging:

```typescript
// Log album creation to LlamaLog (after DB commit)
const logger = createLlamaLogger(prisma);
try {
  await logger.logEnrichment({
    entityType: 'ALBUM',
    entityId: album.id,
    albumId: album.id,
    operation: 'album:created',
    category: 'CREATED',
    sources: input.musicbrainzId ? ['MUSICBRAINZ'] : ['USER'],
    status: 'SUCCESS',
    fieldsEnriched: fieldsCreated, // Already computed above: ['title', 'releaseDate', ...]
    dataQualityAfter: album.dataQuality,
    isRootJob: true, // User-initiated creations are root jobs
    userId: user.id, // Track which user created the album
  });
} catch (logError) {
  console.warn('[LlamaLogger] Failed to log album creation:', logError);
  // Don't throw - album creation succeeded, logging is secondary
}
```

Key points:
- Use simple operation name `album:created` — userId already identifies the source context
- The `fieldsCreated` array is already computed by existing code (lines 888-894)
- Keep existing logActivity call for backward compatibility
- Log AFTER database commit (not inside transaction)
- Never throw from logging code
  </action>
  <verify>
Run `pnpm type-check` — should pass.
Run `pnpm lint` — should have no new errors in mutations.ts.
  </verify>
  <done>
addAlbum mutation imports createLlamaLogger and calls logger.logEnrichment after album creation with category: CREATED, isRootJob: true, userId: user.id, and fieldsEnriched: fieldsCreated.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. `pnpm type-check` passes
2. `pnpm lint` shows no new errors in mutations.ts or llama-logger.ts
3. Manual verification: Create album via addAlbum mutation and check LlamaLog table for CREATED entry with userId populated
</verification>

<success_criteria>
- TypeScript compiles without errors
- LlamaLogData interface includes userId?: string | null
- logEnrichment() writes userId to database
- addAlbum mutation contains LlamaLogger import and logEnrichment call
- Logging call uses category: 'CREATED', isRootJob: true, userId: user.id
- Logging call uses existing fieldsCreated array for fieldsEnriched
- Logging wrapped in try-catch to prevent failures from breaking album creation
</success_criteria>

<output>
After completion, create `.planning/phases/28-album-creation-tracking/28-01-SUMMARY.md`
</output>
