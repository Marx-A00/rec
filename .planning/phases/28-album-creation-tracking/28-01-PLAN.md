---
phase: 28-album-creation-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/graphql/resolvers/mutations.ts
autonomous: true

must_haves:
  truths:
    - "Album created via addAlbum mutation produces LlamaLog entry"
    - "LlamaLog entry has category: CREATED"
    - "LlamaLog entry has isRootJob: true"
    - "LlamaLog entry has userId when user is authenticated"
  artifacts:
    - path: "src/lib/graphql/resolvers/mutations.ts"
      provides: "addAlbum mutation with creation logging"
      contains: "album:created"
  key_links:
    - from: "addAlbum mutation"
      to: "LlamaLogger.logEnrichment"
      via: "post-commit logging call"
      pattern: "logger\\.logEnrichment.*CREATED"
---

<objective>
Instrument the addAlbum GraphQL mutation with LlamaLog creation tracking.

Purpose: Track all user-initiated album creations (recommendations, admin adds, collection adds, search->save flows) with full provenance. This is the primary entry point for album creation in the application.

Output: addAlbum mutation logs category: CREATED to LlamaLog after successful database commit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-album-creation-tracking/28-CONTEXT.md
@.planning/phases/28-album-creation-tracking/28-RESEARCH.md

@src/lib/logging/llama-logger.ts
@src/lib/graphql/resolvers/mutations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add creation logging to addAlbum mutation</name>
  <files>src/lib/graphql/resolvers/mutations.ts</files>
  <action>
Import createLlamaLogger at the top of the file (from '@/lib/logging/llama-logger').

In the addAlbum mutation, AFTER the album is created and artist associations are complete (after the for loop for artists), add LlamaLog creation logging:

1. Replace or augment the existing logActivity call with LlamaLogger:

```typescript
// Log album creation (after DB commit)
const logger = createLlamaLogger(prisma);
try {
  await logger.logEnrichment({
    entityType: 'ALBUM',
    entityId: album.id,
    operation: 'album:created:recommendation', // Source-specific
    category: 'CREATED',
    sources: input.musicbrainzId ? ['MUSICBRAINZ'] : ['USER'],
    status: 'SUCCESS',
    fieldsEnriched: fieldsCreated,
    userId: user.id,
    dataQualityAfter: album.dataQuality,
    isRootJob: true, // User-initiated creations are root jobs
  });
} catch (logError) {
  console.warn('[LlamaLogger] Failed to log album creation:', logError);
  // Don't throw - album creation succeeded, logging is secondary
}
```

2. Keep the existing logActivity call for backward compatibility with older activity tracking, OR remove it if LlamaLogger fully replaces it. The research indicates LlamaLogger is the new standard.

3. Use the already-computed `fieldsCreated` array for the fieldsEnriched field.

Key points from RESEARCH.md:
- Log AFTER database commit (not inside transaction)
- Never throw from logging code
- Use 'album:created:recommendation' as operation name (source-specific)
- isRootJob: true for user-initiated operations
  </action>
  <verify>
Run TypeScript type-check: `pnpm type-check`
Verify import is correct and no syntax errors.
  </verify>
  <done>
addAlbum mutation imports createLlamaLogger and calls logger.logEnrichment after album creation with category: CREATED, isRootJob: true, userId populated.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. `pnpm type-check` passes
2. `pnpm lint` shows no new errors in mutations.ts
3. Manual verification: Create album via addAlbum mutation and check LlamaLog table for CREATED entry
</verification>

<success_criteria>
- TypeScript compiles without errors
- addAlbum mutation contains LlamaLogger import and logEnrichment call
- Logging call uses category: 'CREATED', isRootJob: true, and passes userId
- Logging wrapped in try-catch to prevent failures from breaking album creation
</success_criteria>

<output>
After completion, create `.planning/phases/28-album-creation-tracking/28-01-SUMMARY.md`
</output>
