---
phase: 28-album-creation-tracking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/spotify/mappers.ts
  - src/lib/queue/processors/musicbrainz-processor.ts
autonomous: true

must_haves:
  truths:
    - "Album created via Spotify sync produces LlamaLog entry"
    - "Album created via MusicBrainz sync produces LlamaLog entry"
    - "Sync LlamaLog entries have category: CREATED"
    - "Sync LlamaLog entries have isRootJob: false (child of sync job)"
    - "Sync LlamaLog entries have parentJobId linking to sync job"
  artifacts:
    - path: "src/lib/spotify/mappers.ts"
      provides: "Spotify sync with creation logging"
      contains: "album:created:spotify-sync"
    - path: "src/lib/queue/processors/musicbrainz-processor.ts"
      provides: "MusicBrainz sync with creation logging"
      contains: "album:created:musicbrainz-sync"
  key_links:
    - from: "processSpotifyAlbum"
      to: "LlamaLogger.logEnrichment"
      via: "post-create logging call"
      pattern: "album:created:spotify-sync"
    - from: "handleMusicBrainzSyncNewReleases"
      to: "LlamaLogger.logEnrichment"
      via: "post-create logging call"
      pattern: "album:created:musicbrainz-sync"
---

<objective>
Instrument Spotify and MusicBrainz sync operations with LlamaLog creation tracking.

Purpose: Track all automated album creations from sync operations with full provenance, including parent job hierarchy for batch tracking.

Output: Both sync paths log category: CREATED entries with parentJobId for batch correlation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-album-creation-tracking/28-CONTEXT.md
@.planning/phases/28-album-creation-tracking/28-RESEARCH.md

@src/lib/logging/llama-logger.ts
@src/lib/spotify/mappers.ts
@src/lib/queue/processors/musicbrainz-processor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add creation logging to Spotify sync</name>
  <files>src/lib/spotify/mappers.ts</files>
  <action>
Import createLlamaLogger at the top of mappers.ts (from '@/lib/logging/llama-logger').

In the processSpotifyAlbum function, AFTER the album is created (after line ~314 where album.create is called), add LlamaLog creation logging:

```typescript
// Log album creation (after DB commit)
const logger = createLlamaLogger(prisma);
try {
  await logger.logEnrichment({
    entityType: 'ALBUM',
    entityId: album.id,
    operation: 'album:created:spotify-sync',
    category: 'CREATED',
    sources: ['SPOTIFY'],
    status: 'SUCCESS',
    fieldsEnriched: [
      'title',
      'releaseDate',
      'releaseType',
      'trackCount',
      'coverArtUrl',
      'spotifyId',
      'spotifyUrl',
    ],
    userId: null, // Automated sync, no user
    dataQualityAfter: album.dataQuality,
    jobId: metadataOptions?.jobId || `spotify-album-${album.id}`,
    parentJobId: metadataOptions?.batchId || metadataOptions?.jobId,
    isRootJob: false, // Child of sync batch
    metadata: {
      syncSource: source,
      syncTimestamp: new Date().toISOString(),
      query: metadataOptions?.query,
      country: metadataOptions?.country,
    },
  });
} catch (logError) {
  console.warn(`[LlamaLogger] Failed to log Spotify album creation for ${album.id}:`, logError);
}
```

Place this AFTER the album creation (around line 316, after the console.log for "Created album").

Key points:
- userId is null (automated operation)
- isRootJob: false (child of sync job)
- parentJobId links to the batch/sync job for provenance
- Include sync context in metadata field
  </action>
  <verify>
Run TypeScript type-check: pnpm type-check
Verify import is correct and logging is placed after album.create.
  </verify>
  <done>
processSpotifyAlbum imports createLlamaLogger and calls logger.logEnrichment after album creation with category: CREATED, isRootJob: false, parentJobId populated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add creation logging to MusicBrainz sync</name>
  <files>src/lib/queue/processors/musicbrainz-processor.ts</files>
  <action>
Import createLlamaLogger at the top of musicbrainz-processor.ts (from '@/lib/logging/llama-logger').

In the handleMusicBrainzSyncNewReleases function, AFTER each album is created (after the prisma.album.create call in the for loop, around line 169), add LlamaLog creation logging:

```typescript
// Log album creation (after DB commit)
const logger = createLlamaLogger(prisma);
try {
  await logger.logEnrichment({
    entityType: 'ALBUM',
    entityId: album.id,
    operation: 'album:created:musicbrainz-sync',
    category: 'CREATED',
    sources: ['MUSICBRAINZ'],
    status: 'SUCCESS',
    fieldsEnriched: ['title', 'musicbrainzId', 'releaseDate', 'artists'],
    userId: null, // Automated sync, no user
    dataQualityAfter: 'MEDIUM', // MusicBrainz data is medium quality
    parentJobId: data.requestId || 'mb-sync-batch',
    isRootJob: false, // Child of sync batch
    metadata: {
      syncSource: 'musicbrainz_new_releases',
      syncTimestamp: new Date().toISOString(),
      query: data.query,
      dateRange: data.dateRange,
      genres: data.genres,
    },
  });
} catch (logError) {
  console.warn(`[LlamaLogger] Failed to log MusicBrainz album creation for ${album.id}:`, logError);
}
```

Place this AFTER the album creation and console.log "Created album" line, before the enrichment job is queued.

Note: The function also creates artists. For Phase 28, only log album creation. Artist creation logging is Phase 29.

Key points:
- userId is null (automated operation)
- isRootJob: false (child of sync job)
- parentJobId uses data.requestId for batch correlation
- Include sync parameters in metadata field
  </action>
  <verify>
Run TypeScript type-check: pnpm type-check
Verify import is correct and logging is placed after album.create.
  </verify>
  <done>
handleMusicBrainzSyncNewReleases imports createLlamaLogger and calls logger.logEnrichment after album creation with category: CREATED, isRootJob: false, parentJobId populated.
  </done>
</task>

</tasks>

<verification>
After task completion:
1. pnpm type-check passes
2. pnpm lint shows no new errors in either file
3. Both files contain LlamaLogger import and logEnrichment calls with 'album:created:*-sync' operations
</verification>

<success_criteria>
- TypeScript compiles without errors
- Both sync functions contain LlamaLogger imports and logEnrichment calls
- Spotify sync uses operation: 'album:created:spotify-sync'
- MusicBrainz sync uses operation: 'album:created:musicbrainz-sync'
- Both use category: 'CREATED', isRootJob: false, and include parentJobId
- Logging wrapped in try-catch to prevent failures from breaking sync operations
</success_criteria>

<output>
After completion, create .planning/phases/28-album-creation-tracking/28-02-SUMMARY.md
</output>
