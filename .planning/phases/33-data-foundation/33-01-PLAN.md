---
phase: 33-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "UncoverChallenge, UncoverSession, UncoverGuess, UncoverPlayerStats tables exist in database"
    - "UncoverSession links to User and UncoverChallenge via foreign keys"
    - "UncoverGuess links to UncoverSession via foreign key"
    - "UncoverPlayerStats links to User with 1:1 relationship"
    - "Prisma client includes all Uncover game types"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Uncover models (UncoverChallenge, UncoverSession, UncoverGuess, UncoverPlayerStats) and UncoverSessionStatus enum"
      contains: "model UncoverChallenge"
    - path: "prisma/migrations/*_add_uncover_game_models"
      provides: "Migration SQL for uncover tables"
  key_links:
    - from: "UncoverSession"
      to: "User"
      via: "userId relation"
      pattern: "user\\s+User\\?\\s+@relation"
    - from: "UncoverSession"
      to: "UncoverChallenge"
      via: "challengeId relation"
      pattern: "challenge\\s+UncoverChallenge\\s+@relation"
    - from: "UncoverGuess"
      to: "UncoverSession"
      via: "sessionId relation"
      pattern: "session\\s+UncoverSession\\s+@relation"
    - from: "UncoverPlayerStats"
      to: "User"
      via: "userId relation (1:1)"
      pattern: "userId\\s+String\\s+@unique"
---

<objective>
Add Prisma models for the Uncover daily album art game: UncoverChallenge, UncoverSession, UncoverGuess, and UncoverPlayerStats.

Purpose: Establish the database foundation required for tracking game state, player guesses, and statistics. This is Phase 33 of the v1.5 Daily Album Art Game milestone.

Output: Four new database tables with proper relations, indexes, and an UncoverSessionStatus enum.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-data-foundation/33-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Uncover game models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following to prisma/schema.prisma:

1. **After the SyncJob model (around line ~550), add these four models:**

```prisma
// ============================================================================
// Uncover â€” Daily Album Art Game
// ============================================================================

/// Daily challenge - one album per day for all players
model UncoverChallenge {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date          DateTime  @unique @db.Date
  albumId       String    @map("album_id") @db.Uuid
  album         Album     @relation(fields: [albumId], references: [id], onDelete: Cascade)
  
  maxAttempts   Int       @default(6) @map("max_attempts")
  totalPlays    Int       @default(0) @map("total_plays")
  totalWins     Int       @default(0) @map("total_wins")
  avgAttempts   Float?    @map("avg_attempts")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  sessions      UncoverSession[]
  
  @@index([date])
  @@index([albumId])
  @@map("uncover_challenges")
}

/// Player's session for a specific daily challenge
model UncoverSession {
  id              String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  challengeId     String                @map("challenge_id") @db.Uuid
  userId          String?               @map("user_id")
  
  status          UncoverSessionStatus  @default(IN_PROGRESS)
  attemptCount    Int                   @default(0) @map("attempt_count")
  won             Boolean               @default(false)
  completedAt     DateTime?             @map("completed_at")
  revealedHints   String[]              @default([]) @map("revealed_hints")
  
  startedAt       DateTime              @default(now()) @map("started_at")
  
  challenge       UncoverChallenge      @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user            User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  guesses         UncoverGuess[]
  
  @@unique([challengeId, userId])
  @@index([userId])
  @@index([challengeId])
  @@index([status])
  @@map("uncover_sessions")
}

/// Individual guess within a session
model UncoverGuess {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String          @map("session_id") @db.Uuid
  guessNumber     Int             @map("guess_number")
  
  guessedAlbumId  String?         @map("guessed_album_id") @db.Uuid
  guessedText     String?         @map("guessed_text")
  isCorrect       Boolean         @default(false) @map("is_correct")
  
  guessedAt       DateTime        @default(now()) @map("guessed_at")
  
  session         UncoverSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  guessedAlbum    Album?          @relation(fields: [guessedAlbumId], references: [id], onDelete: SetNull)
  
  @@unique([sessionId, guessNumber])
  @@index([sessionId])
  @@map("uncover_guesses")
}

/// Player stats aggregate (denormalized for fast lookup)
model UncoverPlayerStats {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String    @unique @map("user_id")
  
  gamesPlayed     Int       @default(0) @map("games_played")
  gamesWon        Int       @default(0) @map("games_won")
  totalAttempts   Int       @default(0) @map("total_attempts")
  
  currentStreak   Int       @default(0) @map("current_streak")
  maxStreak       Int       @default(0) @map("max_streak")
  lastPlayedDate  DateTime? @db.Date @map("last_played_date")
  
  winDistribution Int[]     @default([0,0,0,0,0,0]) @map("win_distribution")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([currentStreak(sort: Desc)])
  @@map("uncover_player_stats")
}
```

2. **At the end of the schema file (with other enums), add:**

```prisma
enum UncoverSessionStatus {
  IN_PROGRESS
  WON
  LOST
}
```

3. **Update the User model to add Uncover relations:**

Add these two lines to the User model (after existing relations like `activities`):
```prisma
  uncoverSessions    UncoverSession[]
  uncoverStats       UncoverPlayerStats?
```

4. **Update the Album model to add Uncover relations:**

Add these two lines to the Album model (after existing relations like `llamaLogs`):
```prisma
  uncoverChallenges  UncoverChallenge[]
  uncoverGuesses     UncoverGuess[]
```

**Important conventions (verified against existing schema):**
- UUID fields use: `@id @default(dbgenerated("gen_random_uuid()")) @db.Uuid`
- User ID references use `String` (NOT `@db.Uuid`) because User.id is a cuid
- Album ID references use `String @db.Uuid` because Album.id is a UUID
- Field mapping: camelCase in Prisma, snake_case via `@map()` in DB
- Table mapping: snake_case via `@@map()`
- Cascade deletes for owned relations
- SetNull for optional Album reference in UncoverGuess (guessedAlbum)
  </action>
  <verify>
Run `pnpm prisma validate` to check schema syntax is correct. Should output "The Prisma schema is valid."
  </verify>
  <done>
Schema file contains all four Uncover models (UncoverChallenge, UncoverSession, UncoverGuess, UncoverPlayerStats), UncoverSessionStatus enum, and User/Album relations. Prisma validates successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run migration and verify types</name>
  <files>prisma/migrations/*_add_uncover_game_models/migration.sql</files>
  <action>
1. Run the Prisma migration to create the tables:
```bash
pnpm prisma migrate dev --name add_uncover_game_models
```

This will:
- Generate migration SQL in `prisma/migrations/YYYYMMDDHHMMSS_add_uncover_game_models/`
- Apply the migration to the local database
- Auto-run `prisma generate` to update the Prisma client

2. Verify the migration created all expected tables by checking the migration SQL file includes:
- CREATE TABLE "uncover_challenges"
- CREATE TABLE "uncover_sessions"
- CREATE TABLE "uncover_guesses"
- CREATE TABLE "uncover_player_stats"
- CREATE TYPE "UncoverSessionStatus"

3. Verify TypeScript types compile:
```bash
pnpm type-check
```

This confirms the Prisma client types are correctly generated and the project compiles.
  </action>
  <verify>
1. `pnpm prisma migrate dev --name add_uncover_game_models` completes without errors
2. Migration file exists at prisma/migrations/*_add_uncover_game_models/migration.sql
3. `pnpm type-check` passes with no errors
  </verify>
  <done>
Migration applied successfully. Four new tables exist in database. Prisma client types generated. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Models exist:** Confirm migration SQL contains all four CREATE TABLE statements
2. **Relations correct:** Schema shows UncoverSession -> User, UncoverSession -> UncoverChallenge, UncoverGuess -> UncoverSession relations
3. **Prisma generates:** `pnpm prisma generate` succeeds (auto-ran with migrate dev)
4. **Types available:** `pnpm type-check` confirms UncoverChallenge, UncoverSession, UncoverGuess, UncoverPlayerStats types compile

Quick database verification (optional, using Supabase MCP):
```sql
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('uncover_challenges', 'uncover_sessions', 'uncover_guesses', 'uncover_player_stats');
```
Should return 4 rows.
</verification>

<success_criteria>
1. `prisma/schema.prisma` contains UncoverChallenge, UncoverSession, UncoverGuess, UncoverPlayerStats models
2. `prisma/schema.prisma` contains UncoverSessionStatus enum at end of file
3. User model has `uncoverSessions` and `uncoverStats` relations
4. Album model has `uncoverChallenges` and `uncoverGuesses` relations
5. Migration file exists at `prisma/migrations/*_add_uncover_game_models/`
6. `pnpm type-check` passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-data-foundation/33-01-SUMMARY.md`
</output>
