---
phase: 20-job-history-tab
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/admin/job-history/page.tsx
  - src/components/admin/ExpandableJobRow.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see which BullMQ jobs have enrichment activity"
    - "Admin can expand a job row to see its EnrichmentLog timeline"
    - "Timeline shows all logs linked to that job (parent + children)"
    - "Works for Spotify sync, MusicBrainz sync, and manual enrichment jobs"
  artifacts:
    - path: "src/components/admin/ExpandableJobRow.tsx"
      provides: "Expandable row with lazy-loaded EnrichmentTimeline"
      exports: ["ExpandableJobRow"]
    - path: "src/app/admin/job-history/page.tsx"
      provides: "Job History page with timeline integration"
      contains: "ExpandableJobRow"
  key_links:
    - from: "ExpandableJobRow"
      to: "useGetEnrichmentLogsQuery"
      via: "parentJobId filter"
      pattern: "useGetEnrichmentLogsQuery.*parentJobId"
    - from: "ExpandableJobRow"
      to: "EnrichmentTimeline"
      via: "compact variant in expanded area"
      pattern: "EnrichmentTimeline.*variant.*compact"
---

<objective>
Integrate EnrichmentLog timeline into Job History tab with expandable rows.

Purpose: Enable admins to see enrichment activity directly from BullMQ job history, bridging job monitoring with audit trail visibility.

Output: Job History page with expandable rows showing EnrichmentTimeline for each job's linked logs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-enrichmentlogtable-integration/19-03-SUMMARY.md
@.planning/phases/20-job-history-tab/20-RESEARCH.md

@src/app/admin/job-history/page.tsx
@src/components/admin/EnrichmentLogTable.tsx
@src/components/admin/EnrichmentTimeline.tsx
@src/components/admin/SkeletonTimeline.tsx
@src/graphql/queries/enrichment.graphql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExpandableJobRow Component</name>
  <files>src/components/admin/ExpandableJobRow.tsx</files>
  <action>
Create a new component `ExpandableJobRow` that:

1. **Props interface:**
   ```typescript
   interface ExpandableJobRowProps {
     job: JobHistoryItem;
     isExpanded: boolean;
     onToggle: () => void;
     getStatusIcon: (status: string) => React.ReactNode;
     getStatusBadgeVariant: (status: string) => string;
     formatDuration: (ms?: number) => string;
     formatDistanceToNow: (date: Date) => string;
     onRetryJob: (jobId: string) => void;
   }
   ```

2. **Lazy fetch enrichment logs** when expanded:
   - Use `useGetEnrichmentLogsQuery({ parentJobId: job.id, limit: 100 })`
   - Only enable query when `isExpanded === true`
   - Use dynamic `refetchInterval` that polls for 30s after last log activity

3. **Main row rendering:**
   - ChevronDown/ChevronRight toggle icon in first column
   - Keep existing columns: Status, Job Name, Album, Created, Duration, Attempts, Actions
   - Add enrichment count badge next to job name IF logs exist (after first fetch)
   - Row is clickable to toggle expansion

4. **Expanded content:**
   - Render as second TableRow with colSpan={8}
   - Show SkeletonTimeline while loading
   - Show EnrichmentTimeline with variant="compact" when loaded
   - Show "No enrichment logs for this job" if empty
   - Show error state with retry button if query fails

5. **Pattern to follow:** Copy from ExpandableLogRow in EnrichmentLogTable.tsx

6. **Imports needed:**
   - React, useState from react
   - ChevronDown, ChevronRight, Activity, RefreshCw, AlertCircle from lucide-react
   - useGetEnrichmentLogsQuery from @/generated/graphql
   - EnrichmentTimeline from ./EnrichmentTimeline
   - SkeletonTimeline from ./SkeletonTimeline
   - EnrichmentTimelineModal from ./EnrichmentTimelineModal
   - Badge, Button, TableRow, TableCell from UI components

Export the JobHistoryItem interface from this file so job-history page can import it.
  </action>
  <verify>
    - `pnpm type-check` passes
    - File exports ExpandableJobRow and JobHistoryItem
    - Component uses useGetEnrichmentLogsQuery with parentJobId
    - EnrichmentTimeline uses variant="compact"
  </verify>
  <done>
    - ExpandableJobRow component created with lazy-loading pattern
    - Matches Phase 19's ExpandableLogRow architecture
    - All types properly defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ExpandableJobRow into Job History Page</name>
  <files>src/app/admin/job-history/page.tsx</files>
  <action>
Update Job History page to use expandable rows:

1. **Add imports:**
   ```typescript
   import { ExpandableJobRow, type JobHistoryItem } from '@/components/admin/ExpandableJobRow';
   ```
   Remove the local JobHistoryItem interface (it's now exported from ExpandableJobRow)

2. **Add expansion state:**
   ```typescript
   const [expandedRows, setExpandedRows] = useState<Set<string>>(new Set());
   
   const toggleRow = (jobId: string) => {
     setExpandedRows(prev => {
       const next = new Set(prev);
       if (next.has(jobId)) {
         next.delete(jobId);
       } else {
         next.add(jobId);
       }
       return next;
     });
   };
   ```

3. **Update table header:**
   Add first column for expand toggle:
   ```tsx
   <TableHead className="w-8"></TableHead> // Empty header for chevron column
   ```

4. **Replace table body rows:**
   Instead of direct TableRow mapping, use ExpandableJobRow:
   ```tsx
   {jobs.filter(job => { ... }).map(job => (
     <ExpandableJobRow
       key={job.id}
       job={job}
       isExpanded={expandedRows.has(job.id)}
       onToggle={() => toggleRow(job.id)}
       getStatusIcon={getStatusIcon}
       getStatusBadgeVariant={getStatusBadgeVariant}
       formatDuration={formatDuration}
       formatDistanceToNow={formatDistanceToNow}
       onRetryJob={handleRetryJob}
     />
   ))}
   ```

5. **Update colSpan references:**
   - Error state: colSpan={8} (was 7)
   - Empty state: colSpan={8} (was 7)
   - Loading state: colSpan={8} (was 7)

6. **Remove job detail dialog:**
   Delete the `selectedJob` state and the Dialog component at the bottom.
   The timeline expansion replaces the need for the job detail modal.
   Keep JobAlbums component (still useful in expanded rows for Spotify jobs).

7. **Add JobAlbums to expanded content:**
   Update ExpandableJobRow to accept an optional `albumsComponent` prop
   OR move JobAlbums into ExpandableJobRow and pass job info.
   Simpler: Keep JobAlbums in page, pass to ExpandableJobRow as children or slot.

Actually, cleaner approach: Move JobAlbums query into ExpandableJobRow and render it
in the expanded area below the timeline for spotify jobs.
  </action>
  <verify>
    - `pnpm type-check` passes
    - `pnpm lint` passes
    - `pnpm build` succeeds
    - Page imports ExpandableJobRow
    - Table has 8 columns (including chevron)
    - Expansion state tracks via expandedRows Set
  </verify>
  <done>
    - Job History page uses ExpandableJobRow for all job rows
    - Click expands to show EnrichmentTimeline
    - Job detail dialog removed (replaced by inline expansion)
    - All 8 columns render correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Verification and Polish</name>
  <files>src/app/admin/job-history/page.tsx, src/components/admin/ExpandableJobRow.tsx</files>
  <action>
Final verification and polish:

1. **Type checking:**
   - Run `pnpm type-check` - must pass with no errors
   - Run `pnpm lint` - must pass with no warnings on modified files

2. **Build verification:**
   - Run `pnpm build` - must complete successfully

3. **Code review checklist:**
   - [ ] ExpandableJobRow uses lazy fetch pattern (enabled: isExpanded)
   - [ ] Dynamic polling configured (30s after last activity)
   - [ ] Compact timeline variant used in expanded rows
   - [ ] SkeletonTimeline shows during loading
   - [ ] Error state has retry button
   - [ ] Empty state shows "No enrichment logs" message
   - [ ] Enrichment count badge shows next to job name
   - [ ] ChevronDown/ChevronRight toggle works
   - [ ] Table columns aligned properly (8 columns)

4. **Pattern compliance:**
   - Compare with EnrichmentLogTable.tsx ExpandableLogRow
   - Ensure same lazy-loading, polling, and error handling patterns

5. **Accessibility:**
   - Rows are keyboard navigable (existing behavior)
   - Chevron icons have appropriate aria-labels if needed
  </action>
  <verify>
    - `pnpm type-check` passes
    - `pnpm lint` passes
    - `pnpm build` succeeds
    - All checklist items verified via grep/code inspection
  </verify>
  <done>
    - All verification checks pass
    - Code follows Phase 19 patterns
    - Ready for Phase 20 verification
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **JOB-01 (Timeline indicator):**
   - Grep for `Activity` icon usage in ExpandableJobRow (enrichment badge)
   - Verify badge shows count of enrichment logs

2. **JOB-02 (Expand to see timeline):**
   - Grep for `EnrichmentTimeline` in ExpandableJobRow
   - Verify `variant="compact"` is used
   - Verify `useGetEnrichmentLogsQuery` uses `parentJobId: job.id`

3. **Success criteria from ROADMAP:**
   - [ ] Job History tab shows jobs with enrichment activity indicator
   - [ ] Expanding a job row shows EnrichmentLog timeline for that jobId
   - [ ] Timeline displays all logs linked to that job (parent + children)
   - [ ] Works for Spotify sync jobs, manual enrichment, collection adds
</verification>

<success_criteria>
- JOB-01: Enrichment activity indicator (badge with count) visible on jobs with logs
- JOB-02: Expanding job row shows EnrichmentTimeline with all linked logs
- Type checking passes with no errors
- Build succeeds
- Pattern matches Phase 19 ExpandableLogRow architecture
</success_criteria>

<output>
After completion, create `.planning/phases/20-job-history-tab/20-01-SUMMARY.md` using the summary template.

Include:
- What changed (before/after)
- Key implementation patterns used
- Integration points (ExpandableJobRow -> GraphQL -> EnrichmentTimeline)
- Any deviations from plan
- Verification results for JOB-01 and JOB-02
</output>
