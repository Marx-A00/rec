---
phase: 16-job-linking
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - src/lib/queue/processors/enrichment-processor.ts
autonomous: true

must_haves:
  truths:
    - "handleEnrichAlbum accepts Job object and accesses job.id"
    - "handleEnrichArtist accepts Job object and accesses job.id"
    - "ENRICH_ALBUM passes rootJobId when spawning artist enrichment"
    - "ENRICH_ARTIST passes rootJobId when spawning discogs/cache jobs"
    - "SPOTIFY_TRACK_FALLBACK logs include parentJobId"
  artifacts:
    - path: "src/lib/queue/processors/enrichment-processor.ts"
      provides: "Updated handler signatures and parent ID propagation"
      contains: "job: Job<EnrichAlbumJobData>"
  key_links:
    - from: "handleEnrichAlbum"
      to: "queue.addJob(ENRICH_ARTIST)"
      via: "parentJobId in job data"
      pattern: "parentJobId: rootJobId"
    - from: "handleEnrichArtist"
      to: "queue.addJob(DISCOGS_SEARCH_ARTIST)"
      via: "parentJobId in job data"
      pattern: "parentJobId: rootJobId"
---

<objective>
Update enrichment processor handlers to accept Job objects, propagate parentJobId through job chains, and add isRootJob to log entries.

Purpose: ENRICH_ALBUM and ENRICH_ARTIST are the primary job chain originators that spawn child jobs. This plan implements the flat parent structure where all children point to the root job.
Output: Enrichment handlers propagate parentJobId to child jobs and log with isRootJob flag.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-job-linking/16-02-SUMMARY.md
@.planning/phases/16-job-linking/16-RESEARCH.md

@src/lib/queue/processors/enrichment-processor.ts
@src/lib/queue/jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update handleEnrichAlbum signature and add parent ID propagation</name>
  <files>src/lib/queue/processors/enrichment-processor.ts</files>
  <action>
1. Import Job type at top of file:
   import { Job } from 'bullmq';

2. Change handleEnrichAlbum signature from:
   export async function handleEnrichAlbum(data: EnrichAlbumJobData)
   to:
   export async function handleEnrichAlbum(job: Job<EnrichAlbumJobData>)

3. Extract data and compute rootJobId at start of function:
   const data = job.data;
   const rootJobId = data.parentJobId || job.id;

4. Update the ENRICH_ARTIST job spawn (in the artist enrichment loop) to include parentJobId:
   await queue.addJob(
     JOB_TYPES.ENRICH_ARTIST,
     {
       artistId: albumArtist.artist.id,
       priority: data.priority || 'medium',
       userAction: data.userAction,
       requestId: ...,
       parentJobId: rootJobId,  // ADD THIS
     },
     ...
   );

5. Update all enrichmentLogger.logEnrichment calls to include:
   jobId: job.id,
   parentJobId: data.parentJobId || null,
   isRootJob: !data.parentJobId,

6. Update the SPOTIFY_TRACK_FALLBACK logging (inline operation) to include:
   jobId: job.id,
   parentJobId: data.parentJobId || null,
   isRootJob: false,  // Always child of album enrichment

7. Also update CHECK_ALBUM_ENRICHMENT spawned jobs (if any) similarly.
  </action>
  <verify>
1. handleEnrichAlbum signature accepts Job<EnrichAlbumJobData>
2. ENRICH_ARTIST jobs spawned include parentJobId: rootJobId
3. All log entries include jobId, parentJobId, isRootJob
  </verify>
  <done>handleEnrichAlbum propagates rootJobId to artist enrichment and logs with isRootJob</done>
</task>

<task type="auto">
  <name>Task 2: Update handleEnrichArtist signature and add parent ID propagation</name>
  <files>src/lib/queue/processors/enrichment-processor.ts</files>
  <action>
1. Change handleEnrichArtist signature from:
   export async function handleEnrichArtist(data: EnrichArtistJobData)
   to:
   export async function handleEnrichArtist(job: Job<EnrichArtistJobData>)

2. Extract data and compute rootJobId at start of function:
   const data = job.data;
   const rootJobId = data.parentJobId || job.id;

3. Update DISCOGS_SEARCH_ARTIST job spawn to include parentJobId:
   await queue.addJob(
     JOB_TYPES.DISCOGS_SEARCH_ARTIST,
     {
       artistId: data.artistId,
       artistName: ...,
       requestId: ...,
       parentJobId: rootJobId,  // ADD THIS
     },
     ...
   );

4. Update CACHE_ARTIST_IMAGE job spawn to include parentJobId:
   await queue.addJob(
     JOB_TYPES.CACHE_ARTIST_IMAGE,
     {
       artistId: data.artistId,
       requestId: ...,
       parentJobId: rootJobId,  // ADD THIS
     },
     ...
   );

5. Update all enrichmentLogger.logEnrichment calls to include:
   jobId: job.id,
   parentJobId: data.parentJobId || null,
   isRootJob: !data.parentJobId,
  </action>
  <verify>
1. handleEnrichArtist signature accepts Job<EnrichArtistJobData>
2. DISCOGS_SEARCH_ARTIST and CACHE_ARTIST_IMAGE jobs include parentJobId
3. All log entries include jobId, parentJobId, isRootJob
  </verify>
  <done>handleEnrichArtist propagates rootJobId to discogs/cache jobs and logs with isRootJob</done>
</task>

<task type="auto">
  <name>Task 3: Update remaining enrichment handler signatures</name>
  <files>src/lib/queue/processors/enrichment-processor.ts</files>
  <action>
Update the CHECK_* and ENRICH_TRACK handlers to accept Job objects:

1. handleCheckAlbumEnrichment:
   - Change: function handleCheckAlbumEnrichment(data: CheckAlbumEnrichmentJobData)
   - To: function handleCheckAlbumEnrichment(job: Job<CheckAlbumEnrichmentJobData>)
   - Extract: const data = job.data;
   - Compute rootJobId and pass to spawned ENRICH_ALBUM and CHECK_ARTIST_ENRICHMENT jobs

2. handleCheckArtistEnrichment:
   - Change: function handleCheckArtistEnrichment(data: CheckArtistEnrichmentJobData)
   - To: function handleCheckArtistEnrichment(job: Job<CheckArtistEnrichmentJobData>)
   - Extract: const data = job.data;
   - Compute rootJobId and pass to spawned ENRICH_ARTIST job

3. handleCheckTrackEnrichment:
   - Change: function handleCheckTrackEnrichment(data: CheckTrackEnrichmentJobData)
   - To: function handleCheckTrackEnrichment(job: Job<CheckTrackEnrichmentJobData>)
   - Extract: const data = job.data;
   - Compute rootJobId and pass to spawned ENRICH_TRACK job

4. handleEnrichTrack:
   - Change: function handleEnrichTrack(data: EnrichTrackJobData)
   - To: function handleEnrichTrack(job: Job<EnrichTrackJobData>)
   - Extract: const data = job.data;
   - Add logging with jobId, parentJobId, isRootJob
  </action>
  <verify>
1. All 6 handler signatures in enrichment-processor.ts accept Job<T> parameter
2. All spawned jobs include parentJobId: rootJobId
3. pnpm type-check passes (may still have errors from other processors)
  </verify>
  <done>All enrichment handlers accept Job object and propagate parentJobId through chains</done>
</task>

</tasks>

<verification>
1. All 6 enrichment processor handlers accept Job<T> parameter
2. ENRICH_ALBUM passes parentJobId to ENRICH_ARTIST and CHECK_ARTIST_ENRICHMENT
3. ENRICH_ARTIST passes parentJobId to DISCOGS_SEARCH_ARTIST and CACHE_ARTIST_IMAGE
4. CHECK_* handlers pass parentJobId to their spawned jobs
5. All enrichmentLogger calls include jobId, parentJobId, isRootJob
6. SPOTIFY_TRACK_FALLBACK inline logging includes parentJobId
</verification>

<success_criteria>
- Requirements LINK-01 and LINK-02 satisfied (parent ID propagation)
- Requirement LINK-03 satisfied (SPOTIFY_TRACK_FALLBACK logging)
- All enrichment handlers use flat parent structure (children point to root)
- Type checking passes for enrichment-processor.ts
</success_criteria>

<output>
After completion, create .planning/phases/16-job-linking/16-03-SUMMARY.md
</output>
