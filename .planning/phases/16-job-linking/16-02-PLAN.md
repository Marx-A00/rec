---
phase: 16-job-linking
plan: 02
type: execute
wave: 2
depends_on: ['16-01']
files_modified:
  - src/lib/queue/processors/index.ts
  - src/lib/enrichment/enrichment-logger.ts
autonomous: true

must_haves:
  truths:
    - 'Processor handlers receive the full BullMQ Job object'
    - 'EnrichmentLogger accepts isRootJob parameter'
    - 'Handler functions can access job.id'
  artifacts:
    - path: 'src/lib/queue/processors/index.ts'
      provides: 'Job object passed to handlers instead of just data'
      contains: 'await handleEnrichAlbum(job)'
    - path: 'src/lib/enrichment/enrichment-logger.ts'
      provides: 'isRootJob field support in logEnrichment'
      contains: 'isRootJob'
  key_links:
    - from: 'src/lib/queue/processors/index.ts'
      to: 'src/lib/queue/processors/enrichment-processor.ts'
      via: 'Job parameter passing'
      pattern: 'handleEnrichAlbum'
    - from: 'src/lib/enrichment/enrichment-logger.ts'
      to: 'prisma.enrichmentLog.create'
      via: 'isRootJob field'
      pattern: 'isRootJob'
---

<objective>
Update processor index to pass full Job object to handlers and add isRootJob support to enrichment logger.

Purpose: Enable handlers to access job.id for parent tracking and enable logging of root job status.
Output: Processor routing passes Job objects, logger supports isRootJob field.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-job-linking/16-01-SUMMARY.md

@src/lib/queue/processors/index.ts
@src/lib/enrichment/enrichment-logger.ts
@src/lib/queue/jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isRootJob to EnrichmentLogData interface</name>
  <files>src/lib/enrichment/enrichment-logger.ts</files>
  <action>
Update the EnrichmentLogData interface to include isRootJob:

1. Add isRootJob field to the interface after parentJobId:
   - isRootJob?: boolean - Marks whether this is a root job in the chain

2. Add parentJobId field if not already present:
   - parentJobId?: string | null - Parent job ID for chain tracking

3. Update the logEnrichment method create call to include:
   - isRootJob: use provided value if present, otherwise compute as !parentJobId
   - parentJobId: use provided value or undefined

4. Update the console.log message to show root status if isRootJob is true
   </action>
   <verify>pnpm type-check passes with new interface field</verify>
   <done>EnrichmentLogData interface has isRootJob field, logEnrichment method saves it to database</done>
   </task>

<task type="auto">
  <name>Task 2: Update processor index to pass Job object to enrichment handlers</name>
  <files>src/lib/queue/processors/index.ts</files>
  <action>
Update the processMusicBrainzJob function to pass the full Job object (not just job.data) to handlers that need job.id for parent tracking.

Change these 10 handler calls to pass job instead of job.data:

1. ENRICH_ALBUM: handleEnrichAlbum(job)
2. ENRICH_ARTIST: handleEnrichArtist(job)
3. ENRICH_TRACK: handleEnrichTrack(job)
4. CACHE_ALBUM_COVER_ART: handleCacheAlbumCoverArt(job)
5. CACHE_ARTIST_IMAGE: handleCacheArtistImage(job)
6. DISCOGS_SEARCH_ARTIST: handleDiscogsSearchArtist(job)
7. DISCOGS_GET_ARTIST: handleDiscogsGetArtist(job)
8. CHECK_ALBUM_ENRICHMENT: handleCheckAlbumEnrichment(job)
9. CHECK_ARTIST_ENRICHMENT: handleCheckArtistEnrichment(job)
10. CHECK_TRACK_ENRICHMENT: handleCheckTrackEnrichment(job)

Import Job type from bullmq if not already imported.

Note: MusicBrainz lookup/search handlers remain as-is (passing job.data) since they dont participate in job chain tracking.
</action>
<verify>

1. All 10 handler calls updated to pass job instead of job.data
2. Type errors expected until handler signatures updated in next plan
   </verify>
   <done>Processor index passes full Job object to 10 enrichment/cache/discogs handlers</done>
   </task>

</tasks>

<verification>
1. EnrichmentLogData interface has isRootJob?: boolean field
2. logEnrichment method writes isRootJob to database
3. logEnrichment auto-computes isRootJob from parentJobId if not provided
4. Processor index passes Job object to 10 handlers
5. Note: Type errors expected until handler signatures updated in Plan 03
</verification>

<success_criteria>

- EnrichmentLogger supports isRootJob field in interface and database write
- Processor index passes Job object to all enrichment/cache/discogs handlers
- Code compiles (type errors for mismatched signatures expected, resolved in Plan 03)
  </success_criteria>

<output>
After completion, create .planning/phases/16-job-linking/16-02-SUMMARY.md
</output>
