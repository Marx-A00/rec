---
phase: 16-job-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/[timestamp]_add_is_root_job/migration.sql
  - src/lib/queue/jobs.ts
autonomous: true

must_haves:
  truths:
    - 'isRootJob field exists on EnrichmentLog model'
    - 'All job data interfaces include optional parentJobId field'
    - 'Prisma client is regenerated with new field'
  artifacts:
    - path: 'prisma/schema.prisma'
      provides: 'isRootJob Boolean field on EnrichmentLog'
      contains: 'isRootJob'
    - path: 'src/lib/queue/jobs.ts'
      provides: 'parentJobId field on all job data interfaces'
      contains: 'parentJobId?: string'
  key_links:
    - from: 'src/lib/queue/jobs.ts'
      to: 'src/lib/queue/processors/*'
      via: 'job data interfaces'
      pattern: 'parentJobId'
---

<objective>
Add isRootJob field to EnrichmentLog schema and add parentJobId to all job data interfaces.

Purpose: Enable identification of root jobs for timeline display and propagation of parent job IDs through job chains.
Output: Schema migration + updated job data interfaces ready for processor implementation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-job-linking/16-CONTEXT.md
@.planning/phases/16-job-linking/16-RESEARCH.md

@prisma/schema.prisma
@src/lib/queue/jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isRootJob field to EnrichmentLog schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add `isRootJob` Boolean field to the EnrichmentLog model:

1. Add field after `parentJobId`:

   ```prisma
   isRootJob          Boolean                @default(false) @map("is_root_job")
   ```

2. Add index on isRootJob for efficient root job queries:
   ```prisma
   @@index([isRootJob, createdAt])
   ```

This field enables:

- Table query: `WHERE isRootJob = true` shows only top-level entries
- Distinguishes roots from orphaned legacy logs (pre-feature logs with null parentJobId)
- Computed during logging: `isRootJob: !data.parentJobId`
  </action>
  <verify>Run `pnpm prisma validate` to verify schema syntax is correct</verify>
  <done>EnrichmentLog model has isRootJob Boolean field with default false and index</done>
  </task>

<task type="auto">
  <name>Task 2: Create migration for isRootJob field</name>
  <files>prisma/migrations/[timestamp]_add_is_root_job/migration.sql</files>
  <action>
Run Prisma migration to create the schema change:

```bash
pnpm prisma migrate dev --name add_is_root_job
```

This creates a migration file that:

1. Adds `is_root_job` column to `enrichment_logs` table (Boolean, default false)
2. Creates index on `(is_root_job, created_at)`

After migration, regenerate Prisma client:

```bash
pnpm prisma generate
```

  </action>
  <verify>
1. Migration file exists in `prisma/migrations/`
2. `pnpm prisma db push --dry-run` shows no pending changes
3. Prisma client includes `isRootJob` field
  </verify>
  <done>Migration applied successfully, Prisma client regenerated with isRootJob field</done>
</task>

<task type="auto">
  <name>Task 3: Add parentJobId to all job data interfaces</name>
  <files>src/lib/queue/jobs.ts</files>
  <action>
Add `parentJobId?: string` field to ALL job data interfaces that participate in job chains:

1. **EnrichAlbumJobData** - root job, spawns artist enrichment
2. **EnrichArtistJobData** - spawns discogs/cache jobs
3. **EnrichTrackJobData** - may spawn child jobs
4. **CacheAlbumCoverArtJobData** - child of album enrichment
5. **CacheArtistImageJobData** - child of artist/discogs enrichment
6. **DiscogsSearchArtistJobData** - child of artist enrichment
7. **DiscogsGetArtistJobData** - child of discogs search
8. **CheckAlbumEnrichmentJobData** - spawns enrichment jobs
9. **CheckArtistEnrichmentJobData** - spawns enrichment jobs
10. **CheckTrackEnrichmentJobData** - spawns enrichment jobs

For each interface, add:

```typescript
/** Parent job ID for job chain tracking (root job ID in flat structure) */
parentJobId?: string;
```

Place the field after `requestId` for consistency.

Do NOT add to:

- MusicBrainz lookup/search jobs (pure API calls, no chain tracking needed)
- Sync jobs (SpotifySyncNewReleasesJobData, etc.) - these are root jobs themselves
  </action>
  <verify>

1. TypeScript compiles without errors: `pnpm type-check`
2. Each listed interface has `parentJobId?: string` field
   </verify>
   <done>All 10 job data interfaces have parentJobId field with JSDoc comment</done>
   </task>

</tasks>

<verification>
1. `pnpm prisma validate` passes
2. `pnpm type-check` passes
3. Migration file created with correct schema
4. Prisma client has isRootJob field on EnrichmentLog type
5. job.ts interfaces all have parentJobId field
</verification>

<success_criteria>

- EnrichmentLog.isRootJob Boolean field exists with default false
- Index on (isRootJob, createdAt) exists for efficient root queries
- All 10 job data interfaces have parentJobId?: string field
- Prisma client regenerated and type-checks pass
  </success_criteria>

<output>
After completion, create `.planning/phases/16-job-linking/16-01-SUMMARY.md`
</output>
