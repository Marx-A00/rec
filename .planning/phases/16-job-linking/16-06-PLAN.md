---
phase: 16-job-linking
plan: 06
type: execute
wave: 4
depends_on: ['16-03', '16-04', '16-05']
files_modified: []
autonomous: true

must_haves:
  truths:
    - 'Job chains are verifiable via database query'
    - 'Root jobs have isRootJob=true, children have parentJobId pointing to root'
    - 'All 7 LINK requirements are satisfied'
    - 'Type checking passes for entire codebase'
  artifacts: []
  key_links:
    - from: 'EnrichmentLog (root)'
      to: 'EnrichmentLog (children)'
      via: 'parentJobId reference'
      pattern: 'WHERE parentJobId = rootJobId'
---

<objective>
Verify complete job chain functionality and all LINK requirements.

Purpose: Ensure Phase 16 requirements are fully satisfied and job chains work end-to-end.
Output: Verification report confirming all requirements met.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-job-linking/16-03-SUMMARY.md
@.planning/phases/16-job-linking/16-04-SUMMARY.md
@.planning/phases/16-job-linking/16-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full type check and lint</name>
  <files></files>
  <action>
Run the following commands to verify all code compiles and passes quality checks:

1. Type check:
   pnpm type-check

2. Lint:
   pnpm lint

3. If any errors, fix them in the relevant files.

Common issues to watch for:

- Mismatched handler signatures (should accept Job<T>)
- Missing imports (Job, createEnrichmentLogger, JOB_TYPES)
- Incorrect property access (use data.parentJobId not job.parentJobId)
  </action>
  <verify>

1. pnpm type-check exits with 0
2. pnpm lint exits with 0 (or only warnings)
   </verify>
   <done>All code compiles without type errors</done>
   </task>

<task type="auto">
  <name>Task 2: Verify requirements coverage</name>
  <files></files>
  <action>
Check each LINK requirement is satisfied by examining the code:

LINK-01: ENRICH_ALBUM passes its jobId as parentJobId to child jobs

- File: src/lib/queue/processors/enrichment-processor.ts
- Check: handleEnrichAlbum spawns ENRICH_ARTIST with parentJobId: rootJobId

LINK-02: ENRICH_ARTIST passes its jobId as parentJobId to child jobs

- File: src/lib/queue/processors/enrichment-processor.ts
- Check: handleEnrichArtist spawns DISCOGS_SEARCH_ARTIST with parentJobId: rootJobId
- Check: handleEnrichArtist spawns CACHE_ARTIST_IMAGE with parentJobId: rootJobId

LINK-03: SPOTIFY_TRACK_FALLBACK logs with parents jobId as parentJobId

- File: src/lib/queue/processors/enrichment-processor.ts
- Check: SPOTIFY_TRACK_FALLBACK inline logging includes parentJobId

LINK-04: DISCOGS_SEARCH_ARTIST logs to EnrichmentLog with parentJobId

- File: src/lib/queue/processors/discogs-processor.ts
- Check: handleDiscogsSearchArtist calls enrichmentLogger.logEnrichment with parentJobId

LINK-05: DISCOGS_GET_ARTIST logs to EnrichmentLog with parentJobId

- File: src/lib/queue/processors/discogs-processor.ts
- Check: handleDiscogsGetArtist calls enrichmentLogger.logEnrichment with parentJobId

LINK-06: CACHE_ARTIST_IMAGE logs to EnrichmentLog with parentJobId

- File: src/lib/queue/processors/cache-processor.ts
- Check: handleCacheArtistImage calls enrichmentLogger.logEnrichment with parentJobId

LINK-07: CACHE_ALBUM_COVER_ART logs to EnrichmentLog with parentJobId

- File: src/lib/queue/processors/cache-processor.ts
- Check: handleCacheAlbumCoverArt calls enrichmentLogger.logEnrichment with parentJobId

Use grep to verify each requirement:
grep -n "parentJobId: rootJobId" src/lib/queue/processors/_.ts
grep -n "parentJobId:" src/lib/queue/processors/_.ts
grep -n "isRootJob:" src/lib/queue/processors/\*.ts
</action>
<verify>
All 7 LINK requirements have corresponding code implementation
</verify>
<done>All LINK requirements verified in codebase</done>
</task>

<task type="auto">
  <name>Task 3: Document job chain query patterns</name>
  <files></files>
  <action>
Create a brief verification note showing how to query job chains:

1. Find all root jobs (for timeline table):
   SELECT \* FROM enrichment_logs WHERE is_root_job = true ORDER BY created_at DESC;

2. Find all children of a specific job:
   SELECT \* FROM enrichment_logs WHERE parent_job_id = 'root-job-id' ORDER BY created_at ASC;

3. Find entire job family (root + children):
   SELECT \* FROM enrichment_logs
   WHERE job_id = 'root-job-id' OR parent_job_id = 'root-job-id'
   ORDER BY created_at ASC;

4. Verify flat structure (no deep nesting):
   All children should have parent_job_id pointing directly to the root job.
   SELECT COUNT(\*) FROM enrichment_logs el1
   JOIN enrichment_logs el2 ON el1.parent_job_id = el2.job_id
   WHERE el2.parent_job_id IS NOT NULL;
   -- Should be 0 (no children of children)

Log output confirming verification is complete.
</action>
<verify>Query patterns documented and structure verified</verify>
<done>Job chain query patterns documented, flat structure confirmed</done>
</task>

</tasks>

<verification>
1. pnpm type-check passes with exit code 0
2. pnpm lint passes (warnings acceptable)
3. All 7 LINK requirements verified in code
4. Job chain query patterns documented
</verification>

<success_criteria>

- All code compiles without type errors
- All 7 LINK requirements satisfied
- Flat parent structure implemented (children point to root)
- Ready for Phase 17 (GraphQL layer)
  </success_criteria>

<output>
After completion, create .planning/phases/16-job-linking/16-06-SUMMARY.md
</output>
