---
phase: 37-game-state-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/useUncoverGameStore.ts
  - src/lib/uncover/game-validation.ts
autonomous: true

must_haves:
  truths:
    - "Game state store exists with session, guesses, and UI slices"
    - "Validation rules exist for all game constraints"
  artifacts:
    - path: "src/stores/useUncoverGameStore.ts"
      provides: "Zustand game state management"
      exports: ["useUncoverGameStore"]
    - path: "src/lib/uncover/game-validation.ts"
      provides: "Server-side validation rules"
      exports: ["validateGuess", "validateSkip", "validateSessionStart"]
  key_links:
    - from: "src/stores/useUncoverGameStore.ts"
      to: "zustand/middleware"
      via: "persist middleware"
      pattern: "persist.*createJSONStorage"
---

<objective>
Create Zustand game state store and server-side validation utilities.

Purpose: Foundation for game logic - client state management and server validation rules that will be used by GraphQL mutations.
Output: Zustand store with slices pattern (session, guesses, UI) and validation functions for game rules.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing Zustand pattern (reference)
@src/stores/useRevealStore.ts

# Research findings
@.planning/phases/37-game-state-logic/37-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand game store with slices pattern</name>
  <files>src/stores/useUncoverGameStore.ts</files>
  <action>
Create the Zustand store using slices pattern with persist middleware. Follow the existing pattern in useRevealStore.ts.

**Three slices:**

1. **SessionSlice** - Core session state:
   - sessionId: string | null
   - challengeId: string | null
   - status: 'IN_PROGRESS' | 'WON' | 'LOST'
   - attemptCount: number (0-6)
   - won: boolean
   - Actions: setSession, updateAttemptCount, endSession, resetSession

2. **GuessesSlice** - Guess history:
   - guesses: Array of { guessNumber, albumId (null if skip), albumTitle, artistName, isCorrect }
   - Actions: addGuess, setGuesses, clearGuesses

3. **UISlice** - Ephemeral UI state (NOT persisted):
   - isSubmitting: boolean (prevents double-submit)
   - error: string | null
   - Actions: setSubmitting, setError, clearError

**Persist configuration:**
- name: 'uncover-game-state'
- storage: createJSONStorage(() => localStorage)
- partialize: Only persist session and guesses slices, NOT UI slice

**Types:**
- Export SessionStatus type ('IN_PROGRESS' | 'WON' | 'LOST')
- Export Guess interface with guessNumber, albumId, albumTitle, artistName, isCorrect
- Export UncoverGameStore type (union of all slices)
  </action>
  <verify>
- `pnpm type-check` passes
- Store can be imported: `import { useUncoverGameStore } from '@/stores/useUncoverGameStore'`
  </verify>
  <done>
Zustand store exists with three slices, persist middleware configured, types exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create server-side validation utilities</name>
  <files>src/lib/uncover/game-validation.ts</files>
  <action>
Create validation functions for game rules. These will be used by GraphQL mutation resolvers.

**Create these validation functions:**

1. **validateSessionStart(user, challengeId, existingSession)**
   - AUTH-01: user must be authenticated (throw if null)
   - Check if session already exists for this user+challenge
   - Return: { canStart: boolean, existingSession?: UncoverSession }

2. **validateGuess(session, albumId, guesses)**
   - Validate session status is IN_PROGRESS (DAILY-03)
   - Validate attemptCount < maxAttempts (GAME-02, GAME-06)
   - GAME-10: Check albumId not in previous guesses (no duplicate guesses)
   - Return: { valid: boolean, error?: string }

3. **validateSkip(session)**
   - Validate session status is IN_PROGRESS
   - Validate attemptCount < maxAttempts
   - Return: { valid: boolean, error?: string }

4. **calculateGameResult(session, isCorrect, newAttemptCount, maxAttempts)**
   - GAME-05: If isCorrect, return 'WON'
   - GAME-06: If newAttemptCount >= maxAttempts, return 'LOST'
   - Otherwise return 'IN_PROGRESS'
   - Return: { status: UncoverSessionStatus, gameOver: boolean }

**Error messages should be user-friendly:**
- "Authentication required to play"
- "This game has already been completed"
- "You have already guessed this album"
- "Maximum attempts exceeded"
  </action>
  <verify>
- `pnpm type-check` passes
- Functions importable: `import { validateGuess, validateSkip } from '@/lib/uncover/game-validation'`
  </verify>
  <done>
Validation utilities exist covering AUTH-01, GAME-02, GAME-05, GAME-06, GAME-10, DAILY-03
  </done>
</task>

</tasks>

<verification>
- `pnpm type-check` passes with no errors
- `pnpm lint` passes
- Store file exports useUncoverGameStore hook
- Validation file exports all validation functions
</verification>

<success_criteria>
1. Zustand store exists with session/guesses/UI slices
2. Persist middleware configured for session and guesses only
3. Validation functions cover all game rules
4. All types properly exported
</success_criteria>

<output>
After completion, create `.planning/phases/37-game-state-logic/37-01-SUMMARY.md`
</output>
