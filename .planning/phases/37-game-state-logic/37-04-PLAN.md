---
phase: 37-game-state-logic
plan: 04
type: execute
wave: 3
depends_on: [37-01, 37-02, 37-03]
files_modified:
  - src/components/uncover/UncoverGame.tsx
  - src/hooks/useUncoverGame.ts
autonomous: true

must_haves:
  truths:
    - "Game container coordinates store, mutations, and reveal engine"
    - "Session state syncs between server and Zustand store"
    - "Page refresh restores exact game state"
    - "Completed game shows results instead of game board"
  artifacts:
    - path: "src/components/uncover/UncoverGame.tsx"
      provides: "Main game container component"
      exports: ["UncoverGame"]
    - path: "src/hooks/useUncoverGame.ts"
      provides: "Game logic hook coordinating mutations and store"
      exports: ["useUncoverGame"]
  key_links:
    - from: "src/components/uncover/UncoverGame.tsx"
      to: "src/hooks/useUncoverGame.ts"
      via: "hook usage"
      pattern: "useUncoverGame"
    - from: "src/hooks/useUncoverGame.ts"
      to: "src/stores/useUncoverGameStore.ts"
      via: "store access"
      pattern: "useUncoverGameStore"
    - from: "src/hooks/useUncoverGame.ts"
      to: "src/generated/graphql.ts"
      via: "mutation hooks"
      pattern: "useStartUncoverSessionMutation|useSubmitGuessMutation"
---

<objective>
Create game coordination layer that connects Zustand store, GraphQL mutations, and UI.

Purpose: Wire together all Phase 37 pieces - the store (Plan 01), mutations (Plans 02-03), and reveal engine (Phase 36).
Output: Working game container that handles session lifecycle, state sync, and game flow.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Zustand store from Plan 01
@src/stores/useUncoverGameStore.ts

# Generated mutations from Plan 02
@src/generated/graphql.ts

# Reveal engine from Phase 36
@src/components/uncover/RevealImage.tsx
@src/components/uncover/index.ts

# Research findings
@.planning/phases/37-game-state-logic/37-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUncoverGame coordination hook</name>
  <files>src/hooks/useUncoverGame.ts</files>
  <action>
Create a custom hook that coordinates game mutations with Zustand store updates.

**Hook responsibilities:**
1. Start session and sync result to store
2. Submit guess and update store with result
3. Skip guess and update store with result
4. Calculate reveal stage from attemptCount
5. Handle loading/error states

**Implementation:**

```typescript
'use client';

import { useCallback, useMemo } from 'react';
import { useSession } from 'next-auth/react';
import {
  useStartUncoverSessionMutation,
  useSubmitGuessMutation,
  useSkipGuessMutation,
} from '@/generated/graphql';
import { useUncoverGameStore } from '@/stores/useUncoverGameStore';

export function useUncoverGame() {
  const { data: authSession } = useSession();
  const store = useUncoverGameStore();
  
  // Mutations
  const startMutation = useStartUncoverSessionMutation();
  const submitMutation = useSubmitGuessMutation();
  const skipMutation = useSkipGuessMutation();
  
  // Calculate reveal stage from attemptCount (GAME-01, GAME-03)
  // Stage 1 = most obscured (0 attempts), Stage 6 = clear (5+ attempts or game over)
  const revealStage = useMemo(() => {
    if (store.status !== 'IN_PROGRESS') return 6; // Full reveal on game end (GAME-07)
    return Math.min(store.attemptCount + 1, 6);
  }, [store.attemptCount, store.status]);
  
  // Start session handler
  const startGame = useCallback(async () => {
    store.setSubmitting(true);
    store.clearError();
    
    try {
      const result = await startMutation.mutateAsync({});
      const session = result.startUncoverSession.session;
      
      // Sync to store
      store.setSession({
        id: session.id,
        challengeId: result.startUncoverSession.challengeId,
      });
      store.updateAttemptCount(session.attemptCount);
      
      if (session.status !== 'IN_PROGRESS') {
        store.endSession(session.won);
      }
      
      // Restore guesses if resuming
      store.clearGuesses();
      session.guesses.forEach(g => {
        store.addGuess({
          guessNumber: g.guessNumber,
          albumId: g.guessedAlbum?.id || null,
          albumTitle: g.guessedAlbum?.title || '(skipped)',
          artistName: g.guessedAlbum?.artistName || '',
          isCorrect: g.isCorrect,
        });
      });
      
      return {
        imageUrl: result.startUncoverSession.imageUrl,
        cloudflareImageId: result.startUncoverSession.cloudflareImageId,
      };
    } catch (error) {
      store.setError(error instanceof Error ? error.message : 'Failed to start game');
      throw error;
    } finally {
      store.setSubmitting(false);
    }
  }, [startMutation, store]);
  
  // Submit guess handler (GAME-05, GAME-06, GAME-10)
  const submitGuess = useCallback(async (albumId: string, albumTitle: string, artistName: string) => {
    if (!store.sessionId) {
      store.setError('No active session');
      return null;
    }
    
    store.setSubmitting(true);
    store.clearError();
    
    try {
      const result = await submitMutation.mutateAsync({
        sessionId: store.sessionId,
        albumId,
      });
      
      const { guess, session, gameOver, correctAlbum } = result.submitGuess;
      
      // Update store
      store.addGuess({
        guessNumber: guess.guessNumber,
        albumId: guess.guessedAlbum?.id || null,
        albumTitle: guess.guessedAlbum?.title || '',
        artistName: guess.guessedAlbum?.artistName || '',
        isCorrect: guess.isCorrect,
      });
      store.updateAttemptCount(session.attemptCount);
      
      if (gameOver) {
        store.endSession(session.won);
      }
      
      return { guess, gameOver, correctAlbum };
    } catch (error) {
      store.setError(error instanceof Error ? error.message : 'Failed to submit guess');
      throw error;
    } finally {
      store.setSubmitting(false);
    }
  }, [submitMutation, store]);
  
  // Skip guess handler (GAME-04)
  const skipCurrentGuess = useCallback(async () => {
    if (!store.sessionId) {
      store.setError('No active session');
      return null;
    }
    
    store.setSubmitting(true);
    store.clearError();
    
    try {
      const result = await skipMutation.mutateAsync({
        sessionId: store.sessionId,
      });
      
      const { guess, session, gameOver, correctAlbum } = result.skipGuess;
      
      // Update store
      store.addGuess({
        guessNumber: guess.guessNumber,
        albumId: null,
        albumTitle: '(skipped)',
        artistName: '',
        isCorrect: false,
      });
      store.updateAttemptCount(session.attemptCount);
      
      if (gameOver) {
        store.endSession(session.won);
      }
      
      return { guess, gameOver, correctAlbum };
    } catch (error) {
      store.setError(error instanceof Error ? error.message : 'Failed to skip guess');
      throw error;
    } finally {
      store.setSubmitting(false);
    }
  }, [skipMutation, store]);
  
  return {
    // Auth state
    isAuthenticated: !!authSession?.user,
    
    // Game state (from store)
    sessionId: store.sessionId,
    status: store.status,
    attemptCount: store.attemptCount,
    guesses: store.guesses,
    won: store.won,
    
    // UI state
    isSubmitting: store.isSubmitting,
    error: store.error,
    
    // Computed
    revealStage,
    isGameOver: store.status !== 'IN_PROGRESS',
    attemptsRemaining: 6 - store.attemptCount,
    
    // Actions
    startGame,
    submitGuess,
    skipGuess: skipCurrentGuess,
    clearError: store.clearError,
    resetGame: store.resetSession,
  };
}
```
  </action>
  <verify>
- `pnpm type-check` passes
- Hook exports useUncoverGame
  </verify>
  <done>
useUncoverGame hook coordinates mutations, store updates, and exposes game state/actions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UncoverGame container component</name>
  <files>src/components/uncover/UncoverGame.tsx</files>
  <action>
Create the main game container component that handles game lifecycle and routing between states.

**Component responsibilities:**
1. Show login prompt for unauthenticated users (AUTH-01)
2. Auto-start session on mount for authenticated users
3. Show loading state while starting
4. Render game board for IN_PROGRESS sessions
5. Render results for completed sessions (DAILY-03)
6. Display error messages

**Implementation:**

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { useUncoverGame } from '@/hooks/useUncoverGame';
import { useRevealStore, RevealImage } from '@/components/uncover';
import { Button } from '@/components/ui/Button';

// Placeholder components - will be replaced in Phase 38
function LoginPrompt() {
  return (
    <div className="text-center py-12">
      <h2 className="text-2xl font-bold mb-4">Login Required</h2>
      <p className="text-gray-600 mb-6">
        Please sign in to play the daily Uncover challenge.
      </p>
      <Button href="/auth/login">Sign In</Button>
    </div>
  );
}

function LoadingState() {
  return (
    <div className="text-center py-12">
      <div className="animate-pulse">
        <div className="w-64 h-64 mx-auto bg-gray-200 rounded-lg mb-4" />
        <p className="text-gray-500">Loading today&apos;s challenge...</p>
      </div>
    </div>
  );
}

function GameResults({ won, attemptCount, guesses }: {
  won: boolean;
  attemptCount: number;
  guesses: Array<{ albumTitle: string; isCorrect: boolean }>;
}) {
  return (
    <div className="text-center py-8">
      <h2 className="text-3xl font-bold mb-4">
        {won ? 'ðŸŽ‰ You got it!' : 'ðŸ˜” Better luck tomorrow!'}
      </h2>
      <p className="text-gray-600 mb-6">
        {won 
          ? `You guessed it in ${attemptCount} ${attemptCount === 1 ? 'try' : 'tries'}!`
          : 'The album was revealed after 6 attempts.'}
      </p>
      <div className="text-sm text-gray-500">
        <p>Come back tomorrow for a new challenge!</p>
      </div>
    </div>
  );
}

export function UncoverGame() {
  const { status: authStatus } = useSession();
  const game = useUncoverGame();
  const revealStore = useRevealStore();
  
  // Image URL from session start
  const [imageData, setImageData] = useState<{
    imageUrl: string;
    cloudflareImageId: string | null;
  } | null>(null);
  
  // Auto-start session for authenticated users
  useEffect(() => {
    if (authStatus === 'authenticated' && !game.sessionId && !game.isSubmitting) {
      game.startGame()
        .then(data => {
          if (data) {
            setImageData({
              imageUrl: data.imageUrl || '',
              cloudflareImageId: data.cloudflareImageId || null,
            });
          }
        })
        .catch(err => {
          console.error('Failed to start game:', err);
        });
    }
  }, [authStatus, game.sessionId]);
  
  // AUTH-01: Show login for unauthenticated users
  if (authStatus === 'unauthenticated') {
    return <LoginPrompt />;
  }
  
  // Loading state
  if (authStatus === 'loading' || (game.isSubmitting && !game.sessionId)) {
    return <LoadingState />;
  }
  
  // Error state
  if (game.error && !game.sessionId) {
    return (
      <div className="text-center py-12">
        <p className="text-red-600 mb-4">{game.error}</p>
        <Button onClick={() => game.startGame()}>Try Again</Button>
      </div>
    );
  }
  
  // Game over - show results (DAILY-03: cannot replay)
  if (game.isGameOver) {
    return (
      <div>
        {imageData && (
          <div className="mb-6">
            <RevealImage
              imageUrl={imageData.imageUrl}
              cloudflareImageId={imageData.cloudflareImageId}
              stage={6} // Full reveal (GAME-07)
              style={revealStore.preferredStyle}
              showToggle={false}
            />
          </div>
        )}
        <GameResults
          won={game.won}
          attemptCount={game.attemptCount}
          guesses={game.guesses}
        />
      </div>
    );
  }
  
  // Active game - show game board
  // Note: Full game UI (search, guess list) is in Phase 38
  // This is the minimal skeleton to verify game logic works
  return (
    <div>
      {/* Reveal image at current stage */}
      {imageData && (
        <div className="mb-6">
          <RevealImage
            imageUrl={imageData.imageUrl}
            cloudflareImageId={imageData.cloudflareImageId}
            stage={game.revealStage}
            style={revealStore.preferredStyle}
          />
        </div>
      )}
      
      {/* Attempt counter */}
      <div className="text-center mb-4">
        <p className="text-gray-600">
          Attempt {game.attemptCount + 1} of 6 ({game.attemptsRemaining} remaining)
        </p>
      </div>
      
      {/* Previous guesses */}
      {game.guesses.length > 0 && (
        <div className="mb-4">
          <h3 className="font-semibold mb-2">Previous Guesses:</h3>
          <ul className="space-y-1">
            {game.guesses.map((g, i) => (
              <li key={i} className={g.isCorrect ? 'text-green-600' : 'text-red-600'}>
                {g.guessNumber}. {g.albumTitle} {g.artistName && `- ${g.artistName}`}
              </li>
            ))}
          </ul>
        </div>
      )}
      
      {/* Skip button (GAME-04) */}
      <div className="flex justify-center gap-4">
        <Button
          variant="outline"
          onClick={() => game.skipGuess()}
          disabled={game.isSubmitting}
        >
          Skip
        </Button>
      </div>
      
      {/* Error display */}
      {game.error && (
        <p className="text-red-600 text-center mt-4">{game.error}</p>
      )}
      
      {/* Note: Album search input will be added in Phase 38 */}
      <p className="text-center text-gray-500 mt-6 text-sm">
        Album search coming in Phase 38
      </p>
    </div>
  );
}
```
  </action>
  <verify>
- `pnpm type-check` passes
- Component renders without errors
  </verify>
  <done>
UncoverGame component handles auth gate, session lifecycle, and game state rendering
  </done>
</task>

<task type="auto">
  <name>Task 3: Export UncoverGame from barrel</name>
  <files>src/components/uncover/index.ts</files>
  <action>
Update the barrel export file to include UncoverGame component.

Add to the existing exports:
```typescript
export { UncoverGame } from './UncoverGame';
```
  </action>
  <verify>
- File exports UncoverGame
- `pnpm type-check` passes
  </verify>
  <done>
UncoverGame exported from barrel file
  </done>
</task>

</tasks>

<verification>
- `pnpm type-check` passes
- `pnpm lint` passes
- UncoverGame component can be imported from '@/components/uncover'
- useUncoverGame hook can be imported from '@/hooks/useUncoverGame'
</verification>

<success_criteria>
1. useUncoverGame hook coordinates mutations and store
2. UncoverGame shows login prompt for unauthenticated users (AUTH-01)
3. Game auto-starts session for authenticated users
4. Completed games show results, not game board (DAILY-03)
5. Skip button works (GAME-04)
6. Reveal stage advances with attempts (GAME-03)
7. Full reveal on game end (GAME-07)
</success_criteria>

<output>
After completion, create `.planning/phases/37-game-state-logic/37-04-SUMMARY.md`
</output>
