---
phase: 37-game-state-logic
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graphql/schema.graphql
  - src/graphql/queries/uncoverGame.graphql
autonomous: true

must_haves:
  truths:
    - "GraphQL schema has game mutation types"
    - "Client operations file exists for game mutations"
  artifacts:
    - path: "src/graphql/schema.graphql"
      provides: "Game mutation schema types"
      contains: "startUncoverSession"
    - path: "src/graphql/queries/uncoverGame.graphql"
      provides: "Client-side game operations"
      contains: "mutation StartUncoverSession"
  key_links:
    - from: "src/graphql/queries/uncoverGame.graphql"
      to: "src/graphql/schema.graphql"
      via: "GraphQL operations"
      pattern: "mutation.*submitGuess"
---

<objective>
Define GraphQL schema types and client operations for game mutations.

Purpose: Schema and client operations that will be consumed by resolvers (Plan 03) and generate React Query hooks.
Output: Extended GraphQL schema with game mutations and client .graphql file with operations.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Existing schema (reference for patterns)
@src/graphql/schema.graphql

# Existing operations pattern
@src/graphql/queries/dailyChallenge.graphql

# Research findings
@.planning/phases/37-game-state-logic/37-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add game mutation types to GraphQL schema</name>
  <files>src/graphql/schema.graphql</files>
  <action>
Add new types and mutations to the schema. Add these AFTER the existing Daily Challenge types section.

**New Types to add:**

```graphql
"""
Album info for guess display (minimal, safe to expose)
"""
type UncoverGuessAlbumInfo {
  id: UUID!
  title: String!
  cloudflareImageId: String
  artistName: String!
}

"""
Individual guess within a session
"""
type UncoverGuessInfo {
  id: UUID!
  guessNumber: Int!
  guessedAlbum: UncoverGuessAlbumInfo
  isSkipped: Boolean!
  isCorrect: Boolean!
  guessedAt: DateTime!
}

"""
Result of starting a new session
"""
type StartSessionResult {
  session: UncoverSessionInfo!
  challengeId: UUID!
  imageUrl: String!
  cloudflareImageId: String
}

"""
Result of submitting a guess or skipping
"""
type GuessResult {
  guess: UncoverGuessInfo!
  session: UncoverSessionInfo!
  gameOver: Boolean!
  """
  Only populated when gameOver is true - the correct answer
  """
  correctAlbum: UncoverGuessAlbumInfo
}
```

**Update UncoverSessionInfo type to include guesses:**

Find the existing UncoverSessionInfo type and add a guesses field:
```graphql
type UncoverSessionInfo {
  id: UUID!
  status: UncoverSessionStatus!
  attemptCount: Int!
  won: Boolean!
  startedAt: DateTime!
  completedAt: DateTime
  guesses: [UncoverGuessInfo!]!
}
```

**Add Mutations (inside the Mutation type block):**

```graphql
  # Uncover Game mutations
  """
  Start a new session for today's challenge (requires auth).
  Returns existing session if already started.
  """
  startUncoverSession: StartSessionResult!
  
  """
  Submit a guess for the current session (requires auth).
  """
  submitGuess(sessionId: UUID!, albumId: UUID!): GuessResult!
  
  """
  Skip current guess - counts as wrong guess (requires auth).
  """
  skipGuess(sessionId: UUID!): GuessResult!
```
  </action>
  <verify>
- File saves without syntax errors
- Types are properly nested in schema
  </verify>
  <done>
GraphQL schema extended with UncoverGuessInfo, UncoverGuessAlbumInfo, StartSessionResult, GuessResult types and three mutations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client-side GraphQL operations</name>
  <files>src/graphql/queries/uncoverGame.graphql</files>
  <action>
Create a new file with client-side operations for game mutations. These will generate React Query hooks via codegen.

**Create the file with these operations:**

```graphql
# Uncover Game Operations
# Client-side queries and mutations for the daily album guessing game

# ============================================
# FRAGMENTS
# ============================================

fragment UncoverGuessAlbumFields on UncoverGuessAlbumInfo {
  id
  title
  cloudflareImageId
  artistName
}

fragment UncoverGuessFields on UncoverGuessInfo {
  id
  guessNumber
  guessedAlbum {
    ...UncoverGuessAlbumFields
  }
  isSkipped
  isCorrect
  guessedAt
}

fragment UncoverSessionFields on UncoverSessionInfo {
  id
  status
  attemptCount
  won
  startedAt
  completedAt
  guesses {
    ...UncoverGuessFields
  }
}

# ============================================
# MUTATIONS
# ============================================

mutation StartUncoverSession {
  startUncoverSession {
    session {
      ...UncoverSessionFields
    }
    challengeId
    imageUrl
    cloudflareImageId
  }
}

mutation SubmitGuess($sessionId: UUID!, $albumId: UUID!) {
  submitGuess(sessionId: $sessionId, albumId: $albumId) {
    guess {
      ...UncoverGuessFields
    }
    session {
      ...UncoverSessionFields
    }
    gameOver
    correctAlbum {
      ...UncoverGuessAlbumFields
    }
  }
}

mutation SkipGuess($sessionId: UUID!) {
  skipGuess(sessionId: $sessionId) {
    guess {
      ...UncoverGuessFields
    }
    session {
      ...UncoverSessionFields
    }
    gameOver
    correctAlbum {
      ...UncoverGuessAlbumFields
    }
  }
}
```
  </action>
  <verify>
- File exists at src/graphql/queries/uncoverGame.graphql
- GraphQL syntax is valid
  </verify>
  <done>
Client operations file created with fragments and 3 mutations (startUncoverSession, submitGuess, skipGuess)
  </done>
</task>

<task type="auto">
  <name>Task 3: Run GraphQL codegen</name>
  <files>src/generated/graphql.ts</files>
  <action>
Run codegen to generate TypeScript types and React Query hooks from the new schema and operations.

```bash
pnpm codegen
```

Verify the generated file includes:
- useStartUncoverSessionMutation
- useSubmitGuessMutation
- useSkipGuessMutation
- UncoverGuessInfo type
- GuessResult type
  </action>
  <verify>
- `pnpm codegen` completes without errors
- Generated file contains new hooks and types
  </verify>
  <done>
Codegen successful, React Query hooks generated for all three mutations
  </done>
</task>

</tasks>

<verification>
- `pnpm codegen` completes successfully
- `pnpm type-check` passes
- Generated hooks exist: useStartUncoverSessionMutation, useSubmitGuessMutation, useSkipGuessMutation
</verification>

<success_criteria>
1. GraphQL schema has all game types (UncoverGuessInfo, GuessResult, etc.)
2. Three mutations defined (startUncoverSession, submitGuess, skipGuess)
3. Client operations file exists with fragments and mutations
4. Codegen produces working React Query hooks
</success_criteria>

<output>
After completion, create `.planning/phases/37-game-state-logic/37-02-SUMMARY.md`
</output>
