---
phase: 19-enrichmentlogtable-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graphql/schema.graphql
  - src/graphql/queries/enrichment.graphql
  - src/lib/graphql/resolvers/queries.ts
  - src/generated/graphql.ts
autonomous: true

must_haves:
  truths:
    - 'enrichmentLogs query accepts parentOnly filter to return only root logs'
    - 'enrichmentLogs query accepts parentJobId filter to return children of a specific parent'
    - 'When parentOnly=true, child logs (those with parentJobId) are excluded from results'
    - 'When parentJobId is provided, only logs with that parentJobId are returned'
    - 'Default behavior (both omitted) returns all logs unchanged'
  artifacts:
    - path: 'src/graphql/schema.graphql'
      provides: 'parentOnly: Boolean and parentJobId: String parameters on enrichmentLogs query'
      contains: 'parentOnly: Boolean'
    - path: 'src/graphql/queries/enrichment.graphql'
      provides: 'GetEnrichmentLogs query passes parentOnly and parentJobId variables'
      contains: '$parentJobId'
    - path: 'src/lib/graphql/resolvers/queries.ts'
      provides: 'Resolver filters by parentJobId: null when parentOnly, or by specific parentJobId value'
      contains: 'parentJobId'
    - path: 'src/generated/graphql.ts'
      provides: 'Generated hook with parentOnly and parentJobId in variables type'
      contains: 'parentJobId'
  key_links:
    - from: 'src/graphql/queries/enrichment.graphql'
      to: 'src/graphql/schema.graphql'
      via: 'parentOnly and parentJobId parameter definitions'
      pattern: 'parentJobId.*String'
    - from: 'src/lib/graphql/resolvers/queries.ts'
      to: 'prisma.enrichmentLog.findMany'
      via: 'where clause adds parentJobId: null when parentOnly, or specific parentJobId value when provided'
      pattern: 'parentJobId'
---

<objective>
Add `parentOnly: Boolean` and `parentJobId: String` filter parameters to the `enrichmentLogs` GraphQL query. `parentOnly` lets the table fetch only root/parent logs. `parentJobId` lets expanded rows directly fetch children of a specific parent by job ID.

Purpose: The EnrichmentLogTable needs to show only parent logs as rows (TBL-01, TBL-04) and lazy-load children when a row is expanded. `parentOnly` filters root logs at the database level. `parentJobId` enables efficient direct child fetching without the heavier `includeChildren` tree approach.

Output: Updated GraphQL schema, query, resolver, and regenerated TypeScript types/hooks with `parentOnly` and `parentJobId` support.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-enrichmentlogtable-integration/19-CONTEXT.md
@.planning/phases/19-enrichmentlogtable-integration/19-RESEARCH.md
@.planning/phases/17-graphql-layer/17-02-SUMMARY.md

Key reference files:
@src/graphql/schema.graphql (search for "enrichmentLogs" query around line 2318)
@src/graphql/queries/enrichment.graphql
@src/lib/graphql/resolvers/queries.ts (search for "enrichmentLogs:" resolver around line 2013)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parentOnly parameter to GraphQL schema and query</name>
  <files>
    src/graphql/schema.graphql
    src/graphql/queries/enrichment.graphql
  </files>
  <action>
1. In `src/graphql/schema.graphql`, find the `enrichmentLogs` query definition in the Query type (around line 2318):
   ```
   enrichmentLogs(
     entityType: EnrichmentEntityType
     entityId: UUID
     status: EnrichmentLogStatus
     sources: [String!]
     skip: Int
     limit: Int
     includeChildren: Boolean
   ): [EnrichmentLog!]!
   ```
   Add TWO new parameters BEFORE `includeChildren`:
   - `parentOnly: Boolean` with comment: `# When true, returns only root logs (parentJobId is null)`
   - `parentJobId: String` with comment: `# When provided, returns only children of this parent job`

Result:

```
enrichmentLogs(
  entityType: EnrichmentEntityType
  entityId: UUID
  status: EnrichmentLogStatus
  sources: [String!]
  skip: Int
  limit: Int
  parentOnly: Boolean        # When true, returns only root logs (parentJobId is null)
  parentJobId: String        # When provided, returns only children of this parent job
  includeChildren: Boolean
): [EnrichmentLog!]!
```

2. In `src/graphql/queries/enrichment.graphql`, update the `GetEnrichmentLogs` query to include both new variables:
   - Add `$parentOnly: Boolean` and `$parentJobId: String` to the variable declarations
   - Pass `parentOnly: $parentOnly` and `parentJobId: $parentJobId` to the query arguments

   Do NOT modify the `GetEnrichmentLogsWithChildren` query - it already uses `includeChildren: true` which filters to parent-only internally.
   </action>
   <verify>
   Run `pnpm lint` on the modified files to check for syntax issues.
   Visually verify the schema has both `parentOnly: Boolean` and `parentJobId: String` in the enrichmentLogs query.
   Visually verify the enrichment.graphql query passes both $parentOnly and $parentJobId.
  </verify>
  <done>
    GraphQL schema has `parentOnly: Boolean` and `parentJobId: String` parameters on `enrichmentLogs` query.
    `GetEnrichmentLogs` query in enrichment.graphql passes both `$parentOnly`and`$parentJobId` variables.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Update resolver to filter by parentOnly and regenerate types</name>
  <files>
    src/lib/graphql/resolvers/queries.ts
    src/generated/graphql.ts
  </files>
  <action>
1. In `src/lib/graphql/resolvers/queries.ts`, find the `enrichmentLogs` resolver (around line 2013). In the flat fetch branch (the `if (!includeChildren)` block), add filtering logic:

After the existing where clause construction (entityType, entityId, status, sources filters), update the destructure to include both new params:

```typescript
// Extract parentOnly, parentJobId from args
const {
  includeChildren = false,
  parentOnly = false,
  parentJobId,
  ...filterArgs
} = args;
```

Then in the flat fetch branch, BEFORE the `findMany` call, add:

```typescript
if (parentOnly) {
  where.parentJobId = null;
} else if (parentJobId) {
  where.parentJobId = parentJobId;
}
```

This ensures:

- When `parentOnly: true` is passed, only logs with `parentJobId === null` (root/standalone logs) are returned
- When `parentJobId` is passed (a string job ID), only children of that specific parent are returned
- When neither is passed, all logs returned (default behavior unchanged)

The `includeChildren` tree fetch already filters to root logs, so no changes needed there.

2. Run `pnpm codegen` to regenerate TypeScript types and hooks. This will update `src/generated/graphql.ts` to include both `parentOnly` and `parentJobId` in `GetEnrichmentLogsQueryVariables`.

3. Run `pnpm type-check` to verify no type errors.
   </action>
   <verify>
   Run `pnpm codegen` - should complete without errors.
   Run `pnpm type-check` - should pass.
   Verify `GetEnrichmentLogsQueryVariables` in generated/graphql.ts includes both `parentOnly?: InputMaybe<Scalars['Boolean']['input']>` and `parentJobId?: InputMaybe<Scalars['String']['input']>`.
   </verify>
   <done>
   Resolver filters by `parentJobId: null` when `parentOnly: true`.
   Resolver filters by specific `parentJobId` value when `parentJobId` string is provided.
   Generated types include both `parentOnly` and `parentJobId` in query variables.
   `pnpm type-check` passes.
   </done>
   </task>

</tasks>

<verification>
1. `pnpm codegen` completes without errors
2. `pnpm type-check` passes
3. `GetEnrichmentLogsQueryVariables` includes both `parentOnly` and `parentJobId` fields
4. Resolver adds `parentJobId: null` to where clause when `parentOnly` is truthy
5. Resolver adds `parentJobId: <value>` to where clause when `parentJobId` string is provided
6. Default behavior (both omitted) returns all logs unchanged
</verification>

<success_criteria>

- GraphQL schema has `parentOnly: Boolean` and `parentJobId: String` parameters on `enrichmentLogs` query
- `GetEnrichmentLogs` client query passes both `$parentOnly` and `$parentJobId` variables
- Resolver filters to root-only logs when `parentOnly: true`
- Resolver filters to children of specific parent when `parentJobId` is provided
- Generated hooks updated with new variable types
- All type checks pass
  </success_criteria>

<output>
After completion, create `.planning/phases/19-enrichmentlogtable-integration/19-01-SUMMARY.md`
</output>
