---
phase: 19-enrichmentlogtable-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graphql/schema.graphql
  - src/graphql/queries/enrichment.graphql
  - src/lib/graphql/resolvers/queries.ts
  - src/generated/graphql.ts
autonomous: true

must_haves:
  truths:
    - "enrichmentLogs query accepts parentOnly filter to return only root logs"
    - "When parentOnly=true, child logs (those with parentJobId) are excluded from results"
    - "Default behavior (parentOnly omitted) returns all logs unchanged"
  artifacts:
    - path: "src/graphql/schema.graphql"
      provides: "parentOnly: Boolean parameter on enrichmentLogs query"
      contains: "parentOnly: Boolean"
    - path: "src/graphql/queries/enrichment.graphql"
      provides: "GetEnrichmentLogs query passes parentOnly variable"
      contains: "$parentOnly"
    - path: "src/lib/graphql/resolvers/queries.ts"
      provides: "Resolver filters by parentJobId: null when parentOnly is true"
      contains: "parentOnly"
    - path: "src/generated/graphql.ts"
      provides: "Generated hook with parentOnly in variables type"
      contains: "parentOnly"
  key_links:
    - from: "src/graphql/queries/enrichment.graphql"
      to: "src/graphql/schema.graphql"
      via: "parentOnly parameter definition"
      pattern: "parentOnly.*Boolean"
    - from: "src/lib/graphql/resolvers/queries.ts"
      to: "prisma.enrichmentLog.findMany"
      via: "where clause adds parentJobId: null when parentOnly"
      pattern: "parentJobId.*null"
---

<objective>
Add `parentOnly: Boolean` filter parameter to the `enrichmentLogs` GraphQL query so the table can fetch only root/parent logs without using the heavier `includeChildren` tree fetch.

Purpose: The EnrichmentLogTable needs to show only parent logs as rows (TBL-01, TBL-04). Currently the flat fetch returns ALL logs including children. Adding `parentOnly` allows filtering at the database level without the overhead of tree assembly.

Output: Updated GraphQL schema, query, resolver, and regenerated TypeScript types/hooks with `parentOnly` support.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-enrichmentlogtable-integration/19-CONTEXT.md
@.planning/phases/19-enrichmentlogtable-integration/19-RESEARCH.md
@.planning/phases/17-graphql-layer/17-02-SUMMARY.md

Key reference files:
@src/graphql/schema.graphql (search for "enrichmentLogs" query around line 2318)
@src/graphql/queries/enrichment.graphql
@src/lib/graphql/resolvers/queries.ts (search for "enrichmentLogs:" resolver around line 2013)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parentOnly parameter to GraphQL schema and query</name>
  <files>
    src/graphql/schema.graphql
    src/graphql/queries/enrichment.graphql
  </files>
  <action>
1. In `src/graphql/schema.graphql`, find the `enrichmentLogs` query definition in the Query type (around line 2318):
   ```
   enrichmentLogs(
     entityType: EnrichmentEntityType
     entityId: UUID
     status: EnrichmentLogStatus
     sources: [String!]
     skip: Int
     limit: Int
     includeChildren: Boolean
   ): [EnrichmentLog!]!
   ```
   Add a new parameter `parentOnly: Boolean` BEFORE `includeChildren`. Add a comment: `# When true, returns only root logs (parentJobId is null)`.

2. In `src/graphql/queries/enrichment.graphql`, update the `GetEnrichmentLogs` query to include the new variable:
   - Add `$parentOnly: Boolean` to the variable declarations
   - Pass `parentOnly: $parentOnly` to the query arguments

   Do NOT modify the `GetEnrichmentLogsWithChildren` query - it already uses `includeChildren: true` which filters to parent-only internally.
  </action>
  <verify>
    Run `pnpm lint` on the modified files to check for syntax issues.
    Visually verify the schema has `parentOnly: Boolean` in the enrichmentLogs query.
    Visually verify the enrichment.graphql query passes $parentOnly.
  </verify>
  <done>
    GraphQL schema has `parentOnly: Boolean` parameter on `enrichmentLogs` query.
    `GetEnrichmentLogs` query in enrichment.graphql passes `$parentOnly` variable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update resolver to filter by parentOnly and regenerate types</name>
  <files>
    src/lib/graphql/resolvers/queries.ts
    src/generated/graphql.ts
  </files>
  <action>
1. In `src/lib/graphql/resolvers/queries.ts`, find the `enrichmentLogs` resolver (around line 2013). In the flat fetch branch (the `if (!includeChildren)` block), add filtering logic:

   After the existing where clause construction (entityType, entityId, status, sources filters), add:
   ```typescript
   // Extract parentOnly from args
   const { includeChildren = false, parentOnly = false, ...filterArgs } = args;
   ```
   (Update the existing destructure to include `parentOnly`.)

   Then in the flat fetch branch, BEFORE the `findMany` call, add:
   ```typescript
   if (parentOnly) {
     where.parentJobId = null;
   }
   ```

   This ensures that when `parentOnly: true` is passed, only logs with `parentJobId === null` (root/standalone logs) are returned. The `includeChildren` tree fetch already filters to root logs, so no changes needed there.

2. Run `pnpm codegen` to regenerate TypeScript types and hooks. This will update `src/generated/graphql.ts` to include `parentOnly` in `GetEnrichmentLogsQueryVariables`.

3. Run `pnpm type-check` to verify no type errors.
  </action>
  <verify>
    Run `pnpm codegen` - should complete without errors.
    Run `pnpm type-check` - should pass.
    Verify `GetEnrichmentLogsQueryVariables` in generated/graphql.ts includes `parentOnly?: InputMaybe<Scalars['Boolean']['input']>`.
  </verify>
  <done>
    Resolver filters by `parentJobId: null` when `parentOnly: true`.
    Generated types include `parentOnly` in query variables.
    `pnpm type-check` passes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm codegen` completes without errors
2. `pnpm type-check` passes
3. `GetEnrichmentLogsQueryVariables` includes `parentOnly` field
4. Resolver adds `parentJobId: null` to where clause when `parentOnly` is truthy
5. Default behavior (parentOnly omitted/false) returns all logs unchanged
</verification>

<success_criteria>
- GraphQL schema has `parentOnly: Boolean` parameter on `enrichmentLogs` query
- `GetEnrichmentLogs` client query passes `$parentOnly` variable
- Resolver filters to root-only logs when `parentOnly: true`
- Generated hooks updated with new variable type
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-enrichmentlogtable-integration/19-01-SUMMARY.md`
</output>
