---
phase: 19-enrichmentlogtable-integration
plan: 03
type: execute
wave: 2
depends_on: [19-01, 19-02]
files_modified:
  - src/components/admin/EnrichmentLogTable.tsx
autonomous: true

must_haves:
  truths:
    - 'Table fetches only parent/root logs as rows (child logs hidden from main table)'
    - 'Every row has an expand chevron (all rows are expandable)'
    - 'Expanding a row lazy-loads children and shows compact timeline with parent + children'
    - 'Solo logs (no children) show as single-item timeline when expanded'
    - 'Row count displays parent count with total logs indicator'
    - 'View full timeline link opens modal with full variant'
    - 'Loading state shows skeleton timeline while children are fetching'
    - 'Error state shows message with retry option in expanded area'
  artifacts:
    - path: 'src/components/admin/EnrichmentLogTable.tsx'
      provides: 'Refactored table with timeline expansion, lazy child loading, parent-only filtering'
      contains: 'parentOnly'
  key_links:
    - from: 'src/components/admin/EnrichmentLogTable.tsx'
      to: 'useGetEnrichmentLogsQuery'
      via: 'parentOnly: true in main query variables for table rows'
      pattern: 'parentOnly.*true'
    - from: 'src/components/admin/EnrichmentLogTable.tsx'
      to: 'useGetEnrichmentLogsQuery'
      via: 'parentJobId: log.jobId in child fetch query for expanded rows'
      pattern: "parentJobId.*log\\.jobId"
    - from: 'src/components/admin/EnrichmentLogTable.tsx'
      to: 'src/components/admin/EnrichmentTimeline.tsx'
      via: 'renders compact EnrichmentTimeline in expanded rows'
      pattern: 'variant.*compact'
    - from: 'src/components/admin/EnrichmentLogTable.tsx'
      to: 'src/components/admin/SkeletonTimeline.tsx'
      via: 'renders SkeletonTimeline while children loading'
      pattern: 'SkeletonTimeline'
    - from: 'src/components/admin/EnrichmentLogTable.tsx'
      to: 'src/components/admin/EnrichmentTimelineModal.tsx'
      via: 'renders EnrichmentTimelineModal in expanded row'
      pattern: 'EnrichmentTimelineModal'
---

<objective>
Refactor EnrichmentLogTable to use parent-only filtering, lazy child loading, compact timeline in expanded rows, and full timeline modal.

Purpose: This is the main integration plan that wires together all Phase 19 components (TBL-01 through TBL-04). Admins will see only parent/root logs as table rows, with inline timeline expansion showing the full job hierarchy.

Output: Fully refactored EnrichmentLogTable.tsx with timeline integration replacing the old FieldChangesPanel expand.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-enrichmentlogtable-integration/19-CONTEXT.md
@.planning/phases/19-enrichmentlogtable-integration/19-RESEARCH.md
@.planning/phases/19-enrichmentlogtable-integration/19-01-SUMMARY.md
@.planning/phases/19-enrichmentlogtable-integration/19-02-SUMMARY.md

Key reference files:
@src/components/admin/EnrichmentLogTable.tsx (existing - will be refactored)
@src/components/admin/EnrichmentTimeline.tsx (modified in plan 02)
@src/components/admin/SkeletonTimeline.tsx (created in plan 02)
@src/components/admin/EnrichmentTimelineModal.tsx (created in plan 02)
@src/generated/graphql.ts (updated in plan 01 with parentOnly and parentJobId)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor EnrichmentLogTable main query and row expansion</name>
  <files>src/components/admin/EnrichmentLogTable.tsx</files>
  <action>
This is a significant refactor of EnrichmentLogTable.tsx. The high-level changes:
- Main query adds `parentOnly: true` to fetch only root logs
- ALL rows become expandable (not just those with field changes)
- Expanded row shows compact EnrichmentTimeline instead of FieldChangesPanel
- Children lazy-loaded via `useGetEnrichmentLogsQuery({ parentJobId: log.jobId })` when expanded
- SkeletonTimeline shown while loading
- EnrichmentTimelineModal for full view
- Row count shows "X jobs" format
- Error handling in expanded row

**Step-by-step implementation:**

1. **Add new imports:**

   ```typescript
   import { EnrichmentTimeline } from './EnrichmentTimeline';
   import { SkeletonTimeline } from './SkeletonTimeline';
   import { EnrichmentTimelineModal } from './EnrichmentTimelineModal';
   import type { EnrichmentLog } from '@/generated/graphql';
   ```

   Note: `useGetEnrichmentLogsWithChildrenQuery` is NOT needed. The child fetch uses the same `useGetEnrichmentLogsQuery` with the `parentJobId` filter added in Plan 01.

2. **Update main query to use parentOnly:**
   In the `useGetEnrichmentLogsQuery` call, add `parentOnly: true`:

   ```typescript
   const { data, isLoading, error } = useGetEnrichmentLogsQuery(
     { entityType, entityId, limit, parentOnly: true },
     { enabled: !!(entityType || entityId), refetchInterval: /* existing logic */ }
   );
   ```

3. **Extract ExpandableLogRow as a separate component** (defined inside the same file, below the main component). This component handles per-row child fetching using the `parentJobId` filter:

   ```typescript
   interface ExpandableLogRowProps {
     log: EnrichmentLog;
     isExpanded: boolean;
     onToggle: () => void;
   }

   function ExpandableLogRow({
     log,
     isExpanded,
     onToggle,
   }: ExpandableLogRowProps) {
     // Lazy fetch children directly via parentJobId filter
     const {
       data: childrenData,
       isLoading: loadingChildren,
       error: childrenError,
       refetch: refetchChildren,
     } = useGetEnrichmentLogsQuery(
       {
         parentJobId: log.jobId,
         limit: 100,
       },
       {
         enabled: isExpanded && !!log.jobId,
         refetchInterval: query => {
           if (!isExpanded) return false;
           const children = query.state.data?.enrichmentLogs || [];
           if (children.length === 0) return false;
           const lastChild = children[children.length - 1];
           const age = Date.now() - new Date(lastChild.createdAt).getTime();
           return age < 30000 ? 3000 : false;
         },
       }
     );

     const children = childrenData?.enrichmentLogs || [];
     // ... render row + expanded area
   }
   ```

   This is the direct child fetch approach: `useGetEnrichmentLogsQuery({ parentJobId: log.jobId })` queries the database for logs whose `parentJobId` matches the expanded row's `jobId`. This is efficient (single indexed query) and avoids the overhead of the tree-assembly `includeChildren` approach.

4. **Make ALL rows expandable:** Remove the `hasFieldChanges` condition. Every row gets a chevron and is clickable:

   ```typescript
   <TableRow
     className="border-zinc-800 hover:bg-zinc-800/50 cursor-pointer"
     onClick={onToggle}
   >
     <TableCell className="w-8 px-2">
       {isExpanded ? (
         <ChevronDown className="h-4 w-4 text-zinc-400" />
       ) : (
         <ChevronRight className="h-4 w-4 text-zinc-400" />
       )}
     </TableCell>
     {/* ... rest of cells unchanged ... */}
   </TableRow>
   ```

5. **Replace FieldChangesPanel with timeline in expanded area:**

   ```typescript
   {isExpanded && (
     <TableRow className="border-zinc-800 bg-zinc-900/80">
       <TableCell colSpan={10} className="p-0">
         <div className="p-4 max-h-96 overflow-y-auto">
           {loadingChildren ? (
             <SkeletonTimeline itemCount={3} />
           ) : childrenError ? (
             <div className="py-4 text-center">
               <p className="text-sm text-red-400">Failed to load child jobs</p>
               <Button
                 variant="ghost"
                 size="sm"
                 onClick={(e) => { e.stopPropagation(); refetchChildren(); }}
                 className="mt-2 text-xs"
               >
                 Retry
               </Button>
             </div>
           ) : (
             <>
               <EnrichmentTimeline
                 logs={children.length > 0 ? [log as EnrichmentLog, ...children] : [log as EnrichmentLog]}
                 variant="compact"
                 truncateChildren={5}
               />
               <EnrichmentTimelineModal
                 parentLog={log as EnrichmentLog}
                 childLogs={children}
               />
             </>
           )}
         </div>
       </TableCell>
     </TableRow>
   )}
   ```

6. **Update row count display** to show parent count:

   ```typescript
   <span className="text-xs text-zinc-500 font-normal">
     ({logs.length} {logs.length === 1 ? 'job' : 'jobs'})
   </span>
   ```

7. **Keep FieldChangesPanel and helper functions** in the file (don't delete them). They may be useful later. Or if you prefer, you can remove the `FieldChangesPanel` component and `extractFieldChanges` function since they're no longer used, but this is optional - the linter may flag unused code.

8. **Imports cleanup note:** Since we're using `useGetEnrichmentLogsQuery` for BOTH the main query and child fetches, there's no need to import `useGetEnrichmentLogsWithChildrenQuery`. The existing import of `useGetEnrichmentLogsQuery` is sufficient. Just ensure `type EnrichmentLog` is imported if not already.

**What NOT to change:**

- Keep existing table columns (Time, Operation, Sources, Status, Reason, Fields Changed, Changes, Duration, Error)
- Keep existing polling logic for the main query
- Keep EnrichmentStatusBadge and OperationIcon components unchanged
- Keep the loading state, error state, and empty state for the main table unchanged
  </action>
  <verify>
  Run `pnpm type-check` to verify no type errors.
  Run `pnpm lint src/components/admin/EnrichmentLogTable.tsx` to verify linting passes.
  Run `pnpm build` to verify the page compiles correctly.
  </verify>
  <done>
  Table main query uses `parentOnly: true` — child logs hidden from rows.
  Every row has expand chevron — clicking shows compact timeline.
  Children lazy-loaded via `useGetEnrichmentLogsQuery({ parentJobId: log.jobId })` when expanded.
  SkeletonTimeline shown during loading, error state with retry on failure.
  EnrichmentTimelineModal available for full view in each expanded row.
  Solo logs (no children) render as single-item timeline.
  All type checks and lint pass.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Verify integration and clean up</name>
  <files>src/components/admin/EnrichmentLogTable.tsx</files>
  <action>
1. Run `pnpm type-check` and fix any remaining type errors.

2. Run `pnpm lint:fix` on the modified file to auto-fix formatting.

3. Run `pnpm build` to verify the full build passes.

4. Verify the following by reading the final file:
   - `parentOnly: true` is passed in main query
   - `useGetEnrichmentLogsQuery({ parentJobId: log.jobId })` is used for child fetching (NOT `useGetEnrichmentLogsWithChildrenQuery`)
   - `EnrichmentTimeline` is rendered with `variant="compact"` and `truncateChildren={5}`
   - `SkeletonTimeline` is rendered during loading
   - `EnrichmentTimelineModal` is rendered in expanded area
   - All rows have chevron (no `hasFieldChanges` condition on chevron rendering)
   - Error handling with retry button exists in expanded area

5. If `FieldChangesPanel` and `extractFieldChanges` are no longer referenced, remove them to keep the file clean. If the linter warns about unused code, remove it.

6. Remove unused imports (ArrowRight, Edit, `useGetEnrichmentLogsWithChildrenQuery` if no longer used).
   </action>
   <verify>
   Run `pnpm type-check` - passes.
   Run `pnpm lint` - passes.
   Run `pnpm build` - passes.
   </verify>
   <done>
   EnrichmentLogTable fully refactored with no type errors, no lint warnings, and successful build.
   Child fetching uses `useGetEnrichmentLogsQuery` with `parentJobId` (not `useGetEnrichmentLogsWithChildrenQuery`).
   FieldChangesPanel removed if unused.
   Unused imports cleaned up.
   </done>
   </task>

</tasks>

<verification>
1. `pnpm type-check` passes
2. `pnpm lint` passes
3. `pnpm build` succeeds
4. Main table query includes `parentOnly: true`
5. Child fetch uses `useGetEnrichmentLogsQuery({ parentJobId: log.jobId })` (direct query, not tree fetch)
6. All rows expandable (chevron on every row)
7. Expanded rows show compact timeline or skeleton loading
8. Error state with retry exists for failed child fetches
9. EnrichmentTimelineModal renders in expanded area
10. Solo logs show as single-item timeline
11. No unused imports or dead code warnings
</verification>

<success_criteria>

- TBL-01: Table fetches only parent logs (parentOnly: true in query)
- TBL-02: All rows show expand chevron
- TBL-03: Expanded row shows compact Timeline with parent + children
- TBL-04: Child logs hidden from main table rows
- Loading state uses SkeletonTimeline
- Error state has retry button
- Full timeline modal accessible from expanded row
- Build passes without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/19-enrichmentlogtable-integration/19-03-SUMMARY.md`
</output>
