---
phase: 14-artist-correction-store
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/useArtistCorrectionStore.ts
  - src/components/admin/correction/artist/apply/ArtistApplyView.tsx
autonomous: true

must_haves:
  truths:
    - "Artist correction store provides typed state interface with search-only mode (mode field exists for future manual edit)"
    - "Store factory creates isolated instances keyed by artistId with Map cache"
    - "SessionStorage persistence saves only step, mode, searchQuery, searchOffset, selectedArtistMbid, manualEditState"
    - "Atomic action selectResult sets mbid + advances step in single set() call"
    - "Atomic action setPreviewLoaded sets previewData + applySelections + shouldEnrich in single set() call"
    - "clearArtistCorrectionStoreCache removes Map entry and sessionStorage key"
  artifacts:
    - path: "src/stores/useArtistCorrectionStore.ts"
      provides: "Zustand store factory for artist correction modal state"
      exports: ["getArtistCorrectionStore", "clearArtistCorrectionStoreCache", "ArtistCorrectionState", "ArtistCorrectionActions", "ArtistCorrectionStore", "UIArtistFieldSelections", "ManualArtistEditState", "isFirstStep", "isLastStep", "maxStep", "stepLabels", "isManualEditMode"]
    - path: "src/components/admin/correction/artist/apply/ArtistApplyView.tsx"
      provides: "Exported createDefaultArtistSelections function"
      exports: ["createDefaultArtistSelections", "UIArtistFieldSelections", "ArtistApplyView"]
  key_links:
    - from: "src/stores/useArtistCorrectionStore.ts"
      to: "src/components/admin/correction/artist/apply/ArtistApplyView.tsx"
      via: "import createDefaultArtistSelections"
      pattern: "import.*createDefaultArtistSelections.*from.*ArtistApplyView"
---

<objective>
Create the useArtistCorrectionStore Zustand store with sessionStorage persistence, atomic actions, and derived selectors. This mirrors the album correction store (src/stores/useCorrectionStore.ts) but adapted for the simpler artist domain (search-only mode in Phase 14, with mode field + ManualArtistEditState type for future expansion).

Also extract and export the `createDefaultSelections` function from ArtistApplyView so the store can import it for the atomic `setPreviewLoaded` action.

Purpose: Establish the single source of truth for artist correction modal state, replacing the manual useState + sessionStorage pattern in useArtistCorrectionModalState.ts.
Output: New store file at src/stores/useArtistCorrectionStore.ts + exported utility in ArtistApplyView.tsx.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-artist-correction-store/14-RESEARCH.md

# Direct template - the album correction store to mirror:
@src/stores/useCorrectionStore.ts

# Current hook being replaced (understand what state it manages):
@src/hooks/useArtistCorrectionModalState.ts

# Child component with createDefaultSelections function to export:
@src/components/admin/correction/artist/apply/ArtistApplyView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export createDefaultArtistSelections and UIArtistFieldSelections from ArtistApplyView</name>
  <files>src/components/admin/correction/artist/apply/ArtistApplyView.tsx</files>
  <action>
In `src/components/admin/correction/artist/apply/ArtistApplyView.tsx`:

1. **Export the `UIArtistFieldSelections` interface** — it is currently exported (verify) and will be needed by the store.

2. **Rename `createDefaultSelections` to `createDefaultArtistSelections` and export it.** The function is currently a private module-level function. Change from:
   ```typescript
   function createDefaultSelections(preview: ArtistCorrectionPreview): UIArtistFieldSelections {
   ```
   to:
   ```typescript
   export function createDefaultArtistSelections(preview: ArtistCorrectionPreview): UIArtistFieldSelections {
   ```

3. **Update the internal usage** in the `ArtistApplyView` component where `createDefaultSelections` is called (in the `useState` initializer):
   ```typescript
   const [selections, setSelections] = useState<UIArtistFieldSelections>(() =>
     createDefaultArtistSelections(preview)
   );
   ```

This matches the album pattern where `createDefaultUISelections` is exported from `src/components/admin/correction/apply/types.ts` and imported by the store.

**Why rename:** Disambiguate from the album version (`createDefaultUISelections`) and make the export name self-documenting.

Do NOT change any other logic, types, or UI rendering in this file.
  </action>
  <verify>
Run `pnpm type-check` — should pass with zero errors.
Verify the function is exported: `grep -n "export function createDefaultArtistSelections" src/components/admin/correction/artist/apply/ArtistApplyView.tsx`
Verify the internal call site updated: `grep -n "createDefaultArtistSelections" src/components/admin/correction/artist/apply/ArtistApplyView.tsx` — should show 2 occurrences (definition + usage).
  </verify>
  <done>
`createDefaultArtistSelections` is exported from ArtistApplyView.tsx and used internally. `UIArtistFieldSelections` is exported. Type checking passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useArtistCorrectionStore with persist middleware and atomic actions</name>
  <files>src/stores/useArtistCorrectionStore.ts</files>
  <action>
Create `src/stores/useArtistCorrectionStore.ts` following the EXACT structure of `src/stores/useCorrectionStore.ts` (the album store), adapted for the artist domain. Use the research file at `.planning/phases/14-artist-correction-store/14-RESEARCH.md` as the detailed specification.

**Imports:**
```typescript
import { create, type StoreApi } from 'zustand';
import type { UseBoundStore } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import type { ArtistCorrectionPreview } from '@/generated/graphql';
import { createDefaultArtistSelections, type UIArtistFieldSelections } from '@/components/admin/correction/artist/apply/ArtistApplyView';
```

**Type Definitions:**

1. **`ManualArtistEditState` interface** — Type defined for future expansion, NOT used in Phase 14:
   ```typescript
   export interface ManualArtistEditState {
     name?: string;
     disambiguation?: string;
     countryCode?: string;
     artistType?: string;
     area?: string;
     beginDate?: string;
     endDate?: string;
     gender?: string;
     externalIds?: {
       musicbrainzId?: string;
       ipi?: string;
       isni?: string;
     };
   }
   ```

2. **`ArtistCorrectionState` interface** — 13 fields total:
   - **6 persisted fields:** step (number), mode ('search' | 'manual'), searchQuery (string | undefined), searchOffset (number), selectedArtistMbid (string | undefined), manualEditState (ManualArtistEditState | undefined)
   - **7 transient fields:** previewData (ArtistCorrectionPreview | null), applySelections (UIArtistFieldSelections | null), shouldEnrich (boolean), showAppliedState (boolean), pendingAction ((() => void) | null), showUnsavedDialog (boolean), isPreviewLoading (boolean)

   **Key differences from album store:**
   - `searchQuery` is `string | undefined` (NOT `SearchQueryState` object — artist search is single field)
   - `selectedArtistMbid` instead of `selectedMbid`
   - No `manualPreviewData` field (manual edit not implemented for artist in Phase 14)
   - Added `isPreviewLoading` (boolean) for preview loading state tracking

3. **`ArtistCorrectionActions` interface** — Same action signatures as album store, minus manual-edit-specific actions:
   - Step navigation: setStep, nextStep, prevStep
   - Mode switching (typed for future): enterSearch, enterManualEdit, cancelManualEdit
   - Search state: setSearchQuery (accepts string, resets offset), setSearchOffset
   - Atomic: selectResult (sets mbid + step=2), setPreviewLoaded (sets previewData + applySelections + shouldEnrich=false)
   - Apply state: setApplySelections, setShouldEnrich, setShowAppliedState
   - Unsaved dialog: setPendingAction, setShowUnsavedDialog, confirmUnsavedDiscard, cancelUnsavedDialog
   - Preview loading: setIsPreviewLoading
   - Reset: clearState

4. **`ArtistCorrectionStore` type** = ArtistCorrectionState & ArtistCorrectionActions

**DEFAULT_STATE constant:**
```typescript
const DEFAULT_STATE: ArtistCorrectionState = {
  step: 0,
  mode: 'search',
  searchQuery: undefined,
  searchOffset: 0,
  selectedArtistMbid: undefined,
  manualEditState: undefined,
  previewData: null,
  applySelections: null,
  shouldEnrich: false,
  showAppliedState: false,
  pendingAction: null,
  showUnsavedDialog: false,
  isPreviewLoading: false,
};
```

**Store factory (`createArtistCorrectionStore`):**
- Create with `create<ArtistCorrectionStore>()(persist(...))`
- Persist middleware config:
  - `name: \`artist-correction-modal-\${artistId}\`` (different key prefix than album!)
  - `storage: createJSONStorage(() => sessionStorage)`
  - `partialize` persists ONLY: step, mode, searchQuery, searchOffset, selectedArtistMbid, manualEditState

**Action implementations — KEY DIFFERENCES from album store:**
- `setStep`: Validate `step >= 0 && step <= 3` (artist is always 4-step in search mode; for future manual mode, check `mode === 'manual' ? 2 : 3`)
- `nextStep`/`prevStep`: Same max-step logic as setStep
- `enterSearch`/`enterManualEdit`/`cancelManualEdit`: Same atomic pattern as album store
- `setSearchQuery(query: string)`: Note this takes a plain string, NOT a SearchQueryState object. Resets searchOffset to 0.
- `selectResult(mbid: string)`: Atomic — sets `selectedArtistMbid: mbid, step: 2`
- `setPreviewLoaded(preview: ArtistCorrectionPreview)`: Atomic — sets `previewData: preview, applySelections: createDefaultArtistSelections(preview), shouldEnrich: false`
- All other actions: Mirror album store exactly

**Store cache:**
- `storeCache = new Map<string, UseBoundStore<StoreApi<ArtistCorrectionStore>>>()`
- `getArtistCorrectionStore(artistId: string)` — get or create, same pattern as album
- `clearArtistCorrectionStoreCache(artistId: string)` — clear state, delete from map, remove sessionStorage key `artist-correction-modal-${artistId}`

**Derived selectors (standalone exported functions):**
- `isFirstStep(state): boolean` — `state.step === 0`
- `isLastStep(state): boolean` — `state.step === (state.mode === 'manual' ? 2 : 3)`
- `maxStep(state): number` — `state.mode === 'manual' ? 2 : 3`
- `stepLabels(state): string[]` — `state.mode === 'manual' ? ['Current', 'Edit', 'Apply'] : ['Current', 'Search', 'Preview', 'Apply']`
- `isManualEditMode(state): boolean` — `state.mode === 'manual'`

**Re-export UIArtistFieldSelections** from the store file for convenience:
```typescript
export type { UIArtistFieldSelections } from '@/components/admin/correction/artist/apply/ArtistApplyView';
```

**IMPORTANT — Zero `any` types.** Every field, parameter, and return must be explicitly typed.

**Add JSDoc comments** matching the album store style for the module, each type, each function, each selector.
  </action>
  <verify>
Run `pnpm type-check` — must pass with zero errors.
Run `grep -c "any" src/stores/useArtistCorrectionStore.ts` — must be 0 (zero `any` types).
Run `grep -n "^export" src/stores/useArtistCorrectionStore.ts` — verify exports: getArtistCorrectionStore, clearArtistCorrectionStoreCache, ArtistCorrectionState, ArtistCorrectionActions, ArtistCorrectionStore, ManualArtistEditState, UIArtistFieldSelections, isFirstStep, isLastStep, maxStep, stepLabels, isManualEditMode.
Verify sessionStorage key uses `artist-correction-modal-` prefix (not `correction-modal-`): `grep "artist-correction-modal" src/stores/useArtistCorrectionStore.ts`
  </verify>
  <done>
`src/stores/useArtistCorrectionStore.ts` exists with:
- ArtistCorrectionState (13 fields: 6 persisted + 7 transient)
- ArtistCorrectionActions with all action creators including atomic selectResult and setPreviewLoaded
- Store factory with Map cache keyed by artistId
- Persist middleware with sessionStorage using `artist-correction-modal-${artistId}` key
- 5 derived selector functions exported
- ManualArtistEditState type defined for future expansion
- Zero `any` types
- Type checking passes
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes with zero errors
2. `grep -c "any" src/stores/useArtistCorrectionStore.ts` returns 0
3. `createDefaultArtistSelections` exported from ArtistApplyView.tsx
4. Store exports at least 12 named exports (types + functions + selectors)
5. SessionStorage key pattern is `artist-correction-modal-${artistId}` (not `correction-modal-`)
6. Partialize persists exactly 6 fields (step, mode, searchQuery, searchOffset, selectedArtistMbid, manualEditState)
7. No consumers yet (zero imports of useArtistCorrectionStore in other files) — this is correct, Plan 02 will wire it up
</verification>

<success_criteria>
- New store file exists at src/stores/useArtistCorrectionStore.ts
- Store follows identical structure to album store (src/stores/useCorrectionStore.ts) with artist-specific adaptations
- Zero any types across all changes
- Type checking passes
- createDefaultArtistSelections exported from ArtistApplyView for store consumption
</success_criteria>

<output>
After completion, create `.planning/phases/14-artist-correction-store/14-01-SUMMARY.md`
</output>
