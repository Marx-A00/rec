---
phase: 03-preview-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/correction/preview/types.ts
  - src/lib/correction/preview/normalizers.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - 'Field diff can classify changes as ADDED, MODIFIED, REMOVED, CONFLICT, or UNCHANGED'
    - 'Text normalization handles Unicode accents consistently'
    - 'diff library is available for character-level text comparison'
  artifacts:
    - path: 'src/lib/correction/preview/types.ts'
      provides: 'ChangeType, FieldDiff, TextDiff, DateDiff, ArrayDiff, TrackDiff, CorrectionPreview types'
      exports:
        [
          'ChangeType',
          'FieldDiff',
          'TextDiff',
          'DateDiff',
          'ArrayDiff',
          'TrackDiff',
          'CorrectionPreview',
        ]
    - path: 'src/lib/correction/preview/normalizers.ts'
      provides: 'Text normalization utilities for comparison'
      exports: ['TextNormalizer', 'normalizeForComparison']
    - path: 'package.json'
      provides: 'diff and deep-object-diff dependencies'
      contains: '"diff"'
  key_links:
    - from: 'src/lib/correction/preview/types.ts'
      to: 'src/lib/correction/types.ts'
      via: 'imports CorrectionSearchResult, CorrectionArtistCredit'
      pattern: 'import.*from.*correction/types'
---

<objective>
Create type definitions and normalization utilities for the preview/diff system.

Purpose: Establish the foundation types and text normalization that diff-engine (03-02) and preview-service (03-03) will build upon. Install required diff libraries.
Output: `src/lib/correction/preview/types.ts`, `src/lib/correction/preview/normalizers.ts`, package.json updated with diff dependencies
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-preview-service/03-CONTEXT.md
@.planning/phases/03-preview-service/03-RESEARCH.md

@src/lib/correction/types.ts
@prisma/schema.prisma (Album and Track models)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install diff dependencies</name>
  <files>package.json</files>
  <action>
Install the `diff` (jsdiff) and `deep-object-diff` packages as production dependencies.

```bash
pnpm add diff deep-object-diff
pnpm add -D @types/diff
```

The `diff` library provides character/word/line level text diffing.
The `deep-object-diff` library provides deep comparison of nested objects.

Note: `deep-object-diff` has TypeScript types included, no separate @types package needed.
</action>
<verify>

- `grep '"diff":' package.json` shows the package
- `grep '"deep-object-diff":' package.json` shows the package
- `pnpm type-check` passes
  </verify>
  <done>Both diff libraries installed and type-checked</done>
  </task>

<task type="auto">
  <name>Task 2: Create preview types</name>
  <files>src/lib/correction/preview/types.ts</files>
  <action>
Create `src/lib/correction/preview/types.ts` with comprehensive type definitions for the diff system.

Types to define:

**ChangeType** - Five-state classification:

```typescript
export type ChangeType =
  | 'ADDED'
  | 'MODIFIED'
  | 'REMOVED'
  | 'CONFLICT'
  | 'UNCHANGED';
```

**TextDiff** - Character-level diff output for text fields:

```typescript
export interface TextDiffPart {
  value: string;
  added?: boolean;
  removed?: boolean;
}

export interface TextDiff {
  field: string;
  changeType: ChangeType;
  currentValue: string | null;
  sourceValue: string | null;
  /** Character-level diff parts (only for MODIFIED/CONFLICT) */
  parts?: TextDiffPart[];
}
```

**DateDiff** - Date component highlighting:

```typescript
export interface DateComponents {
  year?: number;
  month?: number;
  day?: number;
}

export interface DateDiff {
  field: 'releaseDate';
  changeType: ChangeType;
  current: DateComponents | null;
  source: DateComponents | null;
  componentChanges: {
    year: ChangeType;
    month: ChangeType;
    day: ChangeType;
  };
}
```

**ArrayDiff** - For genres, secondaryTypes, etc:

```typescript
export interface ArrayDiff {
  field: string;
  changeType: ChangeType;
  currentItems: string[];
  sourceItems: string[];
  added: string[];
  removed: string[];
  unchanged: string[];
}
```

**TrackDiff** - Position-based track comparison:

```typescript
export interface TrackDiff {
  position: number;
  discNumber: number;
  changeType: 'MATCH' | 'MODIFIED' | 'ADDED' | 'REMOVED';
  /** Current track (null if ADDED) */
  current?: {
    title: string;
    durationMs: number | null;
    trackNumber: number;
  };
  /** Source track from MusicBrainz (null if REMOVED) */
  source?: {
    title: string;
    durationMs: number | null;
    mbid?: string;
  };
  /** Title diff (only for MODIFIED) */
  titleDiff?: TextDiffPart[];
  /** Duration difference in ms (absolute value) */
  durationDelta?: number;
}

export interface TrackListSummary {
  totalCurrent: number;
  totalSource: number;
  matching: number;
  modified: number;
  added: number;
  removed: number;
}
```

**ArtistCreditDiff** - For artist comparison:

```typescript
import type { CorrectionArtistCredit } from '../types';

export interface ArtistCreditDiff {
  changeType: ChangeType;
  current: CorrectionArtistCredit[];
  source: CorrectionArtistCredit[];
  /** Formatted current artist string */
  currentDisplay: string;
  /** Formatted source artist string */
  sourceDisplay: string;
  /** Name diff parts if modified */
  nameDiff?: TextDiffPart[];
}
```

**ExternalIdDiff** - For MBID, Spotify, Discogs IDs:

```typescript
export interface ExternalIdDiff {
  field: 'musicbrainzId' | 'spotifyId' | 'discogsId';
  changeType: ChangeType;
  currentValue: string | null;
  sourceValue: string | null;
}
```

**FieldDiff** - Union type for all diff types:

```typescript
export type FieldDiff = TextDiff | DateDiff | ArrayDiff | ExternalIdDiff;
```

**CorrectionPreview** - Main preview result:

```typescript
import type { Album, Track } from '@prisma/client';
import type { ScoredSearchResult } from '../types';

export interface CorrectionPreview {
  /** Current album data */
  currentAlbum: Album & { tracks: Track[] };
  /** Selected MusicBrainz result */
  sourceResult: ScoredSearchResult;
  /** Full MusicBrainz release data (for tracks) */
  mbReleaseData: MBReleaseData | null;
  /** Field-by-field diffs */
  fieldDiffs: FieldDiff[];
  /** Artist credit comparison */
  artistDiff: ArtistCreditDiff;
  /** Track listing comparison */
  trackDiffs: TrackDiff[];
  /** Track summary stats */
  trackSummary: TrackListSummary;
  /** Cover art comparison */
  coverArt: {
    currentUrl: string | null;
    sourceUrl: string | null;
    changeType: ChangeType;
  };
  /** Summary of all changes */
  summary: {
    totalFields: number;
    changedFields: number;
    addedFields: number;
    modifiedFields: number;
    conflictFields: number;
    hasTrackChanges: boolean;
  };
}
```

**MBReleaseData** - Typed subset of MusicBrainz release response:

```typescript
export interface MBRecording {
  id: string;
  title: string;
  length?: number; // Duration in milliseconds
  position: number;
}

export interface MBMedium {
  position: number;
  format?: string;
  trackCount: number;
  tracks: Array<{
    position: number;
    recording: MBRecording;
  }>;
}

export interface MBReleaseData {
  id: string;
  title: string;
  date?: string;
  country?: string;
  barcode?: string;
  media: MBMedium[];
  artistCredit: Array<{
    name: string;
    joinphrase?: string;
    artist: {
      id: string;
      name: string;
      sortName?: string;
      disambiguation?: string;
    };
  }>;
}
```

  </action>
  <verify>
- `pnpm type-check` passes
- File imports from `../types` successfully
  </verify>
  <done>All preview types defined with proper TypeScript strictness</done>
</task>

<task type="auto">
  <name>Task 3: Create text normalizers</name>
  <files>src/lib/correction/preview/normalizers.ts</files>
  <action>
Create `src/lib/correction/preview/normalizers.ts` with text normalization utilities.

Implement per RESEARCH.md recommendations:

**TextNormalizer class:**

```typescript
/**
 * Text normalization utilities for comparing strings from different sources.
 * Handles Unicode normalization, accent removal, whitespace, and case.
 */
export class TextNormalizer {
  /**
   * Normalize text for semantic comparison.
   * - NFD decomposition to separate base chars from diacritics
   * - Remove combining diacritical marks
   * - Lowercase
   * - Trim and collapse whitespace
   */
  static normalize(text: string | null | undefined): string {
    if (!text) return '';

    return text
      .normalize('NFD') // Decompose Unicode (é → e + ́)
      .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
      .toLowerCase()
      .trim()
      .replace(/\s+/g, ' '); // Collapse whitespace
  }

  /**
   * Check if two strings are semantically equal after normalization.
   */
  static areEqual(
    a: string | null | undefined,
    b: string | null | undefined
  ): boolean {
    return this.normalize(a) === this.normalize(b);
  }

  /**
   * Light normalization for display - preserves case and accents,
   * only trims and collapses whitespace.
   */
  static normalizeWhitespace(text: string | null | undefined): string {
    if (!text) return '';
    return text.trim().replace(/\s+/g, ' ');
  }
}
```

**Export convenience function:**

```typescript
export function normalizeForComparison(
  text: string | null | undefined
): string {
  return TextNormalizer.normalize(text);
}
```

**Date parsing utility:**

```typescript
import type { DateComponents } from './types';

/**
 * Parse a date string into components.
 * Handles YYYY, YYYY-MM, and YYYY-MM-DD formats.
 */
export function parseDateComponents(
  dateString: string | null | undefined
): DateComponents | null {
  if (!dateString) return null;

  const parts = dateString.split('-');
  const year = parts[0] ? parseInt(parts[0], 10) : undefined;
  const month = parts[1] ? parseInt(parts[1], 10) : undefined;
  const day = parts[2] ? parseInt(parts[2], 10) : undefined;

  if (year === undefined || isNaN(year)) return null;

  return {
    year,
    month: month !== undefined && !isNaN(month) ? month : undefined,
    day: day !== undefined && !isNaN(day) ? day : undefined,
  };
}

/**
 * Format DateComponents back to string for display.
 */
export function formatDateComponents(
  components: DateComponents | null
): string {
  if (!components || components.year === undefined) return '(unknown)';

  const parts = [components.year.toString().padStart(4, '0')];
  if (components.month !== undefined) {
    parts.push(components.month.toString().padStart(2, '0'));
    if (components.day !== undefined) {
      parts.push(components.day.toString().padStart(2, '0'));
    }
  }
  return parts.join('-');
}
```

  </action>
  <verify>
- `pnpm type-check` passes
- `pnpm eslint src/lib/correction/preview/` passes
  </verify>
  <done>Normalization utilities created with Unicode NFD, whitespace handling, and date parsing</done>
</task>

</tasks>

<verification>
After all tasks:
```bash
pnpm type-check
pnpm eslint src/lib/correction/preview/
grep '"diff":' package.json
grep '"deep-object-diff":' package.json
```

All commands should pass without errors.
</verification>

<success_criteria>

- diff and deep-object-diff packages installed
- Preview types defined with five-state ChangeType
- TextNormalizer handles Unicode NFD normalization
- Date parsing handles partial dates (YYYY, YYYY-MM, YYYY-MM-DD)
- All types are strict TypeScript (no `any`)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-preview-service/03-01-SUMMARY.md`
</output>
