---
phase: 05-graphql-integration
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/graphql/queries/correctionSearch.graphql
  - src/graphql/queries/correctionPreview.graphql
  - src/graphql/mutations/correctionApply.graphql
  - src/generated/graphql.ts
autonomous: true

must_haves:
  truths:
    - "useCorrectionSearchQuery hook exists and is typed"
    - "useCorrectionPreviewQuery hook exists and is typed"
    - "useCorrectionApplyMutation hook exists and is typed"
    - "Hooks import correctly in React components"
  artifacts:
    - path: "src/graphql/queries/correctionSearch.graphql"
      provides: "Client query for correction search"
      contains: "query CorrectionSearch"
    - path: "src/graphql/queries/correctionPreview.graphql"
      provides: "Client query for correction preview"
      contains: "query CorrectionPreview"
    - path: "src/graphql/mutations/correctionApply.graphql"
      provides: "Client mutation for applying corrections"
      contains: "mutation CorrectionApply"
    - path: "src/generated/graphql.ts"
      provides: "Generated React Query hooks"
      contains: "useCorrectionSearchQuery"
  key_links:
    - from: "src/graphql/queries/correctionSearch.graphql"
      to: "src/generated/graphql.ts"
      via: "pnpm codegen"
      pattern: "useCorrectionSearchQuery"
---

<objective>
Create client query/mutation files and generate React Query hooks

Purpose: Enable React components to consume correction operations via typed hooks
Output: Generated useCorrectionSearchQuery, useCorrectionPreviewQuery, useCorrectionApplyMutation hooks
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-graphql-integration/05-CONTEXT.md
@.planning/phases/05-graphql-integration/05-01-SUMMARY.md
@.planning/phases/05-graphql-integration/05-02-SUMMARY.md

@src/graphql/schema.graphql
@codegen.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client query files for search and preview</name>
  <files>src/graphql/queries/correctionSearch.graphql, src/graphql/queries/correctionPreview.graphql</files>
  <action>
Create two GraphQL query files for client-side consumption.

**src/graphql/queries/correctionSearch.graphql:**
```graphql
query CorrectionSearch($input: CorrectionSearchInput!) {
  correctionSearch(input: $input) {
    results {
      releaseGroupMbid
      primaryResult {
        releaseGroupMbid
        title
        disambiguation
        artistCredits {
          mbid
          name
        }
        primaryArtistName
        firstReleaseDate
        primaryType
        secondaryTypes
        mbScore
        coverArtUrl
        source
        normalizedScore
        displayScore
        breakdown {
          titleScore
          artistScore
          yearScore
          confidenceTier
        }
        isLowConfidence
        scoringStrategy
      }
      alternateVersions {
        releaseGroupMbid
        title
        disambiguation
        primaryArtistName
        firstReleaseDate
        primaryType
        coverArtUrl
        normalizedScore
        isLowConfidence
      }
      versionCount
      bestScore
    }
    totalGroups
    hasMore
    query {
      albumTitle
      artistName
      yearFilter
    }
    scoring {
      strategy
      threshold
      lowConfidenceCount
    }
  }
}
```

**src/graphql/queries/correctionPreview.graphql:**
```graphql
query CorrectionPreview($input: CorrectionPreviewInput!) {
  correctionPreview(input: $input) {
    currentAlbum {
      id
      title
      releaseDate
      releaseType
      coverArtUrl
      cloudflareImageId
      musicbrainzId
      barcode
      label
      dataQuality
      tracks {
        id
        title
        trackNumber
        discNumber
        durationMs
        musicbrainzId
      }
      artists {
        artist {
          id
          name
          musicbrainzId
        }
      }
    }
    sourceResult {
      releaseGroupMbid
      title
      disambiguation
      artistCredits {
        mbid
        name
      }
      primaryArtistName
      firstReleaseDate
      primaryType
      secondaryTypes
      coverArtUrl
      normalizedScore
      displayScore
      breakdown {
        titleScore
        artistScore
        yearScore
        confidenceTier
      }
      isLowConfidence
      scoringStrategy
    }
    mbReleaseData {
      id
      title
      date
      country
      barcode
      media {
        position
        format
        trackCount
        tracks {
          position
          recording {
            id
            title
            length
            position
          }
        }
      }
      artistCredit {
        name
        joinphrase
        artist {
          id
          name
          sortName
          disambiguation
        }
      }
    }
    fieldDiffs
    artistDiff {
      changeType
      current {
        mbid
        name
      }
      source {
        mbid
        name
      }
      currentDisplay
      sourceDisplay
      nameDiff {
        value
        added
        removed
      }
    }
    trackDiffs {
      position
      discNumber
      changeType
      currentTitle
      currentDurationMs
      sourceTitle
      sourceDurationMs
      sourceMbid
      titleDiff {
        value
        added
        removed
      }
      durationDelta
    }
    trackSummary {
      totalCurrent
      totalSource
      matching
      modified
      added
      removed
    }
    coverArt {
      currentUrl
      sourceUrl
      changeType
    }
    summary {
      totalFields
      changedFields
      addedFields
      modifiedFields
      conflictFields
      hasTrackChanges
    }
  }
}
```

Follow existing query file patterns in src/graphql/queries/ directory.
  </action>
  <verify>Files exist: ls src/graphql/queries/correction*.graphql</verify>
  <done>Both query files created with all necessary fields selected</done>
</task>

<task type="auto">
  <name>Task 2: Create client mutation file for apply</name>
  <files>src/graphql/mutations/correctionApply.graphql</files>
  <action>
Create mutation file for correction apply operation.

**src/graphql/mutations/correctionApply.graphql:**
```graphql
mutation CorrectionApply($input: CorrectionApplyInput!) {
  correctionApply(input: $input) {
    success
    album {
      id
      title
      releaseDate
      releaseType
      coverArtUrl
      cloudflareImageId
      musicbrainzId
      barcode
      label
      dataQuality
      updatedAt
      tracks {
        id
        title
        trackNumber
        discNumber
        durationMs
        musicbrainzId
      }
      artists {
        artist {
          id
          name
          musicbrainzId
        }
      }
    }
    changes {
      metadata
      artists {
        added
        removed
      }
      tracks {
        added
        modified
        removed
      }
      externalIds
      coverArt
      dataQualityBefore
      dataQualityAfter
    }
    error {
      code
      message
    }
  }
}
```

Check that src/graphql/mutations/ directory exists - create if needed.
  </action>
  <verify>File exists: ls src/graphql/mutations/correctionApply.graphql</verify>
  <done>Mutation file created with success/error handling</done>
</task>

<task type="auto">
  <name>Task 3: Run codegen and verify hook generation</name>
  <files>src/generated/graphql.ts</files>
  <action>
Run the GraphQL code generator to create typed React Query hooks.

1. Run codegen:
   ```bash
   pnpm codegen
   ```

2. Verify hooks exist in generated file by checking for:
   - `useCorrectionSearchQuery`
   - `useCorrectionPreviewQuery` 
   - `useCorrectionApplyMutation`

3. If codegen fails:
   - Check schema syntax errors in schema.graphql
   - Check query file syntax errors
   - Verify field names match schema exactly

4. Verify TypeScript types are generated:
   - CorrectionSearchInput
   - CorrectionSearchResponse
   - CorrectionPreviewInput
   - CorrectionPreview
   - CorrectionApplyInput
   - CorrectionApplyResult
  </action>
  <verify>
Run: grep -E "useCorrectionSearchQuery|useCorrectionPreviewQuery|useCorrectionApplyMutation" src/generated/graphql.ts
All three hooks should appear.
  </verify>
  <done>Codegen completes successfully and all three hooks are generated</done>
</task>

</tasks>

<verification>
- `pnpm codegen` runs without errors
- `pnpm type-check` passes
- Generated hooks are importable:
  ```typescript
  import { 
    useCorrectionSearchQuery,
    useCorrectionPreviewQuery,
    useCorrectionApplyMutation 
  } from '@/generated/graphql';
  ```
</verification>

<success_criteria>
- correctionSearch.graphql exists with full field selection
- correctionPreview.graphql exists with all diff fields
- correctionApply.graphql exists with result/error fields
- codegen runs without errors
- useCorrectionSearchQuery hook is generated
- useCorrectionPreviewQuery hook is generated
- useCorrectionApplyMutation hook is generated
- Types are properly inferred from hooks
</success_criteria>

<output>
After completion, create `.planning/phases/05-graphql-integration/05-03-SUMMARY.md`
</output>
