---
phase: 01-foundation-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/musicbrainz/mbid-verifier.ts
  - src/lib/musicbrainz/index.ts
  - src/lib/queue/processors/musicbrainz-processor.ts
autonomous: true

must_haves:
  truths:
    - "MBID redirects are detected when API returns different ID than requested"
    - "Verification result includes both requested and returned MBIDs"
    - "Lookup handlers wrap results with verification metadata"
  artifacts:
    - path: "src/lib/musicbrainz/mbid-verifier.ts"
      provides: "verifyMbid function and MbidVerificationResult type"
      exports: ["verifyMbid", "MbidVerificationResult"]
    - path: "src/lib/queue/processors/musicbrainz-processor.ts"
      provides: "Lookup handlers with verification wrapper"
      contains: "verifyMbid"
  key_links:
    - from: "src/lib/queue/processors/musicbrainz-processor.ts"
      to: "src/lib/musicbrainz/mbid-verifier.ts"
      via: "import verifyMbid"
      pattern: "import.*verifyMbid.*from"
---

<objective>
Create MBID verification utility that detects when MusicBrainz returns a redirected (canonical) MBID different from the requested one.

Purpose: MusicBrainz merges entities over time, causing stored MBIDs to become obsolete. Detecting redirects allows the system to flag or update affected records.
Output: mbid-verifier.ts utility with verifyMbid function, integrated into lookup handlers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

# Current implementation files
@src/lib/musicbrainz/basic-service.ts
@src/lib/queue/processors/musicbrainz-processor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mbid-verifier.ts utility</name>
  <files>src/lib/musicbrainz/mbid-verifier.ts, src/lib/musicbrainz/index.ts</files>
  <action>
Create new file src/lib/musicbrainz/mbid-verifier.ts:

```typescript
// src/lib/musicbrainz/mbid-verifier.ts
/**
 * MBID verification utility
 * Detects when MusicBrainz returns a redirected (canonical) MBID
 * 
 * MusicBrainz merges entities over time. When an entity is merged,
 * the old MBID redirects to the new canonical MBID. The API returns
 * the canonical MBID silently - no redirect indication in response.
 * 
 * This utility compares requested vs returned MBIDs to detect redirects.
 */

/**
 * Result of MBID verification
 */
export interface MbidVerificationResult<T> {
  /** The original data from MusicBrainz */
  data: T;
  /** The MBID that was requested */
  requestedMbid: string;
  /** The MBID that was returned (may differ if redirected) */
  returnedMbid: string;
  /** True if the returned MBID differs from requested */
  wasRedirected: boolean;
}

/**
 * Verify if a MusicBrainz lookup returned a different MBID than requested
 * 
 * @param requestedMbid - The MBID sent to the API
 * @param result - The result object from MusicBrainz (must have 'id' field)
 * @returns Verification result with redirect detection
 * 
 * @example
 * const artist = await musicBrainzService.getArtist(mbid);
 * const verified = verifyMbid(mbid, artist);
 * if (verified.wasRedirected) {
 *   console.warn(`MBID redirect: ${verified.requestedMbid} -> ${verified.returnedMbid}`);
 * }
 */
export function verifyMbid<T extends { id: string }>(
  requestedMbid: string,
  result: T
): MbidVerificationResult<T> {
  const wasRedirected = requestedMbid !== result.id;
  
  if (wasRedirected) {
    console.warn(
      `ðŸ”€ MBID redirect detected: ${requestedMbid} -> ${result.id}`
    );
  }
  
  return {
    data: result,
    requestedMbid,
    returnedMbid: result.id,
    wasRedirected,
  };
}

/**
 * Type guard to check if an object has an 'id' string property
 */
export function hasIdProperty(obj: unknown): obj is { id: string } {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'id' in obj &&
    typeof (obj as Record<string, unknown>).id === 'string'
  );
}
```

Export from src/lib/musicbrainz/index.ts by adding:
```typescript
export { verifyMbid, hasIdProperty, type MbidVerificationResult } from './mbid-verifier';
```
  </action>
  <verify>
Run `pnpm type-check` to verify no type errors.
File exists at src/lib/musicbrainz/mbid-verifier.ts.
Exports are available from src/lib/musicbrainz/index.ts.
  </verify>
  <done>
mbid-verifier.ts exists with verifyMbid function and MbidVerificationResult type.
Function logs warning when redirect detected.
Exports available from musicbrainz index.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate verification into lookup handlers</name>
  <files>src/lib/queue/processors/musicbrainz-processor.ts</files>
  <action>
Update the lookup handlers in musicbrainz-processor.ts to wrap results with MBID verification.

1. Add import at top of file:
```typescript
import { verifyMbid, hasIdProperty } from '../../musicbrainz';
```

2. Modify lookup handlers to return verification result:

For handleLookupArtist:
```typescript
export async function handleLookupArtist(data: MusicBrainzLookupArtistJobData) {
  const result = await musicBrainzService.getArtist(data.mbid, data.includes);
  
  // Verify MBID wasn't redirected
  if (hasIdProperty(result)) {
    return verifyMbid(data.mbid, result);
  }
  
  return result;
}
```

Apply same pattern to:
- handleLookupRelease
- handleLookupRecording
- handleLookupReleaseGroup

For handleBrowseReleaseGroupsByArtist, verification is NOT needed (browse uses artist MBID, returns list of release groups with their own IDs).

Keep search handlers unchanged - they return lists, not single entities by MBID.

The verification result wraps the original data, so downstream code can access:
- result.data (original MusicBrainz response)
- result.wasRedirected (boolean flag)
- result.requestedMbid / result.returnedMbid (for logging/updating)
  </action>
  <verify>
Run `pnpm type-check` to verify no type errors.
Run `pnpm lint` to check for style issues.
Grep for "verifyMbid" in musicbrainz-processor.ts to confirm integration.
  </verify>
  <done>
Four lookup handlers (Artist, Release, Recording, ReleaseGroup) wrap results with verification.
When redirect detected, warning is logged.
Downstream code receives MbidVerificationResult with wasRedirected flag.
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes with no errors
2. `pnpm lint` passes with no errors
3. mbid-verifier.ts exports verifyMbid and MbidVerificationResult
4. Lookup handlers return MbidVerificationResult type
5. Warning logged when redirect detected
</verification>

<success_criteria>
- verifyMbid function compares requested vs returned MBIDs
- MbidVerificationResult type wraps data with redirect metadata
- Lookup handlers automatically verify MBIDs
- Console warning logged when redirect detected
- Existing code continues to work (data is accessible via .data property)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md`
</output>
