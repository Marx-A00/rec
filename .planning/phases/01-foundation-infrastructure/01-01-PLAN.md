---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queue/jobs.ts
  - src/lib/queue/index.ts
  - src/lib/musicbrainz/queue-service.ts
autonomous: true

must_haves:
  truths:
    - "Admin search requests execute before background jobs"
    - "Priority tiers are semantic constants, not magic numbers"
    - "Queue service methods accept optional priority parameter"
  artifacts:
    - path: "src/lib/queue/jobs.ts"
      provides: "PRIORITY_TIERS constant and PriorityTier type"
      contains: "PRIORITY_TIERS"
    - path: "src/lib/musicbrainz/queue-service.ts"
      provides: "Priority-aware public methods"
      contains: "priorityTier"
  key_links:
    - from: "src/lib/musicbrainz/queue-service.ts"
      to: "src/lib/queue/jobs.ts"
      via: "import PRIORITY_TIERS"
      pattern: "import.*PRIORITY_TIERS.*from"
---

<objective>
Add semantic priority tiers to the BullMQ queue system so admin requests can be prioritized over background jobs.

Purpose: Admin UI searches need to execute faster than scheduled syncs to provide responsive correction workflow.
Output: PRIORITY_TIERS constant, PriorityTier type, and updated queue-service methods accepting priority parameter.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md

# Current implementation files
@src/lib/queue/jobs.ts
@src/lib/musicbrainz/queue-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PRIORITY_TIERS constant and type to jobs.ts</name>
  <files>src/lib/queue/jobs.ts, src/lib/queue/index.ts</files>
  <action>
Add PRIORITY_TIERS constant at the top of jobs.ts (after JOB_TYPES):

```typescript
export const PRIORITY_TIERS = {
  ADMIN: 1,        // Admin UI corrections - highest priority
  USER: 5,         // User-initiated searches (recommendations, collections)
  ENRICHMENT: 8,   // Enrichment jobs (album/artist data fetching)
  BACKGROUND: 10,  // Scheduled syncs, background tasks
} as const;

export type PriorityTier = typeof PRIORITY_TIERS[keyof typeof PRIORITY_TIERS];
```

Also export these from src/lib/queue/index.ts by adding to the jobs.ts exports:
- PRIORITY_TIERS
- PriorityTier (type export)

Do NOT change existing job data interfaces or MusicBrainzJobOptions - priority is already supported there.
  </action>
  <verify>
Run `pnpm type-check` to verify no type errors.
Grep for PRIORITY_TIERS in jobs.ts and index.ts to confirm exports.
  </verify>
  <done>
PRIORITY_TIERS constant exists with ADMIN=1, USER=5, ENRICHMENT=8, BACKGROUND=10.
PriorityTier type is exported from src/lib/queue/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update queue-service.ts to accept priority tier parameter</name>
  <files>src/lib/musicbrainz/queue-service.ts</files>
  <action>
Modify QueuedMusicBrainzService public methods to accept an optional priorityTier parameter.

1. Import PRIORITY_TIERS and PriorityTier from '../queue':
   ```typescript
   import { ..., PRIORITY_TIERS, type PriorityTier } from '../queue';
   ```

2. Update each public search/lookup method signature to accept optional priorityTier:
   - searchArtists(query, limit?, offset?, priorityTier?: PriorityTier)
   - searchReleaseGroups(query, limit?, offset?, priorityTier?: PriorityTier)
   - searchRecordings(query, limit?, offset?, priorityTier?: PriorityTier)
   - getArtist(mbid, includes?, priorityTier?: PriorityTier)
   - getRelease(mbid, includes?, priorityTier?: PriorityTier)
   - getReleaseGroup(mbid, includes?, priorityTier?: PriorityTier)
   - getRecording(mbid, includes?, priorityTier?: PriorityTier)
   - browseReleaseGroupsByArtist(artistMbid, limit?, offset?, priorityTier?: PriorityTier)

3. In each method, replace hardcoded `priority: 1` with `priority: priorityTier ?? PRIORITY_TIERS.USER`

Example for searchArtists:
```typescript
async searchArtists(
  query: string,
  limit = 25,
  offset = 0,
  priorityTier: PriorityTier = PRIORITY_TIERS.USER
): Promise<ArtistSearchResult[]> {
  // ... existing code ...
  const job = await this.queue.addJob(
    JOB_TYPES.MUSICBRAINZ_SEARCH_ARTISTS,
    { query, limit, offset },
    {
      priority: priorityTier,  // Changed from hardcoded 1
      requestId: `search-artists-${Date.now()}`,
    }
  );
  // ... rest unchanged ...
}
```

Default to PRIORITY_TIERS.USER (5) to maintain backward compatibility - existing code calling without priority parameter will still work.
  </action>
  <verify>
Run `pnpm type-check` to verify no type errors.
Run `pnpm lint` to check for any style issues.
Grep for "priorityTier" in queue-service.ts to confirm all methods updated.
  </verify>
  <done>
All 8 public methods accept optional priorityTier parameter.
Default priority is USER (5) for backward compatibility.
Admin correction code can pass PRIORITY_TIERS.ADMIN for highest priority.
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes with no errors
2. `pnpm lint` passes with no errors
3. PRIORITY_TIERS is exported from src/lib/queue/index.ts
4. All queue-service public methods accept priorityTier parameter
5. Existing code continues to work (default USER priority)
</verification>

<success_criteria>
- PRIORITY_TIERS constant defines 4 semantic tiers: ADMIN(1), USER(5), ENRICHMENT(8), BACKGROUND(10)
- PriorityTier type is available for type-safe priority usage
- Queue service methods accept optional priority tier, defaulting to USER
- No breaking changes to existing code
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
