---
phase: 15-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/[timestamp]_add_parent_job_id/migration.sql
autonomous: true

must_haves:
  truths:
    - "EnrichmentLog records can have a parentJobId linking to their parent job"
    - "Child jobs can be queried efficiently by parentJobId"
    - "Existing logs are unaffected (null parentJobId is valid)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "parentJobId field in EnrichmentLog model"
      contains: "parentJobId"
    - path: "prisma/migrations/*_add_parent_job_id/migration.sql"
      provides: "Database migration for parentJobId"
      contains: "parent_job_id"
  key_links:
    - from: "prisma/schema.prisma"
      to: "PostgreSQL database"
      via: "prisma migrate dev"
      pattern: "parentJobId.*@map.*parent_job_id"
---

<objective>
Add `parentJobId` field and index to EnrichmentLog model for job chain linking.

Purpose: Enable parent-child relationships between enrichment logs so timeline UI can show job hierarchies.
Output: Updated Prisma schema with new field and migration applied to database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-schema-migration/15-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parentJobId field and index to EnrichmentLog</name>
  <files>prisma/schema.prisma</files>
  <action>
Add `parentJobId` field to the EnrichmentLog model following the exact pattern of the existing `jobId` field:

1. Locate the `jobId` field at line 419 in EnrichmentLog model
2. Add the new field immediately after `jobId`:
   ```prisma
   parentJobId        String?                @map("parent_job_id") @db.VarChar(100)
   ```

3. Add a new index for efficient child lookups. Add after existing indexes (before `@@map`):
   ```prisma
   @@index([parentJobId])
   ```

Field must be:
- Nullable (`String?`) - existing logs will have NULL
- Column name `parent_job_id` via `@map()` - PostgreSQL snake_case convention
- VARCHAR(100) via `@db.VarChar(100)` - matches `jobId` type

DO NOT use `db push` - we need migration files for version control.
  </action>
  <verify>Check schema.prisma contains both `parentJobId` field and `@@index([parentJobId])`</verify>
  <done>EnrichmentLog model has parentJobId field and index defined</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply Prisma migration</name>
  <files>prisma/migrations/[timestamp]_add_parent_job_id/migration.sql</files>
  <action>
Run Prisma migrate to create and apply the migration:

```bash
pnpm prisma migrate dev --name add_parent_job_id
```

This will:
1. Create migration file in `prisma/migrations/[timestamp]_add_parent_job_id/`
2. Apply the migration to the database
3. Regenerate Prisma client with new field

After migration completes, verify:
1. Migration file exists and contains correct SQL
2. Prisma client includes `parentJobId` field

Expected migration SQL:
```sql
ALTER TABLE "enrichment_logs" ADD COLUMN "parent_job_id" VARCHAR(100);
CREATE INDEX "enrichment_logs_parent_job_id_idx" ON "enrichment_logs"("parent_job_id");
```
  </action>
  <verify>
1. Run `ls prisma/migrations/ | grep add_parent_job_id` - should show migration folder
2. Run `pnpm prisma generate` - should complete without errors
3. Check node_modules/.prisma/client shows parentJobId in EnrichmentLog type
  </verify>
  <done>Migration file created, applied to database, and Prisma client regenerated</done>
</task>

<task type="auto">
  <name>Task 3: Verify migration integrity</name>
  <files>N/A (verification only)</files>
  <action>
Verify the migration was applied correctly to the database:

1. Check the migration file contains expected SQL
2. Confirm no data was lost (existing logs should be unchanged)
3. Verify new column exists with correct type

Run these verification queries via Prisma:
```bash
# Quick sanity check - query should work without errors
pnpm prisma db execute --stdin <<< "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name = 'enrichment_logs' AND column_name = 'parent_job_id';"
```

Also verify index exists:
```bash
pnpm prisma db execute --stdin <<< "SELECT indexname FROM pg_indexes WHERE tablename = 'enrichment_logs' AND indexname LIKE '%parent_job_id%';"
```

If both queries return expected results, migration is complete and correct.
  </action>
  <verify>
Database has:
- Column `parent_job_id` of type VARCHAR(100), nullable
- Index `enrichment_logs_parent_job_id_idx` on the column
  </verify>
  <done>Database schema verified with parentJobId column and index</done>
</task>

</tasks>

<verification>
Phase verification checklist:

1. **DATA-01**: EnrichmentLog has `parentJobId` field
   - Check: `grep "parentJobId" prisma/schema.prisma` returns the field definition

2. **DATA-02**: Index exists on `parentJobId`
   - Check: `grep "@@index(\[parentJobId\])" prisma/schema.prisma` returns the index

3. **DATA-03**: Existing logs unchanged (null parentJobId)
   - Check: Query existing logs, verify they have NULL parentJobId and all other data intact

4. **Type safety**: Prisma client includes new field
   - Check: `pnpm type-check` passes
</verification>

<success_criteria>
- [ ] `parentJobId` field exists in EnrichmentLog model (nullable VARCHAR 100)
- [ ] Index exists on `parentJobId` for efficient child lookups
- [ ] Migration file created in `prisma/migrations/`
- [ ] Migration applied without errors
- [ ] Existing logs remain intact (null `parentJobId`)
- [ ] Prisma client regenerated with new field
- [ ] `pnpm type-check` passes
</success_criteria>

<output>
After completion, create `.planning/phases/15-schema-migration/15-01-SUMMARY.md`
</output>
