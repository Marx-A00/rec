---
phase: 39-stats-streaks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/uncover/stats-service.ts
  - src/lib/uncover/game-service.ts
autonomous: true

must_haves:
  truths:
    - "Stats update when game ends (won or lost)"
    - "Win streak increments on consecutive day wins"
    - "Win streak resets to 0 on loss"
    - "Same-day game completions don't duplicate stats"
    - "Guess distribution tracks wins by attempt count"
  artifacts:
    - path: "src/lib/uncover/stats-service.ts"
      provides: "Stats CRUD and streak logic"
      exports: ["updatePlayerStats", "getPlayerStats"]
    - path: "src/lib/uncover/game-service.ts"
      provides: "Stats integration on game end"
      contains: "updatePlayerStats"
  key_links:
    - from: "src/lib/uncover/game-service.ts"
      to: "src/lib/uncover/stats-service.ts"
      via: "import and call on gameOver"
      pattern: "updatePlayerStats\\("
---

<objective>
Create stats service with streak calculation logic and integrate with game service.

Purpose: STATS-01 through STATS-05 require stats updates when games complete. Stats service handles denormalized updates to UncoverPlayerStats table with UTC-aware streak logic.

Output: stats-service.ts with updatePlayerStats/getPlayerStats functions, game-service.ts calling stats update on game end.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-stats-streaks/39-RESEARCH.md
@prisma/schema.prisma
@src/lib/uncover/game-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats-service.ts</name>
  <files>src/lib/uncover/stats-service.ts</files>
  <action>
Create stats service with these exports:

1. **UTC date helpers:**
   - `toUTCMidnight(date: Date): Date` - Normalize to UTC midnight
   - `isConsecutiveDay(lastPlayed: Date | null, challengeDate: Date): boolean` - Check if exactly 1 day apart (UTC)
   - `isSameDay(date1: Date | null, date2: Date): boolean` - Prevent duplicate updates

2. **Types:**
   - `UpdateStatsInput { userId, won, attemptCount, challengeDate }`
   - `PlayerStats { gamesPlayed, gamesWon, winRate, currentStreak, maxStreak, winDistribution }`

3. **updatePlayerStats(input, prisma):**
   - Fetch existing stats: `prisma.uncoverPlayerStats.findUnique({ where: { userId } })`
   - Early return if `isSameDay(existing.lastPlayedDate, challengeDate)` (idempotent)
   - Calculate streak:
     - If won AND consecutive day: `currentStreak = existing.currentStreak + 1`
     - If won AND NOT consecutive: `currentStreak = 1`
     - If lost: `currentStreak = 0`
   - Update maxStreak if currentStreak exceeds it
   - Update winDistribution array (index = attemptCount - 1) if won AND attemptCount 1-6
   - Use Prisma upsert with:
     - create: Initial values (gamesPlayed=1, etc.)
     - update: Increment gamesPlayed, conditional gamesWon increment, set streaks, set lastPlayedDate

4. **getPlayerStats(userId, prisma):**
   - Fetch existing stats or return zeros if not found
   - Calculate winRate: `gamesWon / gamesPlayed` (or 0 if no games)
   - Return PlayerStats shape

Use proper TypeScript types (no `any`). Import PrismaClient type from `@prisma/client`.
  </action>
  <verify>
`pnpm type-check` passes with no errors in stats-service.ts
  </verify>
  <done>
stats-service.ts exists with updatePlayerStats and getPlayerStats exports, proper TypeScript types, UTC date helpers
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate stats update into game-service.ts</name>
  <files>src/lib/uncover/game-service.ts</files>
  <action>
Modify game-service.ts to call stats update when game ends:

1. **Add import at top:**
   ```typescript
   import { updatePlayerStats } from './stats-service';
   ```

2. **In submitGuess function**, after `const updatedSession = await prisma.uncoverSession.update(...)`:
   - Add stats update call AFTER session update, BEFORE challenge stats update:
   ```typescript
   // Update player stats if game ended (STATS-01 through STATS-05)
   if (gameResult.gameOver) {
     await updatePlayerStats(
       {
         userId,
         won: isCorrect,
         attemptCount: newAttemptCount,
         challengeDate: session.challenge.date,
       },
       prisma
     );
   }
   ```

3. **In skipGuess function**, after `const updatedSession = await prisma.uncoverSession.update(...)`:
   - Add same stats update call:
   ```typescript
   // Update player stats if game ended (STATS-01 through STATS-05)
   if (gameResult.gameOver) {
     await updatePlayerStats(
       {
         userId,
         won: false, // skip is always a loss
         attemptCount: newAttemptCount,
         challengeDate: session.challenge.date,
       },
       prisma
     );
   }
   ```

The `session.challenge.date` provides the challenge date for streak comparison (already UTC midnight in DB).
  </action>
  <verify>
`pnpm type-check` passes with no errors in game-service.ts
  </verify>
  <done>
game-service.ts calls updatePlayerStats in both submitGuess and skipGuess when gameOver is true
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes
2. `pnpm lint` passes for modified files
3. Stats service exports updatePlayerStats and getPlayerStats functions
4. Game service imports and calls stats-service on game completion
</verification>

<success_criteria>
- Stats service created with UTC-aware streak logic
- Game service calls stats update on game end (won or lost)
- TypeScript compiles without errors
- Idempotent updates (same-day check prevents duplicates)
</success_criteria>

<output>
After completion, create `.planning/phases/39-stats-streaks/39-01-SUMMARY.md`
</output>
