---
phase: 39-stats-streaks
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - src/graphql/schema.graphql
  - src/graphql/queries/uncoverStats.graphql
  - src/lib/graphql/resolvers/queries.ts
autonomous: true

must_haves:
  truths:
    - "GraphQL query myUncoverStats returns player's stats"
    - "Stats include gamesPlayed, gamesWon, winRate, streaks, distribution"
    - "Unauthenticated requests return error"
    - "New users get default zeros (not null/error)"
  artifacts:
    - path: "src/graphql/schema.graphql"
      provides: "UncoverPlayerStats type and query"
      contains: "type UncoverPlayerStats"
    - path: "src/graphql/queries/uncoverStats.graphql"
      provides: "Client query for stats"
      contains: "query MyUncoverStats"
    - path: "src/lib/graphql/resolvers/queries.ts"
      provides: "myUncoverStats resolver"
      contains: "myUncoverStats"
  key_links:
    - from: "src/lib/graphql/resolvers/queries.ts"
      to: "src/lib/uncover/stats-service.ts"
      via: "dynamic import and call"
      pattern: "getPlayerStats"
---

<objective>
Add GraphQL API for querying player stats.

Purpose: STATS-07 and STATS-08 require stats to be accessible via API for cross-device sync. This plan adds the GraphQL schema type and query resolver.

Output: UncoverPlayerStats type in schema, myUncoverStats query, resolver implementation.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-stats-streaks/39-RESEARCH.md
@.planning/phases/39-stats-streaks/39-01-SUMMARY.md
@src/graphql/schema.graphql
@src/lib/graphql/resolvers/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UncoverPlayerStats type and query to GraphQL schema</name>
  <files>src/graphql/schema.graphql</files>
  <action>
Add the UncoverPlayerStats type and query to the GraphQL schema.

1. **Add UncoverPlayerStats type** (near other game types like UncoverSession):
```graphql
"""
Player statistics for Uncover daily challenge game.
Tracks games played, win rate, streaks, and guess distribution.
"""
type UncoverPlayerStats {
  id: UUID!
  gamesPlayed: Int!
  gamesWon: Int!
  totalAttempts: Int!
  currentStreak: Int!
  maxStreak: Int!
  lastPlayedDate: DateTime
  "Win count by attempt number (index 0 = 1-guess wins, etc.)"
  winDistribution: [Int!]!
  
  "Computed: gamesWon / gamesPlayed (0 if no games)"
  winRate: Float!
}
```

2. **Add query to Query type** (in the existing `type Query { ... }` block):
```graphql
  "Get current user's Uncover game stats (requires auth)"
  myUncoverStats: UncoverPlayerStats
```

Place the type definition near other Uncover-related types (search for "Uncover" in the file to find the section).
  </action>
  <verify>
`pnpm codegen` runs without schema errors
  </verify>
  <done>
UncoverPlayerStats type defined in schema with all required fields, myUncoverStats query added to Query type
  </done>
</task>

<task type="auto">
  <name>Task 2: Create client query for stats</name>
  <files>src/graphql/queries/uncoverStats.graphql</files>
  <action>
Create a new GraphQL query file for stats:

```graphql
# Query for player's Uncover game stats
# Used by StatsModal after game completion
query MyUncoverStats {
  myUncoverStats {
    id
    gamesPlayed
    gamesWon
    totalAttempts
    currentStreak
    maxStreak
    lastPlayedDate
    winDistribution
    winRate
  }
}
```

This will generate `useMyUncoverStatsQuery` hook after codegen.
  </action>
  <verify>
File exists at src/graphql/queries/uncoverStats.graphql
  </verify>
  <done>
uncoverStats.graphql created with MyUncoverStats query
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement myUncoverStats resolver</name>
  <files>src/lib/graphql/resolvers/queries.ts</files>
  <action>
Add the myUncoverStats resolver to queries.ts:

1. **Add resolver function** (follow the existing pattern for other resolvers):

```typescript
export const myUncoverStats = async (
  _parent: unknown,
  _args: Record<string, never>,
  context: GraphQLContext
) => {
  // Require authentication
  if (!context.user) {
    throw new GraphQLError('Authentication required', {
      extensions: { code: 'UNAUTHENTICATED' },
    });
  }

  // Dynamic import to avoid circular dependencies (follows existing pattern)
  const { getPlayerStats } = await import('@/lib/uncover/stats-service');
  
  const stats = await getPlayerStats(context.user.id, context.prisma);
  
  // Fetch totalAttempts from database (not in getPlayerStats return)
  const dbStats = await context.prisma.uncoverPlayerStats.findUnique({
    where: { userId: context.user.id },
  });
  
  return {
    id: context.user.id,
    gamesPlayed: stats.gamesPlayed,
    gamesWon: stats.gamesWon,
    totalAttempts: dbStats?.totalAttempts ?? 0,
    currentStreak: stats.currentStreak,
    maxStreak: stats.maxStreak,
    lastPlayedDate: dbStats?.lastPlayedDate ?? null,
    winDistribution: stats.winDistribution,
    winRate: stats.winRate,
  };
};
```

2. **Add to resolvers export** at the bottom of the file:
Add `myUncoverStats` to the Query resolvers object (if there's a combined export).

Follow the existing pattern in the file for resolver organization (check how other resolvers like `dailyChallenge` are structured).
  </action>
  <verify>
`pnpm codegen` succeeds and `pnpm type-check` passes
  </verify>
  <done>
myUncoverStats resolver implemented with auth check and stats fetching
  </done>
</task>

</tasks>

<verification>
1. `pnpm codegen` generates types without errors
2. `pnpm type-check` passes
3. `pnpm lint` passes
4. Generated `useMyUncoverStatsQuery` hook exists in src/generated/graphql.ts
</verification>

<success_criteria>
- GraphQL schema has UncoverPlayerStats type
- myUncoverStats query added to schema
- Client query file created
- Resolver implemented with auth check
- Codegen produces useMyUncoverStatsQuery hook
</success_criteria>

<output>
After completion, create `.planning/phases/39-stats-streaks/39-02-SUMMARY.md`
</output>
