---
phase: 26-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/[timestamp]_rename_enrichmentlog_to_llamalog/migration.sql
autonomous: true

must_haves:
  truths:
    - "Database table renamed from enrichment_logs to llama_logs"
    - "LlamaLogCategory enum exists with 5 values"
    - "All existing records have a category value"
    - "Prisma client generates LlamaLog types"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "LlamaLog model with category field and LlamaLogCategory enum"
      contains: "model LlamaLog"
    - path: "prisma/migrations/*_rename_enrichmentlog_to_llamalog/migration.sql"
      provides: "Migration SQL for table rename, enum, and backfill"
      contains: "ALTER TABLE"
  key_links:
    - from: "prisma/schema.prisma"
      to: "node_modules/.prisma/client"
      via: "prisma generate"
      pattern: "LlamaLog"
---

<objective>
Rename EnrichmentLog to LlamaLog with new category enum and backfill existing records.

Purpose: Foundation for v1.4 LlamaLog provenance system - broader naming for entity lifecycle tracking beyond just enrichment.

Output: Updated Prisma schema, migration SQL, and verified database state with zero data loss.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-schema-migration/26-RESEARCH.md
@prisma/schema.prisma
@src/lib/queue/jobs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma Schema and Create Migration</name>
  <files>
    prisma/schema.prisma
    prisma/migrations/[timestamp]_rename_enrichmentlog_to_llamalog/migration.sql
  </files>
  <action>
1. **Create LlamaLogCategory enum** in prisma/schema.prisma:
   ```prisma
   enum LlamaLogCategory {
     CREATED
     ENRICHED
     CORRECTED
     CACHED
     FAILED
   }
   ```

2. **Rename the model** from `EnrichmentLog` to `LlamaLog`:
   - Change `model EnrichmentLog {` to `model LlamaLog {`
   - Update `@@map("enrichment_logs")` to `@@map("llama_logs")`
   - Add `category LlamaLogCategory` field after `status` field
   - Add `@@index([category, createdAt])` for category filtering

3. **Update all relation references** in other models:
   - User: `enrichmentLogs EnrichmentLog[]` → `llamaLogs LlamaLog[]`
   - Album: `enrichmentLogs EnrichmentLog[]` → `llamaLogs LlamaLog[]`
   - Artist: `enrichmentLogs EnrichmentLog[]` → `llamaLogs LlamaLog[]`
   - Track: `enrichmentLogs EnrichmentLog[]` → `llamaLogs LlamaLog[]`

4. **Create migration with --create-only** (do NOT apply yet):
   ```bash
   npx prisma migrate dev --create-only --name rename_enrichmentlog_to_llamalog
   ```

5. **Edit the generated migration SQL** to use safe rename instead of drop/create. Replace the auto-generated SQL with:

   ```sql
   -- STEP 1: RENAME TABLE (preserves all data)
   ALTER TABLE "enrichment_logs" RENAME TO "llama_logs";

   -- STEP 2: CREATE ENUM
   CREATE TYPE "LlamaLogCategory" AS ENUM ('CREATED', 'ENRICHED', 'CORRECTED', 'CACHED', 'FAILED');

   -- STEP 3: ADD CATEGORY COLUMN (nullable initially for backfill)
   ALTER TABLE "llama_logs" ADD COLUMN "category" "LlamaLogCategory";

   -- STEP 4: CREATE INDEX FOR CATEGORY FILTERING
   CREATE INDEX "llama_logs_category_createdAt_idx" ON "llama_logs"("category", "created_at");

   -- STEP 5: BACKFILL CATEGORIES based on operation patterns
   -- CACHED: cache operations
   UPDATE "llama_logs" SET "category" = 'CACHED' 
   WHERE "operation" LIKE 'cache:%';

   -- CORRECTED: admin corrections
   UPDATE "llama_logs" SET "category" = 'CORRECTED' 
   WHERE "operation" = 'admin_correction';

   -- ENRICHED: enrichment, check, and API operations  
   UPDATE "llama_logs" SET "category" = 'ENRICHED' 
   WHERE "operation" LIKE 'enrichment:%' 
      OR "operation" LIKE 'check:%'
      OR "operation" LIKE 'musicbrainz:%'
      OR "operation" LIKE 'spotify:%'
      OR "operation" LIKE 'discogs:%'
      OR "operation" = 'PREVIEW_ENRICHMENT';

   -- FAILED: records with FAILED status (overrides previous)
   UPDATE "llama_logs" SET "category" = 'FAILED' 
   WHERE "status" = 'FAILED' AND "category" IS NULL;

   -- CREATED: catch-all for remaining (future creation events)
   UPDATE "llama_logs" SET "category" = 'CREATED' 
   WHERE "category" IS NULL;

   -- STEP 6: MAKE COLUMN REQUIRED (now safe after backfill)
   ALTER TABLE "llama_logs" ALTER COLUMN "category" SET NOT NULL;
   ```

6. **Apply the migration**:
   ```bash
   npx prisma migrate dev
   ```

7. **Generate Prisma client**:
   ```bash
   npx prisma generate
   ```
  </action>
  <verify>
    Run: `npx prisma validate` - should succeed
    Run: `npx prisma db pull --force` and verify schema matches expectations
    Check: `node_modules/.prisma/client/index.d.ts` contains `LlamaLog` type
  </verify>
  <done>
    - Prisma schema has LlamaLog model (not EnrichmentLog)
    - LlamaLogCategory enum exists with 5 values
    - Migration file exists with safe table rename and backfill SQL
    - `prisma validate` passes
    - Prisma client exports LlamaLog and LlamaLogCategory types
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Migration and Data Integrity</name>
  <files>
    (verification only - no file changes)
  </files>
  <action>
1. **Verify table was renamed** (not recreated):
   ```bash
   npx prisma db execute --stdin <<< "SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename IN ('enrichment_logs', 'llama_logs');"
   ```
   Should return only `llama_logs`.

2. **Verify all records have category**:
   ```bash
   npx prisma db execute --stdin <<< "SELECT COUNT(*) as total, COUNT(category) as with_category FROM llama_logs;"
   ```
   Both counts should be equal (no NULL categories).

3. **Verify category distribution** (sanity check):
   ```bash
   npx prisma db execute --stdin <<< "SELECT category, COUNT(*) FROM llama_logs GROUP BY category ORDER BY category;"
   ```
   Should show counts for ENRICHED, CORRECTED, CACHED, FAILED (CREATED likely 0 for existing records).

4. **Verify enum was created**:
   ```bash
   npx prisma db execute --stdin <<< "SELECT enumlabel FROM pg_enum WHERE enumtypid = (SELECT oid FROM pg_type WHERE typname = 'LlamaLogCategory');"
   ```
   Should return all 5 enum values.

5. **Verify index exists**:
   ```bash
   npx prisma db execute --stdin <<< "SELECT indexname FROM pg_indexes WHERE tablename = 'llama_logs' AND indexname LIKE '%category%';"
   ```
   Should return the category index.

6. **Test Prisma client imports** (quick TypeScript check):
   ```bash
   npx ts-node -e "import { LlamaLog, LlamaLogCategory } from '@prisma/client'; console.log('Types exist:', LlamaLogCategory.CREATED);"
   ```
  </action>
  <verify>
    All 6 verification queries return expected results as documented above.
  </verify>
  <done>
    - enrichment_logs table no longer exists
    - llama_logs table exists with all original records
    - Every record has a non-null category value
    - Category distribution shows sensible backfill (mostly ENRICHED)
    - LlamaLogCategory enum has all 5 values in database
    - Prisma client compiles with LlamaLog types
  </done>
</task>

</tasks>

<verification>
Run the following to confirm phase completion:

1. Schema validation: `npx prisma validate`
2. Table existence: `SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename = 'llama_logs';`
3. Category completeness: `SELECT COUNT(*) FROM llama_logs WHERE category IS NULL;` (should be 0)
4. Type generation: `grep -r "LlamaLog" node_modules/.prisma/client/index.d.ts | head -5`
</verification>

<success_criteria>
- SCHEMA-01: Prisma model renamed from EnrichmentLog to LlamaLog (verified by schema.prisma inspection)
- SCHEMA-02: Database table renamed via migration preserving all data (verified by pg_tables query)
- SCHEMA-03: LlamaLogCategory enum with 5 values (verified by pg_enum query)
- SCHEMA-04: category field added to LlamaLog model (verified by schema inspection)
- SCHEMA-05: Migration backfills existing records (verified by NULL count = 0)
</success_criteria>

<output>
After completion, create `.planning/phases/26-schema-migration/26-01-SUMMARY.md`
</output>
