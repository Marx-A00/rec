---
phase: 21-source-selection-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/toggle-group.tsx
  - src/stores/useCorrectionStore.ts
  - src/stores/useArtistCorrectionStore.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Zustand stores have correctionSource field with 'musicbrainz' default"
    - "correctionSource persists in sessionStorage across navigation"
    - "Switching sources atomically clears search state"
  artifacts:
    - path: "src/components/ui/toggle-group.tsx"
      provides: "Radix Toggle Group wrapped with shadcn styling"
      contains: "ToggleGroup"
    - path: "src/stores/useCorrectionStore.ts"
      provides: "correctionSource field and setCorrectionSource action"
      contains: "setCorrectionSource"
    - path: "src/stores/useArtistCorrectionStore.ts"
      provides: "correctionSource field and setCorrectionSource action"
      contains: "setCorrectionSource"
  key_links:
    - from: "useCorrectionStore"
      to: "sessionStorage"
      via: "partialize includes correctionSource"
      pattern: "correctionSource"
---

<objective>
Add source selection state infrastructure to both correction stores and create the Toggle Group UI primitive.

Purpose: Enable admins to select between MusicBrainz and Discogs as correction sources, with state persisting across modal interactions.

Output: 
- Toggle Group component (shadcn/ui style)
- Updated album correction store with correctionSource field
- Updated artist correction store with correctionSource field
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-source-selection-ui/21-RESEARCH.md

@src/stores/useCorrectionStore.ts
@src/stores/useArtistCorrectionStore.ts
@src/components/ui/tabs.tsx (for shadcn styling patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Toggle Group component</name>
  <files>src/components/ui/toggle-group.tsx</files>
  <action>
Create the Toggle Group component following shadcn/ui patterns.

Use npx shadcn-ui@latest add toggle-group OR create manually based on Radix UI Toggle Group:

1. Install @radix-ui/react-toggle-group if not present (check package.json first)
2. Create toggle-group.tsx with:
   - ToggleGroup (context provider, type="single" or "multiple")
   - ToggleGroupItem (individual toggle button)
   - Use cn() from @/lib/utils for class merging
   - Match styling to existing tabs.tsx for consistency

Styling should use:
- Default variant: subtle background, clear active state
- Size variants: sm, default
- Focus ring matching other UI components
- Dark theme compatible (zinc colors)

Export both ToggleGroup and ToggleGroupItem.
  </action>
  <verify>
1. File exists at src/components/ui/toggle-group.tsx
2. Exports ToggleGroup and ToggleGroupItem
3. TypeScript compiles without errors: pnpm type-check
  </verify>
  <done>Toggle Group component exists with proper Radix integration and shadcn styling</done>
</task>

<task type="auto">
  <name>Task 2: Add correctionSource to album store</name>
  <files>src/stores/useCorrectionStore.ts</files>
  <action>
Add correctionSource field and setCorrectionSource action to useCorrectionStore.

1. Define type at module level:
```typescript
export type CorrectionSource = 'musicbrainz' | 'discogs';
```

2. Add to CorrectionState interface (persisted section):
```typescript
correctionSource: CorrectionSource;
```

3. Add to DEFAULT_STATE:
```typescript
correctionSource: 'musicbrainz', // Default to MusicBrainz
```

4. Add to CorrectionActions interface:
```typescript
setCorrectionSource: (source: CorrectionSource) => void;
```

5. Add to partialize (so it persists in sessionStorage):
```typescript
correctionSource: state.correctionSource,
```

6. Implement setCorrectionSource action with ATOMIC clearing of search state:
```typescript
setCorrectionSource: (source: CorrectionSource) => {
  const current = get().correctionSource;
  if (current === source) return; // No-op if same source
  
  set({
    correctionSource: source,
    // Clear ALL search-related state atomically
    searchQuery: undefined,
    searchOffset: 0,
    selectedMbid: undefined,
    previewData: null,
    applySelections: null,
    // Keep mode unchanged - manual/search mode is separate concern
  });
}
```

Critical: The atomic clearing prevents stale MusicBrainz data from showing when Discogs is selected.
  </action>
  <verify>
1. pnpm type-check passes
2. Grep confirms: grep -n "correctionSource" src/stores/useCorrectionStore.ts
3. Grep confirms action: grep -n "setCorrectionSource" src/stores/useCorrectionStore.ts
  </verify>
  <done>Album correction store has correctionSource field with atomic source switching</done>
</task>

<task type="auto">
  <name>Task 3: Add correctionSource to artist store</name>
  <files>src/stores/useArtistCorrectionStore.ts</files>
  <action>
Mirror the same changes from Task 2 in useArtistCorrectionStore.

1. Import or define CorrectionSource type (can reuse from album store):
```typescript
import type { CorrectionSource } from './useCorrectionStore';
// OR define locally: export type CorrectionSource = 'musicbrainz' | 'discogs';
```

2. Add to ArtistCorrectionState interface (persisted section):
```typescript
correctionSource: CorrectionSource;
```

3. Add to DEFAULT_STATE:
```typescript
correctionSource: 'musicbrainz',
```

4. Add to ArtistCorrectionActions interface:
```typescript
setCorrectionSource: (source: CorrectionSource) => void;
```

5. Add to partialize:
```typescript
correctionSource: state.correctionSource,
```

6. Implement setCorrectionSource action with ATOMIC clearing (artist store fields differ slightly):
```typescript
setCorrectionSource: (source: CorrectionSource) => {
  const current = get().correctionSource;
  if (current === source) return;
  
  set({
    correctionSource: source,
    // Clear search state atomically
    searchQuery: undefined,
    searchOffset: 0,
    selectedArtistMbid: undefined, // Note: different field name
    previewData: null,
    applySelections: null,
  });
}
```

Note: Artist store uses selectedArtistMbid instead of selectedMbid.
  </action>
  <verify>
1. pnpm type-check passes
2. Grep confirms: grep -n "correctionSource" src/stores/useArtistCorrectionStore.ts
3. Both stores have consistent pattern
  </verify>
  <done>Artist correction store has correctionSource field with atomic source switching</done>
</task>

</tasks>

<verification>
1. Toggle Group component renders without errors (can test via Storybook or temp usage)
2. Both stores have correctionSource in their state interface
3. Both stores persist correctionSource in sessionStorage (check partialize)
4. setCorrectionSource clears search state in both stores
5. pnpm type-check passes
6. pnpm lint passes
</verification>

<success_criteria>
1. ToggleGroup and ToggleGroupItem components exist and are exported
2. useCorrectionStore has correctionSource (default 'musicbrainz') that persists
3. useArtistCorrectionStore has correctionSource (default 'musicbrainz') that persists
4. Switching sources clears searchQuery, selectedMbid/selectedArtistMbid, previewData, applySelections
5. All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/21-source-selection-ui/21-01-SUMMARY.md`
</output>
