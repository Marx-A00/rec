---
phase: 24-discogs-artist-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/discogs/queued-service.ts
  - src/lib/discogs/mappers.ts
  - src/lib/correction/artist/types.ts
  - src/lib/queue/processors/discogs-processor.ts
autonomous: true

must_haves:
  truths:
    - 'QueuedDiscogsService.searchArtists() method exists and calls existing DISCOGS_SEARCH_ARTIST job'
    - 'Artist search results are mapped to ArtistSearchResult format'
    - 'Discogs artist results include source field set to discogs'
  artifacts:
    - path: 'src/lib/discogs/queued-service.ts'
      provides: 'searchArtists method for Discogs artist search'
      exports: ['QueuedDiscogsService']
    - path: 'src/lib/discogs/mappers.ts'
      provides: 'Artist search result mapper'
      exports: ['mapDiscogsSearchResultToArtistSearchResult']
    - path: 'src/lib/correction/artist/types.ts'
      provides: 'Source field on ArtistSearchResult'
      contains: "source?: 'musicbrainz' | 'discogs'"
  key_links:
    - from: 'src/lib/discogs/queued-service.ts'
      to: 'src/lib/queue/jobs.ts'
      via: 'DISCOGS_SEARCH_ARTIST job type (existing)'
      pattern: 'DISCOGS_SEARCH_ARTIST'
    - from: 'src/lib/discogs/queued-service.ts'
      to: 'src/lib/discogs/mappers.ts'
      via: 'mapDiscogsSearchResultToArtistSearchResult import'
      pattern: 'mapDiscogsSearchResultToArtistSearchResult'
---

<objective>
Add Discogs artist search capability to QueuedDiscogsService.

Purpose: Enable GraphQL resolver to search Discogs for artists via rate-limited queue.
Output: searchArtists() method on QueuedDiscogsService, artist result mapper in mappers.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-discogs-artist-search/24-CONTEXT.md
@.planning/phases/24-discogs-artist-search/24-RESEARCH.md

<!-- Existing patterns to follow -->
@src/lib/discogs/queued-service.ts
@src/lib/discogs/mappers.ts
@src/lib/correction/artist/types.ts
@src/lib/queue/jobs.ts
@src/lib/queue/processors/discogs-processor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source field to ArtistSearchResult type</name>
  <files>
    src/lib/correction/artist/types.ts
  </files>
  <action>
1. In `src/lib/correction/artist/types.ts`, add an optional source field to `ArtistSearchResult` interface:

   ```typescript
   export interface ArtistSearchResult {
     // ... existing fields ...
     /** Data source this result came from (for visual distinction in UI) */
     source?: 'musicbrainz' | 'discogs';
   }
   ```

2. Add it after the `topReleases` field to maintain field ordering.

This matches the pattern in CorrectionSearchResult (album) which already has a source field.
  </action>
  <verify>
TypeScript compiles: `pnpm type-check`
  </verify>
  <done>
ArtistSearchResult interface includes optional source field for MusicBrainz/Discogs distinction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add artist search result mapper</name>
  <files>
    src/lib/discogs/mappers.ts
  </files>
  <action>
1. Add import for ArtistSearchResult type at top of file:
   ```typescript
   import type { ArtistSearchResult } from '@/lib/correction/artist/types';
   ```

2. Add a new section comment and mapper function after the existing `mapMasterToCorrectionSearchResult`:

   ```typescript
   // ============================================================================
   // Artist Correction Search Mapper
   // ============================================================================

   /**
    * Discogs search result structure (from disconnect library)
    * Search returns minimal data: id, title (name), thumb, resource_url
    */
   interface DiscogsArtistSearchResult {
     id: number;
     title: string;
     thumb?: string;
     resource_url?: string;
     type?: string;
   }

   /**
    * Map Discogs artist search result to ArtistSearchResult format
    * Used by QueuedDiscogsService for correction search results
    *
    * NOTE: Discogs search results are minimal (id, title, thumb)
    * Many fields like country, area, beginDate don't exist in search results
    */
   export function mapDiscogsSearchResultToArtistSearchResult(
     searchResult: DiscogsArtistSearchResult,
     score?: number
   ): ArtistSearchResult {
     // Discogs title may include disambiguation in parentheses: "Artist Name (2)"
     // We preserve it as-is for now; disambiguation field is separate in UI
     const name = searchResult.title;

     return {
       artistMbid: searchResult.id.toString(), // Use Discogs ID as identifier
       name: name,
       sortName: name, // Discogs doesn't have sort names
       disambiguation: undefined, // Discogs doesn't have disambiguation in search
       type: undefined, // Discogs doesn't categorize Person/Group in search
       country: undefined, // Not in search results
       area: undefined, // Not in search results
       beginDate: undefined, // Not in search results
       endDate: undefined, // Not in search results
       ended: undefined, // Not in search results
       gender: undefined, // Not in search results
       mbScore: score !== undefined ? Math.round(score * 100) : 100, // Convert 0-1 to 0-100
       topReleases: undefined, // Don't fetch releases for search results (too slow)
       source: 'discogs',
     };
   }
   ```

3. Export the new function (it will be auto-exported since it's a named export).
  </action>
  <verify>
TypeScript compiles: `pnpm type-check`
  </verify>
  <done>
mapDiscogsSearchResultToArtistSearchResult function exported from mappers.ts, maps Discogs artist search results to ArtistSearchResult format.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update DISCOGS_SEARCH_ARTIST handler to return searchResults</name>
  <files>
    src/lib/queue/processors/discogs-processor.ts
  </files>
  <action>
The existing DISCOGS_SEARCH_ARTIST handler only returns the best match (for enrichment). We need to modify it to ALSO return the full searchResults array for the correction UI to display all results.

1. Find the handleDiscogsSearchArtist function (around line 15).

2. Modify the return statements to include the raw search results:

   a) For "no_results" case (around line 77):
   ```typescript
   return {
     artistId: data.artistId,
     action: 'no_results',
     searchedName: data.artistName,
     searchResults: [], // ADD: Empty array for consistency
   };
   ```

   b) For "no_confident_match" case (around line 117):
   ```typescript
   return {
     artistId: data.artistId,
     action: 'no_confident_match',
     searchedName: data.artistName,
     resultsCount: searchResults.results.length,
     searchResults: searchResults.results, // ADD: Return all results for correction UI
   };
   ```

   c) For "found_and_queued" case (around line 184):
   ```typescript
   return {
     artistId: data.artistId,
     action: 'found_and_queued',
     discogsId: String(discogsId),
     matchConfidence: bestMatch.score,
     discogsTitle: bestMatch.result.title,
     searchResults: searchResults.results, // ADD: Return all results for correction UI
   };
   ```

3. This change is backward-compatible - existing consumers ignore extra fields, but correction UI can now access the full result list.

This follows the same pattern as DISCOGS_SEARCH_ALBUM which returns `results: []` array.
  </action>
  <verify>
TypeScript compiles: `pnpm type-check`
Grep for searchResults in return: `grep -A5 "action: 'found_and_queued'" src/lib/queue/processors/discogs-processor.ts | grep searchResults`
  </verify>
  <done>
DISCOGS_SEARCH_ARTIST handler returns searchResults array in all cases for correction UI consumption.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add searchArtists method to QueuedDiscogsService</name>
  <files>
    src/lib/discogs/queued-service.ts
  </files>
  <action>
1. Add import for the new mapper and types at top:
   ```typescript
   import { mapDiscogsSearchResultToArtistSearchResult } from '@/lib/discogs/mappers';
   import type { ArtistSearchResult } from '@/lib/correction/artist/types';
   ```

2. Add new type interfaces after existing DiscogsAlbumSearchResponse:

   ```typescript
   export interface DiscogsArtistSearchOptions {
     /** Artist name to search */
     artistName: string;
     /** Results limit (default 10) */
     limit?: number;
   }

   export interface DiscogsArtistSearchResponse {
     action: string;
     resultsCount: number;
     results: ArtistSearchResult[];
   }
   ```

3. Add searchArtists method to QueuedDiscogsService class (after getMaster method):

   ```typescript
   /**
    * Search Discogs for artists by name
    * Returns results in ArtistSearchResult format for correction UI
    *
    * Uses existing DISCOGS_SEARCH_ARTIST job type. Task 3 modified
    * the handler to return searchResults array for correction use.
    *
    * NOTE: Unlike album search which calls getMaster for each result,
    * artist search results contain enough data for display without
    * additional API calls.
    */
   async searchArtists(
     options: DiscogsArtistSearchOptions
   ): Promise<DiscogsArtistSearchResponse> {
     this.ensureInitialized();

     const { artistName, limit = 10 } = options;

     console.log(
       chalk.cyan(
         '[QueuedDiscogsService] Queuing artist search for "' + artistName + '"'
       )
     );

     try {
       // Use existing DISCOGS_SEARCH_ARTIST job type
       // Task 3 modified handler to return searchResults array
       const job = await this.queue.addJob(
         JOB_TYPES.DISCOGS_SEARCH_ARTIST,
         {
           // Job requires artistId for logging - use dummy for admin search
           artistId: 'admin-search-' + Date.now(),
           artistName,
           requestId: 'discogs-artist-search-' + Date.now(),
         },
         {
           priority: PRIORITY_TIERS.ADMIN,
           requestId: 'discogs-artist-search-' + artistName,
         }
       );

       const result = await this.waitForJobViaEvents(job.id!) as {
         searchResults?: Array<{ id: number; title: string; thumb?: string }>;
         action?: string;
         resultsCount?: number;
       };

       // Extract search results from job result (now returned by Task 3 modification)
       const searchResults = result.searchResults || [];

       // Map to ArtistSearchResult format
       const mappedResults = searchResults
         .slice(0, limit)
         .map(r => mapDiscogsSearchResultToArtistSearchResult(r));

       return {
         action: 'search_complete',
         resultsCount: mappedResults.length,
         results: mappedResults,
       };
     } catch (error) {
       console.error('[QueuedDiscogsService] Artist search failed:', error);
       throw new Error(
         'Failed to search Discogs artists: ' +
           (error instanceof Error ? error.message : 'Unknown error')
       );
     }
   }
   ```

4. The method uses existing DISCOGS_SEARCH_ARTIST job type (modified in Task 3), maps results via the mapper from Task 2, and returns in the expected format for the GraphQL resolver.
  </action>
  <verify>
TypeScript compiles: `pnpm type-check`
File contains searchArtists method: `grep -q "searchArtists" src/lib/discogs/queued-service.ts`
  </verify>
  <done>
QueuedDiscogsService.searchArtists() method implemented, calls DISCOGS_SEARCH_ARTIST job, maps results to ArtistSearchResult format.
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes with no errors
2. `pnpm lint` passes (or only unrelated warnings)
3. ArtistSearchResult has source field
4. mapDiscogsSearchResultToArtistSearchResult exported from mappers.ts
5. QueuedDiscogsService.searchArtists method exists
6. searchArtists uses JOB_TYPES.DISCOGS_SEARCH_ARTIST (existing job)
</verification>

<success_criteria>
- QueuedDiscogsService has searchArtists() method
- Method uses existing DISCOGS_SEARCH_ARTIST queue job (no new job type)
- Results mapped to ArtistSearchResult format with source: 'discogs'
- All types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-discogs-artist-search/24-01-SUMMARY.md`
</output>
