---
phase: 17-graphql-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graphql/schema.graphql
  - src/graphql/queries/enrichment.graphql
autonomous: true

must_haves:
  truths:
    - 'EnrichmentLog type has parentJobId field exposed in GraphQL'
    - 'EnrichmentLog type has children array field for nested logs'
    - 'enrichmentLogs query accepts includeChildren parameter'
    - 'Client query includes jobId and parentJobId in selection set'
  artifacts:
    - path: 'src/graphql/schema.graphql'
      provides: 'EnrichmentLog type with parentJobId and children fields'
      contains: 'parentJobId: String'
    - path: 'src/graphql/queries/enrichment.graphql'
      provides: 'Client query with new fields'
      contains: 'parentJobId'
  key_links:
    - from: 'src/graphql/schema.graphql'
      to: 'prisma/schema.prisma'
      via: 'field mapping'
      pattern: 'parentJobId'
---

<objective>
Add `parentJobId` field and `children` array to EnrichmentLog GraphQL type, and add `includeChildren` parameter to enrichmentLogs query.

Purpose: Enable clients to fetch enrichment logs with parent-child relationships for timeline display.
Output: Updated schema.graphql with new fields, updated enrichment.graphql client query.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-graphql-layer/17-RESEARCH.md

@src/graphql/schema.graphql
@src/graphql/queries/enrichment.graphql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update EnrichmentLog type in schema</name>
  <files>src/graphql/schema.graphql</files>
  <action>
Add two new fields to the `EnrichmentLog` type:

1. After `jobId: String`, add:

   ```graphql
   parentJobId: String  # Links child job to parent job for tree display
   ```

2. After the `createdAt: DateTime!` field (at end of type), add:
   ```graphql
   children: [EnrichmentLog!]  # Populated when includeChildren=true
   ```

Note: `children` is nullable (not `!`) because it's only populated conditionally.
</action>
<verify>grep -E "(parentJobId|children:.\*EnrichmentLog)" src/graphql/schema.graphql</verify>
<done>EnrichmentLog type has `parentJobId: String` and `children: [EnrichmentLog!]` fields</done>
</task>

<task type="auto">
  <name>Task 2: Add includeChildren parameter to enrichmentLogs query</name>
  <files>src/graphql/schema.graphql</files>
  <action>
Find the `enrichmentLogs` query in the Query type and add the `includeChildren` parameter:

Before:

```graphql
enrichmentLogs(
  entityType: EnrichmentEntityType
  entityId: UUID
  status: EnrichmentLogStatus
  sources: [String!]
  skip: Int
  limit: Int
): [EnrichmentLog!]!
```

After:

```graphql
enrichmentLogs(
  entityType: EnrichmentEntityType
  entityId: UUID
  status: EnrichmentLogStatus
  sources: [String!]
  skip: Int
  limit: Int
  includeChildren: Boolean  # When true, returns root logs with nested children
): [EnrichmentLog!]!
```

Default behavior (includeChildren not provided or false): Returns flat list as before.
New behavior (includeChildren=true): Returns only root logs with children array populated.
</action>
<verify>grep -A 10 "enrichmentLogs(" src/graphql/schema.graphql | grep includeChildren</verify>
<done>enrichmentLogs query accepts `includeChildren: Boolean` parameter</done>
</task>

<task type="auto">
  <name>Task 3: Update client query to include new fields</name>
  <files>src/graphql/queries/enrichment.graphql</files>
  <action>
Update the `GetEnrichmentLogs` query to:

1. Add `includeChildren` to query variables and arguments
2. Add `jobId` and `parentJobId` to the selection set (jobId may already be there, parentJobId is new)
3. Do NOT add children to the selection set yet - that will be a separate query variant

Updated query:

```graphql
query GetEnrichmentLogs(
  $entityType: EnrichmentEntityType
  $entityId: UUID
  $status: EnrichmentLogStatus
  $skip: Int
  $limit: Int
  $includeChildren: Boolean
) {
  enrichmentLogs(
    entityType: $entityType
    entityId: $entityId
    status: $status
    skip: $skip
    limit: $limit
    includeChildren: $includeChildren
  ) {
    id
    entityType
    entityId
    operation
    sources
    status
    reason
    fieldsEnriched
    dataQualityBefore
    dataQualityAfter
    errorMessage
    errorCode
    durationMs
    apiCallCount
    metadata
    createdAt
    jobId
    parentJobId
  }
}
```

Also add a new query variant for fetching logs with children:

```graphql
query GetEnrichmentLogsWithChildren(
  $entityType: EnrichmentEntityType
  $entityId: UUID
  $status: EnrichmentLogStatus
  $skip: Int
  $limit: Int
) {
  enrichmentLogs(
    entityType: $entityType
    entityId: $entityId
    status: $status
    skip: $skip
    limit: $limit
    includeChildren: true
  ) {
    id
    entityType
    entityId
    operation
    sources
    status
    reason
    fieldsEnriched
    dataQualityBefore
    dataQualityAfter
    errorMessage
    errorCode
    durationMs
    apiCallCount
    metadata
    createdAt
    jobId
    parentJobId
    children {
      id
      entityType
      entityId
      operation
      sources
      status
      reason
      fieldsEnriched
      errorMessage
      errorCode
      durationMs
      apiCallCount
      createdAt
      jobId
      parentJobId
    }
  }
}
```

  </action>
  <verify>grep -E "(parentJobId|includeChildren|GetEnrichmentLogsWithChildren)" src/graphql/queries/enrichment.graphql</verify>
  <done>Client queries include parentJobId field and includeChildren parameter, with dedicated query for tree fetch</done>
</task>

</tasks>

<verification>
1. `grep "parentJobId: String" src/graphql/schema.graphql` returns the field
2. `grep "children: \[EnrichmentLog" src/graphql/schema.graphql` returns the field
3. `grep "includeChildren" src/graphql/schema.graphql` shows parameter in query
4. `grep "parentJobId" src/graphql/queries/enrichment.graphql` shows field in selection
5. Schema is syntactically valid (will be verified by codegen in Plan 02)
</verification>

<success_criteria>

- GQL-01 met: EnrichmentLog type has jobId field (already existed, verified)
- GQL-02 met: EnrichmentLog type has parentJobId field (newly added)
- GQL-03 met: enrichmentLogs query has includeChildren parameter
- Schema changes ready for codegen
- Client query ready for codegen
  </success_criteria>

<output>
After completion, create `.planning/phases/17-graphql-layer/17-01-SUMMARY.md`
</output>
