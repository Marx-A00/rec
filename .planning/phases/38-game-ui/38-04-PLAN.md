---
phase: 38-game-ui
plan: 04
type: execute
wave: 3
depends_on: ["38-01", "38-02"]
files_modified:
  - src/components/uncover/UncoverGame.tsx
  - src/components/uncover/AlbumGuessInput.tsx
  - src/components/uncover/RevealImage.tsx
  - src/app/m/game/MobileGameClient.tsx
autonomous: true

must_haves:
  truths:
    - "Image processing shows loading state during reveal transitions"
    - "Enter key submits highlighted guess in dropdown"
    - "Tab key navigates through dropdown items"
    - "Escape key closes dropdown"
  artifacts:
    - path: "src/components/uncover/AlbumGuessInput.tsx"
      provides: "Keyboard-accessible autocomplete"
      contains: "onKeyDown handler"
    - path: "src/components/uncover/RevealImage.tsx"
      provides: "Loading state during image load"
  key_links:
    - from: "AlbumGuessInput"
      to: "cmdk Command"
      via: "keyboard events (Enter, Tab, Escape)"
---

<objective>
Add loading states for image transitions and ensure full keyboard accessibility.

Purpose: Polish the user experience with proper loading feedback and keyboard-only playability for accessibility.

Output: Loading states during image reveal, full keyboard support (Enter, Tab, Escape), smooth transitions.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-game-ui/38-CONTEXT.md
@.planning/phases/38-game-ui/38-01-SUMMARY.md
@.planning/phases/38-game-ui/38-02-SUMMARY.md

Key existing files:
@src/components/uncover/AlbumGuessInput.tsx
@src/components/uncover/RevealImage.tsx
@src/components/uncover/UncoverGame.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loading states for image reveal transitions</name>
  <files>
    src/components/uncover/RevealImage.tsx
    src/components/uncover/UncoverGame.tsx
    src/app/m/game/MobileGameClient.tsx
  </files>
  <action>
1. Update RevealImage.tsx to show loading state:
   - The component already has `onLoad` and `onError` props
   - Add internal loading state that shows during image load
   
   ```tsx
   // Add to RevealImage component
   const [isImageLoading, setIsImageLoading] = useState(true);
   
   // Reset loading state when imageUrl changes
   useEffect(() => {
     setIsImageLoading(true);
   }, [imageUrl]);
   
   const handleLoad = () => {
     setIsImageLoading(false);
     onLoad?.();
   };
   
   // Render loading overlay when image is loading
   return (
     <div className={`relative ${className ?? ''}`}>
       {/* Loading skeleton overlay */}
       {isImageLoading && (
         <div className="absolute inset-0 z-10 flex items-center justify-center bg-zinc-900 rounded-lg">
           <div className="animate-pulse">
             <div className="h-8 w-8 rounded-full border-2 border-zinc-700 border-t-zinc-400 animate-spin" />
           </div>
         </div>
       )}
       
       {/* Actual reveal content */}
       {preferredStyle === 'pixelation' ? (
         <RevealCanvas {...sharedProps} onLoad={handleLoad} />
       ) : (
         <RevealBlur {...sharedProps} onLoad={handleLoad} />
       )}
       
       {/* Toggle button */}
       {showToggle && !isImageLoading && (
         <button ...>
           ...
         </button>
       )}
     </div>
   );
   ```

2. Add transition effect when stage changes:
   - Brief fade or opacity transition when revealing more
   - CSS transition: `transition-opacity duration-300`
   
   ```tsx
   // Add to the reveal content wrapper
   <div className={`transition-opacity duration-200 ${isImageLoading ? 'opacity-0' : 'opacity-100'}`}>
     {preferredStyle === 'pixelation' ? ...}
   </div>
   ```

3. Ensure RevealCanvas and RevealBlur call onLoad callback:
   - Check that these components properly call the onLoad prop when image finishes loading
   - If not implemented, the image's onLoad event should trigger it

4. In UncoverGame.tsx, add loading state for guess submission:
   - Already has `game.isSubmitting` state
   - Show subtle loading indicator on the reveal image when submitting
   
   ```tsx
   {/* Add loading overlay during submission */}
   {game.isSubmitting && (
     <div className="absolute inset-0 z-20 flex items-center justify-center bg-black/30 rounded-lg">
       <div className="h-6 w-6 rounded-full border-2 border-white/30 border-t-white animate-spin" />
     </div>
   )}
   ```

5. Apply same patterns to MobileGameClient.tsx
  </action>
  <verify>
    - `pnpm type-check` passes
    - Loading spinner shows briefly when image first loads
    - Smooth transition when stage changes
    - Loading indicator during guess submission
  </verify>
  <done>
    - UI-03 satisfied: Loading states for image processing
    - Spinner shows during initial image load
    - Smooth transitions between reveal stages
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure full keyboard support for autocomplete</name>
  <files>src/components/uncover/AlbumGuessInput.tsx</files>
  <action>
Verify and enhance keyboard support in AlbumGuessInput:

1. Enter key behavior (should already work via cmdk):
   - Verify that pressing Enter on a highlighted item submits the guess
   - cmdk handles this by default with `onSelect` callback
   - Ensure the input doesn't trigger form submission (no parent form, or `e.preventDefault()`)

2. Tab key behavior:
   - By default, Tab moves focus out of the component
   - For game UX, consider keeping focus within dropdown while it's open
   - Alternative: Let Tab work naturally (move to Skip button, then out)
   - Implement: Let Tab work naturally - users can Tab to Skip button
   
3. Escape key to close dropdown:
   - Add keydown handler to CommandInput:
   ```tsx
   <CommandInput
     ...
     onKeyDown={(e) => {
       if (e.key === 'Escape') {
         setIsOpen(false);
         e.currentTarget.blur();
       }
     }}
   />
   ```

4. Arrow keys for navigation:
   - cmdk handles up/down arrow navigation automatically
   - Verify this works

5. Focus management:
   - When dropdown opens, focus should stay in input
   - When item is selected, input should clear and refocus
   - After selection/submission, consider moving focus to a logical place
   
   ```tsx
   const inputRef = useRef<HTMLInputElement>(null);
   
   const handleSelect = (album) => {
     onGuess(album.id, album.title, artistName);
     setInputValue('');
     setIsOpen(false);
     // Optionally refocus input for next guess (if not game over)
     inputRef.current?.focus();
   };
   ```

6. Screen reader considerations:
   - Add aria-label to input: "Search for an album to guess"
   - Add aria-expanded to indicate dropdown state
   - cmdk provides aria attributes by default, verify they're present

7. Test keyboard flow:
   - Type to search -> use arrows to navigate -> Enter to select
   - Type to search -> Escape to close -> Tab to Skip button
   - Full game playable without mouse
  </action>
  <verify>
    - `pnpm type-check` passes
    - Play full game using only keyboard:
      - Type album name
      - Use arrow keys to navigate dropdown
      - Press Enter to submit guess
      - Press Escape to close dropdown
      - Tab to Skip button, Enter to skip
  </verify>
  <done>
    - UI-05 satisfied: Keyboard support for guess input
    - Enter submits highlighted guess
    - Escape closes dropdown
    - Arrow keys navigate dropdown (via cmdk)
    - Tab moves to Skip button
  </done>
</task>

<task type="auto">
  <name>Task 3: Add focus ring and visual feedback for keyboard navigation</name>
  <files>
    src/components/uncover/AlbumGuessInput.tsx
    src/components/uncover/UncoverGame.tsx
  </files>
  <action>
Enhance visual feedback for keyboard users:

1. Input focus ring:
   - Ensure CommandInput has visible focus ring
   - Add `focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 focus-visible:ring-offset-zinc-900`

2. Dropdown item highlight:
   - cmdk provides `data-selected` attribute on highlighted item
   - Ensure CSS shows clear highlight: `data-[selected=true]:bg-zinc-700`
   - Verify contrast is sufficient

3. Skip button focus:
   - Add visible focus ring to Skip button
   - `focus-visible:ring-2 focus-visible:ring-zinc-500 focus-visible:outline-none`

4. Game-over state focus:
   - When game ends, move focus to a reasonable element
   - Could be the "Come back tomorrow" message or a heading
   - Add `tabIndex={0}` to focusable element if needed

5. Loading state during submission:
   - Disable input during submission (already done via `disabled` prop)
   - Add visual indication that input is disabled
   - `disabled:opacity-50 disabled:cursor-not-allowed`

6. Test with keyboard:
   - Tab through all interactive elements
   - Verify focus ring is visible on each
   - Verify no focus traps
  </action>
  <verify>
    - `pnpm type-check` passes
    - Tab through page - all interactive elements have visible focus
    - Arrow through dropdown - highlighted item is clearly visible
    - No focus traps - can Tab out of component
  </verify>
  <done>
    - Clear focus rings on all interactive elements
    - Dropdown highlights are visible
    - No focus traps
    - Full keyboard accessibility
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm type-check` - no type errors
2. `pnpm lint` - passes
3. Manual test - loading states:
   - Refresh page - see loading spinner on image
   - Submit guess - see brief loading indicator
   - Stage transition is smooth
4. Manual test - keyboard (no mouse):
   - Tab to search input
   - Type to search
   - Arrow down to navigate results
   - Enter to select and submit
   - See guess appear
   - Tab to Skip button
   - Enter to skip
   - Complete full game with keyboard only
5. Test on mobile - verify touch interactions still work
</verification>

<success_criteria>
- UI-03 satisfied: Loading states for image processing
- UI-05 satisfied: Keyboard support for guess input
- Spinner/skeleton during image load
- Smooth transitions between reveal stages
- Enter submits guess, Tab navigates, Escape closes dropdown
- Visible focus rings for keyboard users
- Full game playable with keyboard only
</success_criteria>

<output>
After completion, create `.planning/phases/38-game-ui/38-04-SUMMARY.md`
</output>
