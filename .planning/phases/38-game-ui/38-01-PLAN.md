---
phase: 38-game-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(main)/game/page.tsx
  - src/components/uncover/AlbumGuessInput.tsx
  - src/components/uncover/GuessList.tsx
  - src/components/uncover/AttemptDots.tsx
  - src/components/uncover/UncoverGame.tsx
autonomous: true

must_haves:
  truths:
    - "Typing in guess field shows autocomplete dropdown with album + artist"
    - "Selecting a result auto-submits the guess"
    - "Previous guesses display as stacked list with album + artist"
    - "Attempt progress shown as 6 dots (filled = used)"
  artifacts:
    - path: "src/app/(main)/game/page.tsx"
      provides: "Desktop game route"
    - path: "src/components/uncover/AlbumGuessInput.tsx"
      provides: "Autocomplete search input component"
      exports: ["AlbumGuessInput"]
    - path: "src/components/uncover/GuessList.tsx"
      provides: "Previous guesses display"
      exports: ["GuessList"]
    - path: "src/components/uncover/AttemptDots.tsx"
      provides: "Visual attempt counter"
      exports: ["AttemptDots"]
  key_links:
    - from: "src/components/uncover/AlbumGuessInput.tsx"
      to: "useSearchAlbumsQuery"
      via: "GraphQL query for local DB search"
    - from: "src/components/uncover/AlbumGuessInput.tsx"
      to: "useUncoverGame.submitGuess"
      via: "onSelect callback triggers submission"
    - from: "src/app/(main)/game/page.tsx"
      to: "UncoverGame"
      via: "renders game container"
---

<objective>
Wire up the playable desktop game route with album search autocomplete.

Purpose: Get a testable game loop in the browser ASAP. User can navigate to /game, see the obscured album, type to search, select an album, and see the guess result.

Output: Desktop game route at /game with working autocomplete search, guess submission, previous guesses display, and attempt dots indicator.
</objective>

<execution_context>
@/Users/marcosandrade/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marcosandrade/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-game-ui/38-CONTEXT.md

Key existing files:
@src/components/uncover/UncoverGame.tsx
@src/hooks/useUncoverGame.ts
@src/components/ui/command.tsx
@src/generated/graphql.ts (useSearchAlbumsQuery)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create desktop game route and supporting UI components</name>
  <files>
    src/app/(main)/game/page.tsx
    src/components/uncover/AttemptDots.tsx
    src/components/uncover/GuessList.tsx
  </files>
  <action>
1. Create `src/app/(main)/game/page.tsx`:
   - Server component that renders `<UncoverGame />`
   - Page metadata: title "Daily Challenge | Uncover"
   - Simple wrapper with centered layout container

2. Create `src/components/uncover/AttemptDots.tsx`:
   - Props: `attemptCount: number` (0-6), `maxAttempts?: number` (default 6)
   - Render 6 dots in a flex row with gap-2
   - Filled dots (bg-zinc-400) for used attempts, empty dots (border-2 border-zinc-600) for remaining
   - Each dot is a small circle (w-3 h-3 rounded-full)
   - Export as named export

3. Create `src/components/uncover/GuessList.tsx`:
   - Props: `guesses: Array<{ guessNumber: number; albumId: string | null; albumTitle: string; artistName: string; isCorrect: boolean }>`
   - Map over guesses, render each as a row with album title + artist name
   - Styling: stacked list, each row has border-b border-zinc-700, py-2
   - Show "(skipped)" for null albumId entries
   - Each row: album title in font-medium, artist in text-sm text-zinc-400
   - Wrong guesses get a subtle red-ish indicator (text-red-400 "X" on right)
   - Correct guess (if any) gets green indicator (text-green-400 checkmark)
   - Export as named export
  </action>
  <verify>
    - `pnpm type-check` passes
    - Files exist at specified paths
    - Components export correctly
  </verify>
  <done>
    - Game route exists at /game (desktop)
    - AttemptDots renders 6 dots with filled/empty based on attemptCount
    - GuessList renders previous guesses with album + artist
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AlbumGuessInput autocomplete component</name>
  <files>src/components/uncover/AlbumGuessInput.tsx</files>
  <action>
Create `src/components/uncover/AlbumGuessInput.tsx`:

1. Props interface:
   - `onGuess: (albumId: string, albumTitle: string, artistName: string) => void`
   - `onSkip: () => void`
   - `disabled?: boolean`
   - `isSubmitting?: boolean`

2. State management:
   - `inputValue: string` - controlled input value
   - `isOpen: boolean` - dropdown visibility
   - Use `useSearchAlbumsQuery` from `@/generated/graphql` with:
     - variables: `{ query: inputValue, limit: 5 }`
     - enabled: `inputValue.length >= 2`
   - Debounce search with 300ms delay (use useState + useEffect pattern or useDeferredValue)

3. Component structure (use cmdk Command components from @/components/ui/command):
   ```tsx
   <div className="relative w-full">
     <Command shouldFilter={false} className="...">
       <CommandInput 
         placeholder="Search for an album..."
         value={inputValue}
         onValueChange={setInputValue}
         onFocus={() => setIsOpen(true)}
       />
       {isOpen && inputValue.length >= 2 && (
         <CommandList className="absolute top-full left-0 right-0 z-50 mt-1 border rounded-md bg-zinc-900 shadow-lg">
           {isLoading ? (
             <CommandEmpty>Searching...</CommandEmpty>
           ) : results.length === 0 ? (
             <CommandEmpty>No albums found</CommandEmpty>
           ) : (
             <CommandGroup>
               {results.map(album => (
                 <CommandItem 
                   key={album.id}
                   value={album.id}
                   onSelect={() => handleSelect(album)}
                 >
                   <div>
                     <div className="font-medium">{album.title}</div>
                     <div className="text-sm text-zinc-400">{artistName}</div>
                   </div>
                 </CommandItem>
               ))}
             </CommandGroup>
           )}
         </CommandList>
       )}
     </Command>
     <button onClick={onSkip} disabled={disabled || isSubmitting}>
       Skip
     </button>
   </div>
   ```

4. Selection handler:
   - On select: call `onGuess(album.id, album.title, artistName)`
   - Clear input and close dropdown after selection
   - Extract artist name from `album.artists[0].artist.name` (handle null safely)

5. Keyboard support:
   - Enter on highlighted item submits (handled by cmdk)
   - Escape closes dropdown: `onKeyDown` handler sets `isOpen = false`
   - Click outside closes dropdown: use effect with document click listener

6. Skip button:
   - Position below or next to input (flex layout)
   - Styling: border border-zinc-600 rounded-md px-4 py-2 hover:bg-zinc-800
   - Shows "Skipping..." when isSubmitting

7. Double-submission guard:
   - Disable input and skip button when `disabled` or `isSubmitting` is true
  </action>
  <verify>
    - `pnpm type-check` passes
    - Component renders without errors in isolation
    - useSearchAlbumsQuery is imported from generated graphql
  </verify>
  <done>
    - AlbumGuessInput renders search input with autocomplete dropdown
    - Typing 2+ chars triggers search query
    - Selecting result calls onGuess with album details
    - Skip button calls onSkip
    - Keyboard escape closes dropdown
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into UncoverGame container</name>
  <files>src/components/uncover/UncoverGame.tsx</files>
  <action>
Update `src/components/uncover/UncoverGame.tsx`:

1. Import new components:
   ```tsx
   import { AlbumGuessInput } from './AlbumGuessInput';
   import { GuessList } from './GuessList';
   import { AttemptDots } from './AttemptDots';
   ```

2. In the IN_PROGRESS game board section (around line 140+), replace the placeholder div with real components:

   REMOVE:
   ```tsx
   {/* Placeholder for album search input (to be added in Phase 38) */}
   <div className="w-full max-w-md rounded-md border-2 border-dashed ...">
     Album search input will be added in Phase 38
   </div>
   ```

   ADD (restructure the game board layout):
   ```tsx
   {/* Game board for IN_PROGRESS sessions */}
   return (
     <div className="flex min-h-[400px] flex-col items-center gap-6 p-4 md:p-8">
       {/* Header */}
       <div className="text-center">
         <h2 className="mb-1 text-xl md:text-2xl font-bold">Daily Uncover</h2>
         <p className="text-sm text-muted-foreground">
           Guess the album from the cover art
         </p>
       </div>
       
       {/* Reveal image - large and dominant */}
       {challengeImageUrl && (
         <div className="w-full max-w-md">
           <RevealImage
             imageUrl={challengeImageUrl}
             cloudflareImageId={challengeImageId}
             challengeId={game.challengeId ?? 'unknown'}
             stage={game.revealStage}
             className="aspect-square w-full overflow-hidden rounded-lg"
           />
         </div>
       )}
       
       {/* Attempt dots indicator */}
       <AttemptDots attemptCount={game.attemptCount} />
       
       {/* Search input */}
       <div className="w-full max-w-md">
         <AlbumGuessInput
           onGuess={game.submitGuess}
           onSkip={game.skipGuess}
           disabled={game.isGameOver}
           isSubmitting={game.isSubmitting}
         />
       </div>
       
       {/* Previous guesses */}
       {game.guesses.length > 0 && (
         <div className="w-full max-w-md">
           <GuessList guesses={game.guesses} />
         </div>
       )}
       
       {/* Error display */}
       {game.error && (
         <div className="w-full max-w-md rounded-md border border-red-500/50 bg-red-950/20 p-4 text-center text-red-400">
           {game.error}
         </div>
       )}
     </div>
   );
   ```

3. In the game over section, also use GuessList component to show all guesses (already exists but ensure consistent styling).

4. Update the "Attempt counter" section to use AttemptDots instead of text:
   - Remove the old "Attempt X / 6" and "Stage X of 6" text display
   - AttemptDots is already added above

5. Keep the skip button inside AlbumGuessInput (not separate).
  </action>
  <verify>
    - `pnpm type-check` passes
    - `pnpm lint` passes (or only pre-existing warnings)
    - Navigate to http://localhost:3000/game and verify:
      - Page loads without errors
      - Obscured image displays
      - Attempt dots show
      - Search input appears
      - Typing triggers autocomplete
  </verify>
  <done>
    - UncoverGame integrates AlbumGuessInput, GuessList, and AttemptDots
    - Placeholder removed
    - Full game loop is testable in browser
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm type-check` - no type errors
2. `pnpm lint` - passes or only pre-existing warnings
3. Manual test:
   - Navigate to /game while logged in
   - See obscured album image
   - See 6 empty dots
   - Type in search field, see dropdown with results
   - Select an album, see guess submitted
   - See guess appear in GuessList
   - See one dot fill in
   - Click Skip, see another dot fill
   - Continue until game over
</verification>

<success_criteria>
- Desktop game route exists at /game
- AlbumGuessInput shows autocomplete dropdown with album + artist (text only)
- Selecting result auto-submits guess
- GuessList displays previous guesses
- AttemptDots shows visual progress (6 dots)
- Full game loop playable in browser
</success_criteria>

<output>
After completion, create `.planning/phases/38-game-ui/38-01-SUMMARY.md`
</output>
