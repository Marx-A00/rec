---
phase: 08-preview-ui
plan: 03
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/components/admin/correction/preview/TrackComparison.tsx
  - src/components/admin/correction/preview/CoverArtComparison.tsx
  - src/components/admin/correction/preview/PreviewView.tsx
  - src/components/admin/correction/preview/index.ts
  - src/components/admin/correction/CorrectionModal.tsx
autonomous: true

must_haves:
  truths:
    - 'Track listing shows position-aligned comparison with diff highlighting'
    - 'Cover art displays side-by-side with change indicator'
    - 'Preview step (step 2) in modal shows full comparison'
    - 'Back button from preview returns to search with preserved state'
  artifacts:
    - path: 'src/components/admin/correction/preview/TrackComparison.tsx'
      provides: 'Track-by-track comparison with title diffs'
      min_lines: 80
    - path: 'src/components/admin/correction/preview/CoverArtComparison.tsx'
      provides: 'Side-by-side cover art display'
      min_lines: 40
    - path: 'src/components/admin/correction/preview/PreviewView.tsx'
      provides: 'Complete preview with all sections'
      min_lines: 120
  key_links:
    - from: 'src/components/admin/correction/CorrectionModal.tsx'
      to: 'PreviewView'
      via: 'step 2 render'
      pattern: 'currentStep === 2.*PreviewView'
---

<objective>
Complete the preview UI with track comparison, cover art, and modal integration.

Purpose: Delivers the full preview experience - admin can see tracks, cover art, and all field diffs side-by-side.
Output: Complete working preview step in the correction modal wizard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-preview-ui/08-CONTEXT.md
@.planning/phases/08-preview-ui/08-RESEARCH.md
@.planning/phases/08-preview-ui/08-01-SUMMARY.md
@.planning/phases/08-preview-ui/08-02-SUMMARY.md

# Existing components

@src/components/admin/correction/CorrectionModal.tsx
@src/components/admin/correction/TrackListing.tsx
@src/hooks/useCorrectionModalState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrackComparison component</name>
  <files>
    src/components/admin/correction/preview/TrackComparison.tsx
  </files>
  <action>
**TrackComparison.tsx:**

Props interface - matches GraphQL TrackDiff and TrackListSummary:

```typescript
interface TrackDiff {
  position: number;
  discNumber: number;
  changeType: 'MATCH' | 'MODIFIED' | 'ADDED' | 'REMOVED';
  current?: {
    title: string;
    durationMs: number | null;
    trackNumber: number;
  } | null;
  source?: {
    title: string;
    durationMs: number | null;
    mbid?: string | null;
  } | null;
  titleDiff?: TextDiffPart[] | null;
  durationDelta?: number | null;
}

interface TrackListSummary {
  totalCurrent: number;
  totalSource: number;
  matching: number;
  modified: number;
  added: number;
  removed: number;
}

interface TrackComparisonProps {
  trackDiffs: TrackDiff[];
  summary: TrackListSummary;
}
```

Implementation:

1. **Summary header**:
   - Show counts: "{matching} matching, {modified} modified, {added} added, {removed} removed"
   - Use text-zinc-400 for label parts, highlight counts:
     - matching: text-zinc-300
     - modified: text-yellow-400
     - added: text-green-400
     - removed: text-red-400

2. **Track list**:
   - Two-column grid: current track | source track
   - Each row shows: position, title, duration

3. **Track row rendering** per changeType:
   - **MATCH**: Both sides rendered normally (text-zinc-300)
   - **MODIFIED**: Both sides, source title uses InlineTextDiff if titleDiff exists
   - **ADDED**: Left side shows "—", right side green (text-green-400)
   - **REMOVED**: Right side shows "—", left side red with opacity-50

4. **Duration formatting**:
   - Helper: `formatDuration(ms: number | null)` -> "3:45" or "—"
   - Show in text-zinc-500, smaller text

5. **Collapse threshold** (from Phase 6 decision):
   - AUTO_COLLAPSE_THRESHOLD = 30
   - COLLAPSED_TRACK_COUNT = 10
   - If total tracks >= 30, show first 10 with "Show all N tracks" button
   - Use useState for showAll toggle

6. **Empty state**: If no trackDiffs, show "No track data available" in text-zinc-500
   </action>
   <verify>
   TypeScript compiles: `pnpm type-check`
   Track rows show correct styling per change type.
   </verify>
   <done>
   TrackComparison renders position-aligned track list with title diffs and summary stats.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Create CoverArtComparison and assemble PreviewView</name>
  <files>
    src/components/admin/correction/preview/CoverArtComparison.tsx
    src/components/admin/correction/preview/PreviewView.tsx
    src/components/admin/correction/preview/index.ts
  </files>
  <action>
**CoverArtComparison.tsx:**

Props interface:

```typescript
interface CoverArtComparisonProps {
  currentUrl: string | null;
  sourceUrl: string | null;
  changeType: 'ADDED' | 'MODIFIED' | 'REMOVED' | 'UNCHANGED';
  currentCloudflareId?: string | null;
}
```

Implementation:

- Side-by-side cover art display (128x128 each)
- Use AlbumImage component for current (supports cloudflareImageId)
- Use Next/Image or img for source (external CAA URL)
- Show change badge below if not UNCHANGED:
  - ADDED: "New cover art available" in green
  - MODIFIED: "Cover art differs" in yellow
  - REMOVED: "Cover art would be removed" in red
- Fallback to placeholder div with bg-zinc-800 if URL is null

**Update PreviewView.tsx:**

Transform from placeholder to complete preview:

1. **Import all components**:
   - ComparisonLayout, PreviewSkeleton (existing)
   - FieldComparisonList, InlineTextDiff (from 08-02)
   - TrackComparison, CoverArtComparison (from this task)
   - Accordion, AccordionItem, AccordionTrigger, AccordionContent from shadcn/ui

2. **Header section** (above accordion):
   - CoverArtComparison side-by-side at top
   - Album title + artist display (from preview data)

3. **Accordion sections** (default expanded for sections with changes):
   - **Basic Info**: FieldComparisonList with fieldDiffs + artistDiff
   - **Tracks**: TrackComparison with trackDiffs + trackSummary
   - **External IDs**: Subset of fieldDiffs where field matches external ID pattern

4. **Change summary badge** in accordion triggers:
   - "({N} changes)" next to section title if section has changes
   - Use text-yellow-400 for visibility

5. **Default expanded logic**:
   - Expand sections that have changes (based on summary counts)
   - Sections with no changes can default to collapsed

6. **Styling**: Follow CurrentDataView patterns exactly
   - AccordionItem: border-zinc-700
   - AccordionTrigger: text-zinc-200 hover:text-zinc-100 hover:no-underline
   - Content padding and spacing

**Update index.ts:**

- Export TrackComparison, CoverArtComparison
  </action>
  <verify>
  TypeScript compiles: `pnpm type-check`
  ESLint passes: `pnpm lint`
  PreviewView renders all sections with correct data from GraphQL.
  </verify>
  <done>
  PreviewView shows complete comparison: cover art, fields, artist, tracks in accordion layout.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Integrate PreviewView into CorrectionModal</name>
  <files>
    src/components/admin/correction/CorrectionModal.tsx
  </files>
  <action>
**Update CorrectionModal.tsx:**

1. **Import PreviewView**:

   ```typescript
   import { PreviewView } from './preview';
   ```

2. **Step 2 rendering** (replace placeholder):
   - Render PreviewView when `currentStep === 2` and `selectedResultMbid` exists
   - Pass props: `albumId={albumId!}` and `releaseGroupMbid={selectedResultMbid}`
   - Show error if step 2 but no selectedResultMbid (shouldn't happen, but guard)

3. **Guard logic**:

   ```typescript
   {currentStep === 2 && !isLoading && !hasError && modalState.selectedResultMbid && (
     <PreviewView
       albumId={albumId!}
       releaseGroupMbid={modalState.selectedResultMbid}
     />
   )}
   {currentStep === 2 && !isLoading && !hasError && !modalState.selectedResultMbid && (
     <div className="text-center text-zinc-500 py-8">
       No result selected. Please go back and select a search result.
     </div>
   )}
   ```

4. **Back navigation** (already works via existing prevStep):
   - prevStep returns to step 1 (search)
   - searchQuery and searchOffset are already persisted in modalState
   - No additional changes needed - state preservation is already implemented

5. **Footer button text** (optional refinement):
   - On step 2, "Next" becomes "Apply" action (Phase 9)
   - For now, keep "Next" button that advances to step 3 placeholder
     </action>
     <verify>
     TypeScript compiles: `pnpm type-check`
     ESLint passes: `pnpm lint`
     Manual test: Open modal, search, select result, see preview with comparison.
     Back button returns to search with state preserved.
     </verify>
     <done>
     Preview step fully integrated into wizard - shows comparison when result is selected.
     </done>
     </task>

</tasks>

<verification>
- `pnpm type-check` passes
- `pnpm lint` passes
- TrackComparison shows position-aligned tracks with diff highlighting
- CoverArtComparison shows side-by-side images with change indicator
- PreviewView assembles all sections in accordion layout
- CorrectionModal step 2 shows PreviewView with real data
- Back button preserves search state
</verification>

<success_criteria>

1. Clicking search result navigates to step 2 showing full preview
2. Cover art comparison visible at top with change indicator
3. Field diffs shown with inline highlighting
4. Track listing shows matched pairs with title diffs
5. Accordion sections expand/collapse with change counts
6. Back button returns to search with query/results preserved
7. All components follow dark zinc color scheme
   </success_criteria>

<output>
After completion, create `.planning/phases/08-preview-ui/08-03-SUMMARY.md`
</output>
