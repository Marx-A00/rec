---
phase: 06-modal-entry-point
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/app/admin/music-database/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Fix Data button (wrench icon) appears on album rows"
    - "Button color changes for LOW data quality albums"
    - "Clicking button opens CorrectionModal with album data"
    - "Modal closes properly and clears selection"
  artifacts:
    - path: "src/app/admin/music-database/page.tsx"
      provides: "Admin page with Fix Data button and modal integration"
      contains: "CorrectionModal"
  key_links:
    - from: "src/app/admin/music-database/page.tsx"
      to: "src/components/admin/correction/CorrectionModal.tsx"
      via: "component import and state"
      pattern: "correctionAlbumId.*CorrectionModal"
---

<objective>
Add Fix Data entry point to admin music database page.

Purpose: Provide the admin entry point to the correction workflow - a wrench icon button on each album row that opens the CorrectionModal.
Output: Working end-to-end flow from album table to correction modal.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-modal-entry-point/06-RESEARCH.md
@.planning/phases/06-modal-entry-point/06-CONTEXT.md
@.planning/phases/06-modal-entry-point/06-01-SUMMARY.md
@.planning/phases/06-modal-entry-point/06-02-SUMMARY.md
@src/app/admin/music-database/page.tsx
@src/components/admin/correction/CorrectionModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Fix Data button to album table rows</name>
  <files>src/app/admin/music-database/page.tsx</files>
  <action>
    Add state and button for correction modal:
    
    1. Import CorrectionModal and required icons:
       - import { CorrectionModal } from '@/components/admin/correction/CorrectionModal'
       - import { Wrench } from 'lucide-react' (add to existing lucide imports)
    
    2. Add state for correction modal:
       - const [correctionAlbumId, setCorrectionAlbumId] = useState<string | null>(null)
       - Track full album data: const [correctionAlbum, setCorrectionAlbum] = useState<AlbumSearchResult | null>(null)
    
    3. In the album table rows (TableRow for albums), add a new action button:
       - Find the area where other action buttons are (enrichment, preview, delete)
       - Add a Wrench icon button before or after existing actions
       - Button specs:
         - variant="ghost"
         - size="icon"
         - className with conditional coloring:
           - Base: text-zinc-400 hover:text-zinc-200
           - If album.dataQuality === 'LOW': text-dark-pastel-red hover:text-dark-pastel-red
         - onClick: setCorrectionAlbum(album) (sets both album and triggers modal)
       
    4. Add Tooltip around button:
       - Import Tooltip, TooltipContent, TooltipProvider, TooltipTrigger from @/components/ui/tooltip
       - Wrap the button in tooltip with content "Fix album data"
    
    5. Compute correctionAlbumId from correctionAlbum:
       - const correctionAlbumId = correctionAlbum?.id ?? null
       - Or just use correctionAlbum directly as the trigger
  </action>
  <verify>
    - Wrench icon appears on album rows
    - Icon is colored for LOW quality albums
    - npm run type-check passes
  </verify>
  <done>
    Fix Data button visible on all album rows with quality-based coloring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire CorrectionModal to album selection</name>
  <files>src/app/admin/music-database/page.tsx</files>
  <action>
    Add CorrectionModal to the page and wire it up:
    
    1. At the end of the component return (after other modals like deleteModalOpen, deleteArtistModalOpen):
       Add CorrectionModal component:
       
       - open={correctionAlbum !== null}
       - albumId={correctionAlbum?.id ?? null}
       - album prop: Transform AlbumSearchResult to format CorrectionModal expects
         Map the data structure if needed, or adjust CorrectionModal to accept AlbumSearchResult
       - onClose={() => setCorrectionAlbum(null)}
    
    2. The album object from AlbumSearchResult needs these fields for CorrectionModal:
       - id, title, releaseDate, coverArtUrl, musicbrainzId
       - artists array, trackCount (may not have full tracks array)
       - dataQuality, label
       
       NOTE: AlbumSearchResult may not have full track list (only trackCount).
       For CurrentDataView to show tracks, we need the expanded album details.
       
       Option A: Fetch full album inside CorrectionModal using useGetAlbumDetailsAdminQuery
       Option B: Pass what we have and fetch tracks inside CurrentDataView
       
       Recommended: Fetch inside CorrectionModal so it has complete data.
       Update CorrectionModal to:
       - Accept albumId: string | null
       - Use useGetAlbumDetailsAdminQuery(albumId) internally when albumId is set
       - Pass fetched album data to CurrentDataView
       - Show loading spinner while fetching
    
    3. Handle the case where album details are loading:
       - Show Loader2 spinner in modal content while loading
       - Only render CurrentDataView when data is available
    
    4. Update CorrectionModal signature:
       - Remove album prop
       - Add albumId: string | null prop
       - Fetch album details internally
       - Update header to use fetched album data
  </action>
  <verify>
    - Clicking wrench button opens modal
    - Modal fetches and displays album data
    - Modal shows loading state while fetching
    - Closing modal clears selection
    - npm run type-check passes
    - npm run lint passes
  </verify>
  <done>
    Complete Fix Data flow from button click to modal display.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Fix Data entry point:
    1. Wrench icon button on album rows in admin music database
    2. Button color changes for LOW quality albums (red)
    3. CorrectionModal opens with album data in accordion sections
    4. Modal shows cover art, basic info, tracks, external IDs
    5. Modal closes on X button and Escape key
  </what-built>
  <how-to-verify>
    1. Start dev server: pnpm dev
    2. Navigate to /admin/music-database
    3. Observe: Wrench icons visible on album rows
    4. Find an album with LOW quality - icon should be red/orange colored
    5. Click any wrench icon - modal should open
    6. Verify modal shows:
       - Header: "Fixing: [Album Title] by [Artist]"
       - Step indicator showing "Current Data" as active
       - Cover art thumbnail (or placeholder if none)
       - Collapsible sections: Basic Info, Tracks, External IDs
       - Data quality badge (Excellent/Good/Fair/Poor)
    7. Click accordion headers to collapse/expand
    8. If album has 30+ tracks, verify "Show all" button works
    9. Click X button - modal closes
    10. Open another album, press Escape - modal closes
  </how-to-verify>
  <resume-signal>Type "approved" if working correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- npm run type-check passes
- npm run lint passes
- pnpm dev runs without errors
- Fix Data button visible and working
</verification>

<success_criteria>
- Wrench icon on all album rows
- LOW quality albums have colored icon
- Modal opens with album data on click
- Modal shows cover art, basic info, tracks, external IDs
- Modal closes on X and Escape
- Step indicator visible with 3 steps
</success_criteria>

<output>
After completion, create `.planning/phases/06-modal-entry-point/06-03-SUMMARY.md`
</output>
