---
phase: 09-apply-ui
plan: 02
type: execute
wave: 2
depends_on: ['09-01']
files_modified:
  - src/components/admin/correction/apply/DiffSummary.tsx
  - src/components/admin/correction/apply/ApplyView.tsx
  - src/components/admin/correction/apply/index.ts
autonomous: true

must_haves:
  truths:
    - 'Admin sees compact summary of all selected changes before applying'
    - 'Diff summary shows before → after for each selected field'
    - 'Apply view contains field selection form and confirmation button'
    - 'Step transition model - no separate confirmation dialog'
  artifacts:
    - path: 'src/components/admin/correction/apply/DiffSummary.tsx'
      provides: 'Compact before/after summary display'
      exports: ['DiffSummary']
    - path: 'src/components/admin/correction/apply/ApplyView.tsx'
      provides: 'Main apply step container'
      exports: ['ApplyView']
  key_links:
    - from: 'ApplyView.tsx'
      to: 'FieldSelectionForm'
      via: 'import and render'
      pattern: 'FieldSelectionForm'
    - from: 'DiffSummary.tsx'
      to: 'UIFieldSelections'
      via: 'selections prop'
      pattern: 'UIFieldSelections'
---

<objective>
Create the ApplyView container with diff summary for the confirmation step.

Purpose: Admin reviews a compact summary of selected changes and confirms the apply action. This is the step transition model where the apply step itself is the confirmation (no separate dialog).
Output: ApplyView component that combines field selection with change summary and apply button.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-apply-ui/09-CONTEXT.md
@.planning/phases/09-apply-ui/09-RESEARCH.md
@.planning/phases/09-apply-ui/09-01-SUMMARY.md
@src/components/admin/correction/apply/types.ts
@src/components/admin/correction/apply/FieldSelectionForm.tsx
@src/lib/correction/preview/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiffSummary component</name>
  <files>src/components/admin/correction/apply/DiffSummary.tsx</files>
  <action>
Create DiffSummary.tsx that shows a compact summary of selected changes:

1. Props:

   ```typescript
   interface DiffSummaryProps {
     preview: CorrectionPreview;
     selections: UIFieldSelections;
   }
   ```

2. Filter to only show selected fields:
   - Iterate preview.fieldDiffs, include only if corresponding selection is true
   - For tracks: count selected tracks (total - excludedPositions.size)
   - For coverArt: show if selections.coverArt !== 'keep_current'

3. Render structure:

   ```
   ┌─────────────────────────────────────┐
   │ Summary of Changes                  │
   ├─────────────────────────────────────┤
   │ Metadata:                           │
   │   Title: "Old Title" → "New Title"  │
   │   Release Date: 2020 → 2021-03-15   │
   │                                     │
   │ Tracks: 12 tracks will be updated   │
   │                                     │
   │ External IDs:                       │
   │   MusicBrainz: + abc123...          │
   │                                     │
   │ Cover Art: Will be updated          │
   └─────────────────────────────────────┘
   ```

4. Styling:
   - Container: p-4 bg-zinc-800/50 rounded-lg border border-zinc-700
   - Section headers: text-sm text-zinc-400 font-medium
   - Changes: text-sm, red line-through for old values, green for new values
   - ADDED fields: green "+" prefix
   - Empty state: "No changes selected" message

5. Field value formatting:
   - Truncate long values with ellipsis (max 30 chars)
   - Format dates nicely
   - External IDs: show first 8 chars with "..." if longer
     </action>
     <verify>TypeScript compiles: `pnpm type-check`</verify>
     <done>DiffSummary component renders compact before/after summary for selected fields only</done>
     </task>

<task type="auto">
  <name>Task 2: Create ApplyView container component</name>
  <files>src/components/admin/correction/apply/ApplyView.tsx</files>
  <action>
Create ApplyView.tsx as the main container for the apply step:

1. Props:

   ```typescript
   interface ApplyViewProps {
     albumId: string;
     preview: CorrectionPreview;
     onApply: (selections: UIFieldSelections) => void;
     onBack: () => void;
     isApplying?: boolean;
     error?: Error | null;
   }
   ```

2. State:
   - `selections: UIFieldSelections` - initialized via createDefaultUISelections(preview)

3. Layout (two-column on larger screens):

   ```
   ┌───────────────────┬───────────────────┐
   │ Field Selection   │ Summary           │
   │ (FieldSelectionForm)                  │
   │                   │ (DiffSummary)     │
   │                   │                   │
   │                   │ [Confirm & Apply] │
   └───────────────────┴───────────────────┘
   ```

   - On smaller screens: stack vertically
   - Use grid with lg:grid-cols-2 gap-6

4. Header section:
   - "Apply Correction" heading
   - Subtle "← Back to preview" link (calls onBack)

5. Action section (bottom right of summary column):
   - "Confirm & Apply" button (variant="primary")
   - Button disabled when:
     - isApplying is true
     - No changes selected (calculate from selections)
   - Show "Applying..." with spinner when isApplying

6. Error display:
   - If error prop is set, show inline error message above button
   - Use red border and bg-red-900/20 styling
   - "Show details" expandable for error.stack (collapsible)

7. Empty selection warning:
   - If no fields selected, show warning: "Select at least one field to apply"
   - Disable apply button
     </action>
     <verify>TypeScript compiles: `cd /Users/marcosandrade/roaming/projects/rec && pnpm type-check`</verify>
     <done>ApplyView container renders field selection form and diff summary side by side with apply button</done>
     </task>

<task type="auto">
  <name>Task 3: Update exports and verify integration</name>
  <files>src/components/admin/correction/apply/index.ts</files>
  <action>
Update index.ts to export new components:

```typescript
export { FieldSelectionForm } from './FieldSelectionForm';
export { MetadataSection } from './MetadataSection';
export { TrackSection } from './TrackSection';
export { ExternalIdSection } from './ExternalIdSection';
export { DiffSummary } from './DiffSummary';
export { ApplyView } from './ApplyView';
export type { UIFieldSelections } from './types';
export { createDefaultUISelections, toGraphQLSelections } from './types';
```

Run full checks:

- Type check passes
- Lint passes
- All exports resolve correctly
  </action>
  <verify>
  `cd /Users/marcosandrade/roaming/projects/rec && pnpm type-check && pnpm lint`
  </verify>
  <done>All apply components exported, type check and lint pass</done>
  </task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. DiffSummary filters and displays only selected fields
3. ApplyView renders two-column layout with form and summary
4. Apply button disabled when no fields selected or isApplying
5. Error state displays inline with expandable details
6. Back link available to return to preview
</verification>

<success_criteria>

- DiffSummary shows compact before → after for selected fields only
- ApplyView provides step transition model (no separate dialog)
- Layout is responsive (two columns on desktop, stacked on mobile)
- Apply button state correctly reflects selections and loading state
- Error display follows inline pattern with "Show details" expansion
- "Back to preview" navigation available
  </success_criteria>

<output>
After completion, create `.planning/phases/09-apply-ui/09-02-SUMMARY.md`
</output>
