---
phase: 09-apply-ui
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - src/components/admin/correction/preview/PreviewView.tsx
  - src/components/admin/correction/CorrectionModal.tsx
  - src/hooks/useCorrectionModalState.ts
autonomous: true

must_haves:
  truths:
    - "Admin can click 'Apply This Match' to transition from preview to apply step"
    - "Apply mutation is called with correct selections when confirmed"
    - "Toast notification shows on success with change summary"
    - "Modal auto-closes after 1.5s 'Applied!' state on success"
    - "Error displays inline on apply step, admin can retry by clicking Apply again"
    - "Data quality indicator updates appropriately after correction"
  artifacts:
    - path: "src/components/admin/correction/preview/PreviewView.tsx"
      provides: "Apply This Match button integration"
      min_lines: 100
    - path: "src/components/admin/correction/CorrectionModal.tsx"
      provides: "Apply step rendering and mutation handling"
      min_lines: 150
  key_links:
    - from: "CorrectionModal.tsx"
      to: "useApplyCorrectionMutation"
      via: "import and use"
      pattern: "useApplyCorrectionMutation"
    - from: "CorrectionModal.tsx"
      to: "ApplyView"
      via: "render in step 2"
      pattern: "ApplyView"
---

<objective>
Integrate the apply mutation with the modal, add toast feedback, and implement auto-close behavior.

Purpose: Complete the apply flow where admin confirms selection, mutation executes, and modal provides feedback via toast and auto-close.
Output: Fully functional apply step integrated into the correction modal with proper feedback.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-apply-ui/09-CONTEXT.md
@.planning/phases/09-apply-ui/09-RESEARCH.md
@.planning/phases/09-apply-ui/09-01-SUMMARY.md
@.planning/phases/09-apply-ui/09-02-SUMMARY.md
@src/components/admin/correction/apply/ApplyView.tsx
@src/components/admin/correction/apply/types.ts
@src/components/admin/correction/CorrectionModal.tsx
@src/components/admin/correction/preview/PreviewView.tsx
@src/hooks/useCorrectionModalState.ts
@src/components/ui/toast.tsx
@src/generated/graphql.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add apply step state to modal hook</name>
  <files>src/hooks/useCorrectionModalState.ts</files>
  <action>
Update useCorrectionModalState hook to support 4 steps (add Apply step):

1. Update step validation to allow step 3 (0=Current, 1=Search, 2=Preview, 3=Apply):
   - Change validation from step <= 2 to step <= 3

2. Update isLastStep calculation:
   - Change from currentStep === 2 to currentStep === 3

3. Add new state for apply flow:
   - isApplied: boolean - tracks if correction was successfully applied
   - setIsApplied: (value: boolean) => void

4. Add to ModalState interface and sessionStorage persistence:
   - isApplied?: boolean field in ModalState

5. Reset isApplied when albumId changes or clearState is called.
  </action>
  <verify>TypeScript compiles: pnpm type-check</verify>
  <done>Modal state hook supports 4 steps and tracks isApplied state</done>
</task>

<task type="auto">
  <name>Task 2: Update PreviewView with Apply button and integrate ApplyView</name>
  <files>src/components/admin/correction/preview/PreviewView.tsx</files>
  <action>
Update PreviewView to:

1. Add props for apply transition:
   - onApplyClick?: () => void - triggers transition to apply step
   - onPreviewLoaded?: (preview: CorrectionPreview) => void - exposes preview data to parent

2. Add "Apply This Match" button at the bottom of preview:
   - Position: Right-aligned after the preview content
   - Style: variant="primary" with CheckCircle icon
   - Text: "Apply This Match"
   - onClick: calls onApplyClick prop
   - Only show when preview data is loaded successfully

3. Call onPreviewLoaded when preview query succeeds:
   - Use useEffect to call onPreviewLoaded(previewData) when data becomes available
   - The parent (CorrectionModal) will need the CorrectionPreview data for ApplyView

Note: The actual ApplyView rendering happens in CorrectionModal, not in PreviewView. PreviewView just provides the trigger button and exposes the preview data.
  </action>
  <verify>TypeScript compiles: pnpm type-check</verify>
  <done>PreviewView has "Apply This Match" button and exposes preview data to parent</done>
</task>

<task type="auto">
  <name>Task 3: Integrate apply mutation and feedback in CorrectionModal</name>
  <files>src/components/admin/correction/CorrectionModal.tsx</files>
  <action>
Update CorrectionModal to:

1. Import new dependencies:
   - useApplyCorrectionMutation from generated GraphQL
   - useQueryClient from TanStack Query
   - Toast and useToast from components/ui/toast
   - ApplyView, toGraphQLSelections, UIFieldSelections from ./apply
   - CorrectionPreview type from preview types

2. Add state for preview data:
   - previewData: CorrectionPreview | null state
   - setPreviewData callback passed to PreviewView
   - showAppliedState: boolean for success animation

3. Add apply mutation with callbacks:
   - On success: 
     - Show "Applied!" state
     - Build toast message from changes object including:
       - Fields count: `changes.metadata.length + changes.externalIds.length` fields
       - Tracks: `changes.tracks.added + changes.tracks.modified + changes.tracks.removed` tracks
       - If data quality changed (`changes.dataQualityBefore !== changes.dataQualityAfter`): include "Data quality: {before} → {after}" in toast
     - Invalidate album queries via queryClient.invalidateQueries({ queryKey: ['album', albumId] })
     - Auto-close modal after 1.5s setTimeout
   - On error: show toast with error message

4. Handle apply action:
   - Convert UI selections to GraphQL format using toGraphQLSelections(selections, previewData)
   - Call mutation with:
     - albumId
     - releaseGroupMbid (from previewData.sourceResult.mbid)
     - selections (converted GraphQL format)
     - expectedUpdatedAt: Extract from `previewData.currentAlbum.updatedAt` - this is the Prisma Album.updatedAt field which provides optimistic locking to detect stale data

5. Render step 3 (Apply):
   - If showAppliedState: render success state (green checkmark, "Applied!" text centered)
   - Else: render ApplyView with preview, handlers, and mutation state (isPending, error)

6. Update StepIndicator for 4 steps:
   - Modify to show "Apply" as the fourth step label

7. Update footer buttons for step 3:
   - Show "Back" button (goes to preview)
   - Do not show "Next" or "Apply" buttons (apply is inside ApplyView)

8. Render Toast component at bottom of modal:
   - Pass toast state from useToast hook

9. Handle "Apply This Match" click from PreviewView:
   - Call nextStep() to navigate from step 2 (Preview) to step 3 (Apply)

10. Handle previewLoaded callback:
    - Store preview data when PreviewView loads it
  </action>
  <verify>
pnpm type-check && pnpm lint
  </verify>
  <done>CorrectionModal integrates apply mutation with toast feedback, "Applied!" state, and auto-close after 1.5s</done>
</task>

</tasks>

<verification>
1. Step indicator shows 4 steps: Current Data, Search, Preview, Apply
2. "Apply This Match" button in preview navigates to apply step
3. ApplyView renders with field selection form and summary
4. Clicking "Confirm & Apply" triggers mutation with correct input including expectedUpdatedAt from previewData.currentAlbum.updatedAt
5. Success shows "Applied!" state, toast with summary (including data quality change if applicable), auto-closes after 1.5s
6. Error shows inline in ApplyView, admin can retry
7. Modal state cleared on successful apply
8. Album queries invalidated on success (covers APPLY-06: data quality UI update)
</verification>

<success_criteria>
- Complete apply flow works: Preview -> "Apply This Match" -> Select fields -> Confirm -> Toast -> Auto-close
- Mutation called with correct FieldSelectionsInput from UI selections
- expectedUpdatedAt correctly extracted from previewData.currentAlbum.updatedAt for optimistic locking
- Toast shows summary like "Updated: 3 fields, 12 tracks" (and "Data quality: LOW → HIGH" if changed)
- "Applied!" state shows for 1.5s before modal closes
- Error recovery: stays on apply step, shows error, allows retry
- Query invalidation refreshes album data after success (ensures data quality indicator updates)
</success_criteria>

<output>
After completion, create .planning/phases/09-apply-ui/09-03-SUMMARY.md
</output>
