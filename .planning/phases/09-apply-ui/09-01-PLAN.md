---
phase: 09-apply-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/correction/apply/FieldSelectionForm.tsx
  - src/components/admin/correction/apply/MetadataSection.tsx
  - src/components/admin/correction/apply/TrackSection.tsx
  - src/components/admin/correction/apply/ExternalIdSection.tsx
  - src/components/admin/correction/apply/index.ts
  - src/components/admin/correction/apply/types.ts
autonomous: true

must_haves:
  truths:
    - "Admin can select/deselect individual metadata fields via checkboxes"
    - "Admin can select/deselect all tracks or exclude individual tracks"
    - "Admin can select/deselect external ID fields"
    - "Section-level checkboxes show indeterminate state when partially selected"
    - "Default state is all fields selected"
  artifacts:
    - path: "src/components/admin/correction/apply/FieldSelectionForm.tsx"
      provides: "Main form container with accordion sections"
      exports: ["FieldSelectionForm"]
    - path: "src/components/admin/correction/apply/MetadataSection.tsx"
      provides: "Metadata field checkboxes"
      exports: ["MetadataSection"]
    - path: "src/components/admin/correction/apply/TrackSection.tsx"
      provides: "Track selection with hybrid approach"
      exports: ["TrackSection"]
    - path: "src/components/admin/correction/apply/ExternalIdSection.tsx"
      provides: "External ID checkboxes"
      exports: ["ExternalIdSection"]
  key_links:
    - from: "FieldSelectionForm.tsx"
      to: "preview types"
      via: "CorrectionPreview prop"
      pattern: "CorrectionPreview"
    - from: "TrackSection.tsx"
      to: "TrackDiff[]"
      via: "trackDiffs prop"
      pattern: "trackDiffs"
---

<objective>
Create the field selection form with accordion sections and hierarchical checkboxes for the apply step.

Purpose: Admin can granularly control which fields to apply from a MusicBrainz correction. The UI matches the preview layout with accordion sections for Metadata, Tracks, and External IDs.
Output: Reusable form components with controlled checkbox state management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-apply-ui/09-CONTEXT.md
@.planning/phases/09-apply-ui/09-RESEARCH.md
@src/lib/correction/apply/types.ts
@src/lib/correction/preview/types.ts
@src/components/ui/accordion.tsx
@src/components/ui/checkbox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create selection state types and utility functions</name>
  <files>src/components/admin/correction/apply/types.ts</files>
  <action>
Create types.ts with:

1. **UIFieldSelections interface** - Matches apply service FieldSelections but uses simpler structures for UI state:
   ```typescript
   interface UIFieldSelections {
     metadata: {
       title: boolean;
       releaseDate: boolean;
       releaseType: boolean;
       releaseCountry: boolean;
       barcode: boolean;
       label: boolean;
     };
     tracks: {
       applyAll: boolean;
       excludedPositions: Set<string>; // "disc-track" keys like "1-3"
     };
     externalIds: {
       musicbrainzId: boolean;
       spotifyId: boolean;
       discogsId: boolean;
     };
     coverArt: 'use_source' | 'keep_current' | 'clear';
   }
   ```

2. **createDefaultUISelections(preview: CorrectionPreview)** - Factory function that:
   - Sets all metadata fields to true
   - Sets tracks.applyAll to true with empty excludedPositions
   - Sets all externalIds to true  
   - Sets coverArt to 'use_source' if preview.coverArt.changeType !== 'UNCHANGED', else 'keep_current'

3. **toGraphQLSelections(ui: UIFieldSelections, preview: CorrectionPreview)** - Converts UI state to GraphQL input format:
   - Converts metadata object directly
   - Converts tracks to SelectionEntry[] array (all track positions, with selected=true unless in excludedPositions)
   - Converts externalIds object directly
   - Maps coverArt to CoverArtChoice enum

Import CorrectionPreview from preview types.
  </action>
  <verify>TypeScript compiles without errors: `pnpm type-check`</verify>
  <done>UIFieldSelections type defined, createDefaultUISelections and toGraphQLSelections utility functions work correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create accordion section components</name>
  <files>
    src/components/admin/correction/apply/MetadataSection.tsx
    src/components/admin/correction/apply/TrackSection.tsx
    src/components/admin/correction/apply/ExternalIdSection.tsx
  </files>
  <action>
Create three section components following the accordion pattern from Phase 8:

**MetadataSection.tsx:**
- Props: `selections`, `onSelectionsChange`, `fieldDiffs` (from preview)
- Renders AccordionItem with value="metadata"
- AccordionTrigger contains:
  - Checkbox for "select all metadata" (stopPropagation on click!)
  - Label: "Metadata (N changes)" where N = count of non-UNCHANGED fieldDiffs
  - Checkbox shows indeterminate state when some but not all fields selected
- AccordionContent contains vertical list of checkboxes:
  - Only show fields that have changes (changeType !== 'UNCHANGED')
  - Each checkbox: field label + current → source value preview
  - Use zinc-800 bg, zinc-400 text for styling consistency

**TrackSection.tsx:**
- Props: `selections`, `onSelectionsChange`, `trackDiffs`, `trackSummary`
- Hybrid approach per CONTEXT.md:
  - Main checkbox: "Apply all tracks" (applyAll)
  - Collapsible "Show individual tracks" button
  - When expanded: list of track checkboxes
  - Track checked if NOT in excludedPositions
- AccordionTrigger shows: "Tracks (N selected / M total)"
- Visual cues for modified/added/removed tracks (yellow/green/red text)

**ExternalIdSection.tsx:**
- Props: `selections`, `onSelectionsChange`, `fieldDiffs`
- Similar pattern to MetadataSection
- Shows musicbrainzId, spotifyId, discogsId checkboxes
- Only show fields that have changes
- Format: "MusicBrainz ID: abc123... → xyz789..."

All components:
- Use Radix UI Checkbox from @/components/ui/checkbox
- Use Radix UI Accordion from @/components/ui/accordion
- onClick={(e) => e.stopPropagation()} on checkboxes in AccordionTrigger
- Dark zinc color scheme matching admin modal
  </action>
  <verify>TypeScript compiles: `cd /Users/marcosandrade/roaming/projects/rec && pnpm type-check`</verify>
  <done>MetadataSection, TrackSection, and ExternalIdSection components render checkboxes with proper state binding</done>
</task>

<task type="auto">
  <name>Task 3: Create FieldSelectionForm container</name>
  <files>
    src/components/admin/correction/apply/FieldSelectionForm.tsx
    src/components/admin/correction/apply/index.ts
  </files>
  <action>
**FieldSelectionForm.tsx:**
Create the main form container that:

1. Props:
   ```typescript
   interface FieldSelectionFormProps {
     preview: CorrectionPreview;
     selections: UIFieldSelections;
     onSelectionsChange: (selections: UIFieldSelections) => void;
   }
   ```

2. Structure:
   - Accordion with type="multiple" and defaultValue showing sections with changes
   - Render MetadataSection, TrackSection, ExternalIdSection
   - Pass down appropriate slices of selections and handler callbacks
   - Filter fieldDiffs for metadata vs externalIds sections

3. Global "Select all / Deselect all" at top:
   - Two buttons: "Select all" and "Deselect all"
   - Select all: sets everything to true, clears excludedPositions
   - Deselect all: sets everything to false, adds all tracks to excludedPositions

4. Visual summary at bottom:
   - "X fields selected" summary line
   - Changes count per category

**index.ts:**
Export all apply components:
```typescript
export { FieldSelectionForm } from './FieldSelectionForm';
export { MetadataSection } from './MetadataSection';
export { TrackSection } from './TrackSection';
export { ExternalIdSection } from './ExternalIdSection';
export type { UIFieldSelections } from './types';
export { createDefaultUISelections, toGraphQLSelections } from './types';
```
  </action>
  <verify>
TypeScript compiles: `cd /Users/marcosandrade/roaming/projects/rec && pnpm type-check`
Lint passes: `cd /Users/marcosandrade/roaming/projects/rec && pnpm lint`
  </verify>
  <done>FieldSelectionForm container renders accordion with all section components, global select all/deselect all works</done>
</task>

</tasks>

<verification>
1. All TypeScript types compile without errors
2. Components export correctly from index.ts
3. Lint passes with no errors
4. createDefaultUISelections returns selections with all fields true
5. toGraphQLSelections converts UI state to GraphQL input format
</verification>

<success_criteria>
- FieldSelectionForm component renders accordion with Metadata, Tracks, External IDs sections
- Each section has master checkbox with indeterminate support
- Individual field checkboxes toggle correctly
- Track section implements hybrid "apply all with exclusions" pattern
- Global select all / deselect all buttons work
- All components use zinc dark theme styling
</success_criteria>

<output>
After completion, create `.planning/phases/09-apply-ui/09-01-SUMMARY.md`
</output>
