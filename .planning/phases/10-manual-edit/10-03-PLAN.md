---
phase: 10-manual-edit
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - src/components/admin/correction/manual/ManualEditView.tsx
  - src/components/admin/correction/manual/UnsavedChangesDialog.tsx
  - src/components/admin/correction/CorrectionModal.tsx
  - src/components/admin/correction/manual/index.ts
autonomous: true

must_haves:
  truths:
    - "Manual Edit tab is accessible from step 1 (Current Data)"
    - "Clicking Manual Edit enters edit mode with pre-populated fields"
    - "Unsaved changes warning appears when switching away with edits"
    - "Preview shows diff between original and edited values"
    - "Apply uses 'manual_correction' as source"
  artifacts:
    - path: "src/components/admin/correction/manual/ManualEditView.tsx"
      provides: "Main container for manual edit step"
      exports: ["ManualEditView"]
    - path: "src/components/admin/correction/manual/UnsavedChangesDialog.tsx"
      provides: "Confirmation dialog for discarding edits"
      exports: ["UnsavedChangesDialog"]
    - path: "src/components/admin/correction/CorrectionModal.tsx"
      provides: "Updated modal with manual edit integration"
      min_lines: 200
  key_links:
    - from: "src/components/admin/correction/CorrectionModal.tsx"
      to: "src/components/admin/correction/manual/ManualEditView.tsx"
      via: "renders ManualEditView when in manual mode"
      pattern: "<ManualEditView"
    - from: "src/components/admin/correction/manual/ManualEditView.tsx"
      to: "src/components/admin/correction/manual/validation.ts"
      via: "validates form before preview"
      pattern: "manualEditSchema\\.safeParse"
---

<objective>
Create the ManualEditView container and integrate manual edit flow into the CorrectionModal.

Purpose: This is the main deliverable - a working manual edit flow where admin can edit fields inline, preview changes, and apply with "manual_correction" source. Reuses existing preview/apply infrastructure with manually constructed diff data.

Output: Complete manual edit workflow integrated into correction modal.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-manual-edit/10-CONTEXT.md
@.planning/phases/10-manual-edit/10-RESEARCH.md
@.planning/phases/10-manual-edit/10-01-SUMMARY.md
@.planning/phases/10-manual-edit/10-02-SUMMARY.md

@src/components/admin/correction/CorrectionModal.tsx
@src/components/admin/correction/apply/ApplyView.tsx
@src/components/admin/correction/preview/PreviewView.tsx
@src/lib/correction/preview/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManualEditView container component</name>
  <files>src/components/admin/correction/manual/ManualEditView.tsx</files>
  <action>
**ManualEditView.tsx** - Main container for manual edit step:

Props interface:
```typescript
interface ManualEditViewProps {
  album: CurrentDataViewAlbum;
  onPreviewClick: (editedState: ManualEditFieldState) => void;
  onCancel: () => void;
  initialState?: ManualEditFieldState; // For resuming edits
}
```

Component structure:

1. **State management:**
   - `const [formState, setFormState] = useState<ManualEditFieldState>(() => initialState ?? createInitialEditState(album))`
   - `const [errors, setErrors] = useState<ManualEditValidationErrors>({})`
   - Track dirty state with `hasUnsavedChanges(initialState, formState)`

2. **Layout sections:**

   a) Header:
   - Title: "Edit Album Data"
   - Subtitle: "Make changes directly, then preview before applying"

   b) Basic Info section:
   - EditableField for title (required)
   - ArtistChipsInput for artists
   - DateInput for releaseDate
   - ReleaseTypeSelect for releaseType

   c) External IDs section (collapsible accordion):
   - ExternalIdInput for musicbrainzId (UUID schema)
   - ExternalIdInput for spotifyId (base62 schema)
   - ExternalIdInput for discogsId (numeric schema)

3. **Validation on preview:**
   - Validate entire form with manualEditSchema.safeParse
   - If errors, show validation banner at top + inline errors
   - If valid, call onPreviewClick(formState)

4. **Footer:**
   - "Cancel" button (calls onCancel)
   - "Preview Changes" button (primary, disabled if no changes)

Styling:
- Match existing modal dark theme (zinc-900 bg, zinc-100 text)
- Section cards with border-zinc-800
- Use existing Accordion for External IDs section
  </action>
  <verify>Render ManualEditView with album data, all fields pre-populated. Edit title, click Preview - onPreviewClick called with updated state.</verify>
  <done>ManualEditView renders with all input components and preview action</done>
</task>

<task type="auto">
  <name>Task 2: Create UnsavedChangesDialog and diff computation</name>
  <files>src/components/admin/correction/manual/UnsavedChangesDialog.tsx, src/components/admin/correction/manual/computeManualDiffs.ts</files>
  <action>
**UnsavedChangesDialog.tsx** - Confirmation for discarding edits:

Props interface:
```typescript
interface UnsavedChangesDialogProps {
  open: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}
```

Content:
- Title: "Unsaved Changes"
- Description: "You have unsaved edits. Do you want to discard them?"
- Buttons: "Keep Editing" (secondary), "Discard" (destructive)

Use existing Dialog/AlertDialog primitives from @/components/ui/alert-dialog.

**computeManualDiffs.ts** - Construct preview data from manual edits:

```typescript
export function computeManualPreview(
  album: CurrentDataViewAlbum,
  editedState: ManualEditFieldState
): CorrectionPreview
```

Logic:
1. Compare each field between album (current) and editedState (source)
2. Generate TextDiff for title if changed
3. Generate DateDiff for releaseDate if changed
4. Generate artistDiff comparing album.artists to editedState.artists
5. External IDs: Generate TextDiff for each if changed
6. Set sourceResult with:
   - `id: 'manual-edit'`
   - `releaseGroupMbid: editedState.musicbrainzId ?? 'manual'`
   - `title: editedState.title`
   - etc.
7. trackDiffs: Empty array (manual edit doesn't change tracks in v1)
8. coverArt: { changeType: 'UNCHANGED' } (no cover change in manual edit)

Return CorrectionPreview structure compatible with existing PreviewView/ApplyView.

Add to index.ts exports.
  </action>
  <verify>computeManualPreview returns valid CorrectionPreview with fieldDiffs for changed fields only</verify>
  <done>Dialog and diff computation utilities created and exported</done>
</task>

<task type="auto">
  <name>Task 3: Integrate manual edit into CorrectionModal</name>
  <files>src/components/admin/correction/CorrectionModal.tsx, src/components/admin/correction/manual/index.ts</files>
  <action>
**Update CorrectionModal.tsx:**

1. **Add manual edit state:**
   ```typescript
   const [isManualMode, setIsManualMode] = useState(false);
   const [manualEditState, setManualEditState] = useState<ManualEditFieldState | null>(null);
   const [showUnsavedDialog, setShowUnsavedDialog] = useState(false);
   const [pendingAction, setPendingAction] = useState<(() => void) | null>(null);
   ```

2. **Add "Manual Edit" button to Current Data step (step 0):**
   - Add button below CurrentDataView: "Edit Manually" with Pencil icon
   - On click: setIsManualMode(true), setCurrentStep to edit step
   - Position: flex row with "Search MusicBrainz" and "Edit Manually" buttons

3. **Update step flow for manual mode:**
   - Manual mode steps: Current Data (0) → Edit (1) → Apply (2)
   - Update StepIndicator to pass mode prop
   - Adjust isLastStep, isFirstStep based on mode

4. **Render ManualEditView when step 1 and isManualMode:**
   ```tsx
   {currentStep === 1 && isManualMode && album && (
     <ManualEditView
       album={album}
       onPreviewClick={handleManualPreview}
       onCancel={handleCancelManualEdit}
       initialState={manualEditState ?? undefined}
     />
   )}
   ```

5. **Handle manual preview:**
   ```typescript
   const handleManualPreview = (editedState: ManualEditFieldState) => {
     setManualEditState(editedState);
     const preview = computeManualPreview(album!, editedState);
     setPreviewData(preview);
     nextStep(); // Go to Apply step
   };
   ```

6. **Handle apply for manual mode:**
   - Modify handleApply to detect manual mode
   - Use different mutation input: source = "manual_correction"
   - For now, construct minimal ApplyInput - Phase 10 may need new GraphQL mutation

7. **Unsaved changes guard:**
   - When switching from manual mode to search or closing modal:
   - Check `hasUnsavedChanges`
   - If dirty: show UnsavedChangesDialog
   - On confirm: proceed with action
   - On cancel: stay in edit mode

8. **Update footer buttons:**
   - Manual mode step 1: Cancel, Preview Changes
   - Manual mode step 2: Back, Apply

9. **Clear manual state on close/apply success:**
   - Add manualEditState to clearState logic
   </action>
  <verify>Open modal, click "Edit Manually", edit title, click "Preview Changes" - shows diff. Click Apply - applies with manual_correction source.</verify>
  <done>Complete manual edit flow works end-to-end in correction modal</done>
</task>

</tasks>

<verification>
1. Run `pnpm type-check` - no TypeScript errors
2. Run `pnpm lint` - no linting errors
3. Manual testing flow:
   a. Open correction modal for any album
   b. Click "Edit Manually" button on Current Data step
   c. Edit title, add/remove artist, change release date
   d. Click "Preview Changes"
   e. Verify diff shows current vs edited values
   f. Click "Apply" - changes applied to database
4. Test unsaved changes:
   a. Edit a field in manual mode
   b. Try to close modal or switch to search
   c. Verify warning dialog appears
   d. Click "Keep Editing" - stays in edit mode
   e. Click "Discard" - exits without saving
</verification>

<success_criteria>
- "Edit Manually" button visible on Current Data step
- ManualEditView renders with all editable fields
- Preview shows correct diff between original and edited values
- Apply works with "manual_correction" as source
- Unsaved changes warning prevents accidental data loss
- Modal state persists manual edit state in sessionStorage
</success_criteria>

<output>
After completion, create `.planning/phases/10-manual-edit/10-03-SUMMARY.md`
</output>
