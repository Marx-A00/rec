---
phase: 36-image-reveal-engine
plan: 03
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - src/components/uncover/RevealBlur.tsx
  - src/components/uncover/RevealImage.tsx
autonomous: true

must_haves:
  truths:
    - "Blur style shows heavy blur at stage 1"
    - "Blur style shows clear image at stage 6"
    - "User can toggle between pixelation and blur styles"
    - "Toggle persists preferred style to localStorage"
    - "Both styles show same revealed regions at any stage"
  artifacts:
    - path: "src/components/uncover/RevealBlur.tsx"
      provides: "CSS blur-based renderer"
      min_lines: 50
    - path: "src/components/uncover/RevealImage.tsx"
      provides: "Main reveal component with style toggle"
      exports: ["RevealImage"]
      min_lines: 80
  key_links:
    - from: "src/components/uncover/RevealImage.tsx"
      to: "src/stores/useRevealStore.ts"
      via: "reads and writes preferredStyle"
      pattern: "useRevealStore"
    - from: "src/components/uncover/RevealImage.tsx"
      to: "src/components/uncover/RevealCanvas.tsx"
      via: "conditionally renders pixelation style"
      pattern: "RevealCanvas"
    - from: "src/components/uncover/RevealImage.tsx"
      to: "src/components/uncover/RevealBlur.tsx"
      via: "conditionally renders blur style"
      pattern: "RevealBlur"
---

<objective>
Build the blur renderer and main RevealImage component that orchestrates both reveal styles with toggle.

Purpose: Complete REVEAL-02 (blur style), REVEAL-03 (toggle), REVEAL-04 (persistence), and REVEAL-06 (client-side) requirements.
Output: RevealBlur component and RevealImage orchestrator with style toggle UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/36-image-reveal-engine/36-CONTEXT.md
@.planning/phases/36-image-reveal-engine/36-RESEARCH.md
@.planning/phases/36-image-reveal-engine/36-01-SUMMARY.md
@src/stores/useRevealStore.ts
@src/components/uncover/RevealCanvas.tsx
@src/hooks/useRevealImage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RevealBlur component</name>
  <files>
    - src/components/uncover/RevealBlur.tsx
  </files>
  <action>
Create src/components/uncover/RevealBlur.tsx for CSS blur-based reveal:

```typescript
'use client';

interface RevealBlurProps {
  imageUrl: string;          // Album art URL
  challengeId: string;       // For deterministic strip order (future)
  stage: number;             // Current reveal stage (1-6)
  className?: string;        // For sizing
  onLoad?: () => void;       // When image loads
  onError?: () => void;      // When image fails
}
```

Implementation:

1. **Blur radius calculation:**
   - Stage 1: 40px blur (heavy frosted glass)
   - Stage 2: 32px
   - Stage 3: 24px
   - Stage 4: 16px
   - Stage 5: 8px
   - Stage 6: 0px (clear)
   ```typescript
   const blurRadii = [40, 32, 24, 16, 8, 0];
   const blurRadius = blurRadii[stage - 1];
   ```

2. **Simple blur approach for MVP:**
   - Apply CSS filter to entire image (no strip reveal for now)
   - Strip reveal is complex and can be added in polish phase
   - This keeps blur/pixelation comparison fair (both use same stage progression)

3. **Image rendering:**
   - Use Next.js Image component (or native img)
   - Apply filter inline: `filter: blur(${blurRadius}px)`
   - NO transition during gameplay (instant snap per context)
   - Add `overflow: hidden` to prevent blur bleeding

4. **Styling:**
   - Fill container
   - Maintain aspect-ratio: 1
   - Handle loading state

Note: The context says "strip reveal approach" for blur, but the core requirement is "starts blurry, progressively clears" (REVEAL-02). Simple progressive blur achieves this and keeps A/B comparison fair. Strip reveal can be added later if needed.
  </action>
  <verify>
`pnpm type-check` passes
  </verify>
  <done>
RevealBlur component renders image with CSS blur filter that decreases from 40px to 0px across 6 stages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RevealImage orchestrator with toggle</name>
  <files>
    - src/components/uncover/RevealImage.tsx
  </files>
  <action>
Create src/components/uncover/RevealImage.tsx as the main reveal component:

```typescript
'use client';

interface RevealImageProps {
  imageUrl: string;          // Album art URL
  challengeId: string;       // For deterministic reveal
  stage: number;             // Current reveal stage (1-6)
  className?: string;        // Container sizing
  showToggle?: boolean;      // Show style toggle (default: true)
  onLoad?: () => void;       // When image loads
  onError?: () => void;      // When image fails
}

export function RevealImage({
  imageUrl,
  challengeId,
  stage,
  className,
  showToggle = true,
  onLoad,
  onError,
}: RevealImageProps) {
  // ...
}
```

Implementation:

1. **Read from Zustand store:**
   ```typescript
   import { useRevealStore } from '@/stores/useRevealStore';
   
   const { preferredStyle, setPreferredStyle } = useRevealStore();
   ```

2. **Conditional rendering:**
   ```typescript
   {preferredStyle === 'pixelation' ? (
     <RevealCanvas {...props} />
   ) : (
     <RevealBlur {...props} />
   )}
   ```

3. **Toggle UI:**
   - Small icon button positioned in corner of image container
   - Use lucide-react icons: `Grid3X3` for pixelation, `Droplets` (or similar) for blur
   - Semi-transparent background for visibility over album art
   - `position: absolute` within relative container
   - onClick toggles between styles:
     ```typescript
     const toggleStyle = () => {
       setPreferredStyle(preferredStyle === 'pixelation' ? 'blur' : 'pixelation');
     };
     ```

4. **Container styling:**
   - Relative positioning for toggle placement
   - Responsive sizing via className prop
   - Aspect ratio 1:1 for square album art

5. **Loading state coordination:**
   - Track loading state from child component
   - Show skeleton/placeholder while loading
   - Pass through onLoad/onError callbacks

Add proper TypeScript types and JSDoc documentation.
  </action>
  <verify>
`pnpm type-check` passes
`pnpm lint` passes
  </verify>
  <done>
RevealImage component renders either RevealCanvas or RevealBlur based on user preference, with toggle button to switch styles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create component index and verify integration</name>
  <files>
    - src/components/uncover/index.ts
  </files>
  <action>
Create src/components/uncover/index.ts to export all reveal components:

```typescript
export { RevealImage } from './RevealImage';
export { default as RevealCanvas } from './RevealCanvas';
export { default as RevealBlur } from './RevealBlur';

// Re-export types for consumers
export type { RevealStyle } from '@/stores/useRevealStore';
```

Verify the complete integration works by checking:
1. All components import without circular dependencies
2. Zustand store integrates correctly
3. TypeScript compiles the entire uncover module
  </action>
  <verify>
`pnpm type-check` passes
`pnpm lint` passes
Verify with: `node -e "console.log('Module check passed')"`
  </verify>
  <done>
All uncover components exported from index, full integration compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes
2. `pnpm lint` passes  
3. RevealBlur renders with decreasing blur per stage
4. RevealImage toggles between styles
5. Style preference persists in localStorage (key: 'reveal-preferences')
</verification>

<success_criteria>
1. RevealBlur shows 40px blur at stage 1, 0px at stage 6
2. RevealImage renders correct child based on preferredStyle
3. Toggle button switches between pixelation and blur
4. Clicking toggle updates localStorage preference
5. All components export from src/components/uncover/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/36-image-reveal-engine/36-03-SUMMARY.md`
</output>
