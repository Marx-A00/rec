---
phase: 36-image-reveal-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-lock.yaml
  - src/lib/uncover/seeded-random.ts
  - src/lib/uncover/reveal-pattern.ts
  - src/stores/useRevealStore.ts
autonomous: true

must_haves:
  truths:
    - "Seeded random generates identical sequences given same seed"
    - "Tile grid covers image with 16x16 cells"
    - "Tile ordering places edges/corners first, center last"
    - "Reveal style preference persists across page reloads"
  artifacts:
    - path: "src/lib/uncover/seeded-random.ts"
      provides: "Fisher-Yates shuffle with seedrandom"
      exports: ["fisherYatesShuffle", "createSeededRng"]
    - path: "src/lib/uncover/reveal-pattern.ts"
      provides: "Tile grid generation and ordering algorithms"
      exports: ["generateTileGrid", "orderTilesByDistance", "getTilesForStage"]
    - path: "src/stores/useRevealStore.ts"
      provides: "Zustand store for reveal style preference"
      exports: ["useRevealStore"]
  key_links:
    - from: "src/lib/uncover/reveal-pattern.ts"
      to: "src/lib/uncover/seeded-random.ts"
      via: "imports fisherYatesShuffle"
      pattern: "import.*fisherYatesShuffle.*seeded-random"
---

<objective>
Create the reveal engine foundation: seeded randomness, tile/strip pattern generation, and reveal style preference persistence.

Purpose: Establish deterministic reveal patterns so all players see same reveal order for a given daily challenge, plus persist user's preferred reveal style.
Output: Utility modules in src/lib/uncover/ and Zustand store in src/stores/
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/36-image-reveal-engine/36-CONTEXT.md
@.planning/phases/36-image-reveal-engine/36-RESEARCH.md
@src/stores/useSearchStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install seedrandom and create seeded-random utility</name>
  <files>
    - package.json
    - pnpm-lock.yaml
    - src/lib/uncover/seeded-random.ts
  </files>
  <action>
Install seedrandom and its types:
```bash
pnpm add seedrandom && pnpm add -D @types/seedrandom
```

Create src/lib/uncover/seeded-random.ts with:

1. `createSeededRng(seed: string)`: Returns a seeded PRNG function using seedrandom library
   - Takes a seed string (e.g., "uncover-{challengeId}")
   - Returns () => number that produces deterministic sequence

2. `fisherYatesShuffle<T>(array: T[], rng: () => number): T[]`: Unbiased shuffle
   - Does NOT mutate original array (returns copy)
   - Uses provided RNG for determinism
   - Implements classic Fisher-Yates algorithm (swap from end)

Add JSDoc comments explaining purpose of each function.
  </action>
  <verify>
Create a simple test in Node REPL:
```bash
node -e "const sr = require('seedrandom'); const rng = sr('test'); console.log(rng(), rng()); const rng2 = sr('test'); console.log(rng2(), rng2());"
```
Both pairs should produce identical numbers.
  </verify>
  <done>
seedrandom installed, seeded-random.ts exports createSeededRng and fisherYatesShuffle with deterministic behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reveal-pattern utility for tile grid and ordering</name>
  <files>
    - src/lib/uncover/reveal-pattern.ts
  </files>
  <action>
Create src/lib/uncover/reveal-pattern.ts with:

1. **Tile interface:**
```typescript
interface Tile {
  x: number;      // Column index (0-15)
  y: number;      // Row index (0-15)
  index: number;  // Flat index (0-255)
}
```

2. `generateTileGrid(gridSize = 16): Tile[]`: Creates 16x16 grid of tiles
   - Returns 256 tiles with x, y, index properties
   - Flat array row-by-row

3. `orderTilesByDistance(tiles: Tile[], gridSize = 16): Tile[]`: Orders tiles by distance from center
   - Tiles furthest from center come FIRST (edges/corners reveal first)
   - Center tiles come LAST (most identifying part revealed last)
   - Use Euclidean distance from (gridSize/2 - 0.5, gridSize/2 - 0.5)

4. `shuffleTilesWithSeed(tiles: Tile[], seed: string): Tile[]`: Applies Fisher-Yates shuffle with seed
   - Imports from seeded-random.ts
   - Used to add randomness while maintaining determinism

5. `getTilesForStage(orderedTiles: Tile[], stage: number, totalStages = 6): Tile[]`: Get revealed tiles for a stage
   - Stage 1: ~16% of tiles (edge tiles)
   - Stage 6: 100% of tiles (all revealed)
   - Returns tiles revealed SO FAR (cumulative, not incremental)

6. **Blur strip generation (for blur style):**
```typescript
interface Strip {
  startRow: number;
  endRow: number;    // exclusive
  revealed: boolean;
}
```

`generateStrips(gridSize = 16, numStrips = 6): Strip[]`: Divides grid into horizontal strips
   - Returns 6 strips covering rows 0-15
   - Each strip ~2-3 rows (16 rows / 6 strips)

`getStripsForStage(strips: Strip[], stage: number): Strip[]`: Get revealed strips for stage
   - Stage 1: 1 strip revealed
   - Stage 6: all strips revealed

Add comprehensive JSDoc comments.
  </action>
  <verify>
TypeScript compiles: `pnpm type-check`
  </verify>
  <done>
reveal-pattern.ts exports Tile, Strip interfaces and all generation/ordering functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Zustand store for reveal style preference</name>
  <files>
    - src/stores/useRevealStore.ts
  </files>
  <action>
Create src/stores/useRevealStore.ts following useSearchStore.ts pattern:

```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

export type RevealStyle = 'pixelation' | 'blur';

interface RevealState {
  // User's preferred reveal style (persisted)
  preferredStyle: RevealStyle;
  setPreferredStyle: (style: RevealStyle) => void;
}

export const useRevealStore = create<RevealState>()(
  persist(
    (set) => ({
      preferredStyle: 'pixelation', // Default for new players
      setPreferredStyle: (style) => set({ preferredStyle: style }),
    }),
    {
      name: 'reveal-preferences', // localStorage key
      storage: createJSONStorage(() => localStorage),
    }
  )
);
```

This follows the exact pattern from useSearchStore.ts for consistency.
  </action>
  <verify>
TypeScript compiles: `pnpm type-check`
  </verify>
  <done>
useRevealStore.ts exports useRevealStore hook with preferredStyle and setPreferredStyle.
  </done>
</task>

</tasks>

<verification>
1. `pnpm type-check` passes
2. `pnpm lint` passes (fix with `pnpm lint:fix` if needed)
3. seedrandom in package.json dependencies
4. @types/seedrandom in devDependencies
5. All three files exist with correct exports
</verification>

<success_criteria>
1. seedrandom installed and importable
2. seeded-random.ts produces identical sequences for same seed
3. reveal-pattern.ts generates 256 tiles in 16x16 grid
4. Tile ordering places corner tiles before center tiles
5. useRevealStore persists preferredStyle to localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/36-image-reveal-engine/36-01-SUMMARY.md`
</output>
