---
phase: 29-related-entity-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/[timestamp]_add_root_job_id_and_linked_category/migration.sql
autonomous: true

must_haves:
  truths:
    - "LlamaLog records can store rootJobId field"
    - "LINKED category available in LlamaLogCategory enum"
    - "Existing logs with parentJobId have rootJobId backfilled"
    - "Root jobs have rootJobId set to their own jobId"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "rootJobId field on LlamaLog, LINKED in enum"
      contains: "rootJobId"
    - path: "prisma/migrations/*_add_root_job_id_and_linked_category/migration.sql"
      provides: "Migration with backfill SQL"
      contains: "root_job_id"
  key_links:
    - from: "prisma/schema.prisma"
      to: "database"
      via: "prisma migrate dev"
      pattern: "root_job_id"
---

<objective>
Add rootJobId column and LINKED category to LlamaLog schema with backfill migration.

Purpose: Enable dual-hierarchy job tracking (parentJobId for chain, rootJobId for quick queries) and distinguish entity creation vs linking.

Output: Schema migration applied with existing data backfilled correctly.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-related-entity-tracking/29-CONTEXT.md
@.planning/phases/29-related-entity-tracking/29-RESEARCH.md

@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma Schema</name>
  <files>prisma/schema.prisma</files>
  <action>
1. Add LINKED to LlamaLogCategory enum (after FAILED):
   ```prisma
   enum LlamaLogCategory {
     CREATED
     ENRICHED
     CORRECTED
     CACHED
     FAILED
     LINKED     // Entity was linked/associated with existing entity
   }
   ```

2. Add rootJobId field to LlamaLog model (after parentJobId):
   ```prisma
   rootJobId          String?                @map("root_job_id") @db.VarChar(100) // Root job ID for hierarchy queries
   ```

3. Add index on rootJobId for fast queries:
   ```prisma
   @@index([rootJobId])
   ```
  </action>
  <verify>Run `pnpm prisma validate` - should pass without errors</verify>
  <done>Schema contains rootJobId field and LINKED enum value</done>
</task>

<task type="auto">
  <name>Task 2: Create and Apply Migration with Backfill</name>
  <files>prisma/migrations/[timestamp]_add_root_job_id_and_linked_category/migration.sql</files>
  <action>
1. Run `pnpm prisma migrate dev --name add_root_job_id_and_linked_category --create-only` to generate migration file

2. Edit the generated migration.sql to include backfill logic:

   After the ALTER statements, add:
   ```sql
   -- Backfill root jobs: Set rootJobId = jobId where parentJobId IS NULL and jobId EXISTS
   UPDATE "llama_logs"
   SET "root_job_id" = "job_id"
   WHERE "parent_job_id" IS NULL AND "job_id" IS NOT NULL;

   -- Backfill child jobs: Walk parent chain to find root
   -- Using recursive CTE with depth limit for safety
   WITH RECURSIVE job_chain AS (
     -- Base case: Logs with parents
     SELECT 
       id,
       "job_id",
       "parent_job_id",
       "parent_job_id" as root_candidate,
       1 as depth
     FROM "llama_logs"
     WHERE "parent_job_id" IS NOT NULL
     
     UNION ALL
     
     -- Recursive case: Walk up to find root
     SELECT 
       jc.id,
       jc."job_id",
       parent."parent_job_id",
       COALESCE(parent."job_id", jc.root_candidate) as root_candidate,
       jc.depth + 1
     FROM job_chain jc
     JOIN "llama_logs" parent ON parent."job_id" = jc."parent_job_id"
     WHERE jc.depth < 10
   ),
   root_jobs AS (
     SELECT DISTINCT ON (id)
       id,
       root_candidate as root_job_id
     FROM job_chain
     ORDER BY id, depth DESC
   )
   UPDATE "llama_logs" ll
   SET "root_job_id" = rj.root_job_id
   FROM root_jobs rj
   WHERE ll.id = rj.id AND ll."root_job_id" IS NULL;

   -- Comment explaining NULL values
   COMMENT ON COLUMN "llama_logs"."root_job_id" IS 'Root job ID for hierarchy queries. NULL indicates pre-Phase 29 orphan data without job tracking.';
   ```

3. Apply the migration: `pnpm prisma migrate dev`

4. Regenerate Prisma client: `pnpm prisma generate`
  </action>
  <verify>
- Run `pnpm prisma migrate dev` - should complete without errors
- Query database to verify backfill worked:
  ```sql
  SELECT 
    COUNT(*) FILTER (WHERE root_job_id IS NOT NULL) as filled,
    COUNT(*) FILTER (WHERE root_job_id IS NULL) as orphans,
    COUNT(*) as total
  FROM llama_logs;
  ```
  Expected: ~1567 filled (1537 root + 30 with parents), ~2485 orphans, ~4052 total
  </verify>
  <done>Migration applied, rootJobId backfilled for existing records, LINKED enum available</done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeScript Types</name>
  <files>src/generated/prisma</files>
  <action>
1. Run `pnpm type-check` to verify generated types include:
   - `rootJobId?: string | null` on LlamaLog type
   - `LINKED` in LlamaLogCategory enum

2. Verify imports work:
   ```typescript
   import { LlamaLogCategory } from '@prisma/client';
   const category: LlamaLogCategory = 'LINKED'; // Should compile
   ```
  </action>
  <verify>`pnpm type-check` passes</verify>
  <done>TypeScript types reflect schema changes</done>
</task>

</tasks>

<verification>
- [ ] `pnpm prisma validate` passes
- [ ] Migration file exists with backfill SQL
- [ ] `pnpm prisma migrate dev` completes without errors
- [ ] `pnpm type-check` passes
- [ ] Database query shows rootJobId populated for existing tracked jobs
</verification>

<success_criteria>
- LlamaLog model has rootJobId field (nullable VARCHAR(100))
- LlamaLogCategory enum includes LINKED value
- Index exists on rootJobId for query performance
- Existing root jobs have rootJobId = jobId
- Existing child jobs have rootJobId traced to their root
- Orphan logs (pre-tracking) have rootJobId = NULL
</success_criteria>

<output>
After completion, create `.planning/phases/29-related-entity-tracking/29-01-SUMMARY.md`
</output>
