---
phase: 29-related-entity-tracking
plan: 04
type: execute
wave: 2
depends_on: [29-01, 29-02]
files_modified:
  - src/lib/queue/processors/enrichment-processor.ts
  - src/lib/spotify/mappers.ts
autonomous: true

must_haves:
  truths:
    - "Track creation during enrichment is logged with parentJobId and rootJobId"
    - "Track creation from Spotify sync is logged with parentJobId and rootJobId"
    - "Each track gets its own log entry (granular logging)"
    - "Child track creations have isRootJob: false"
  artifacts:
    - path: "src/lib/queue/processors/enrichment-processor.ts"
      provides: "Track creation logging during enrichment"
      contains: "track:created:enrichment"
    - path: "src/lib/spotify/mappers.ts"
      provides: "Track creation logging during Spotify sync"
      contains: "track:created"
  key_links:
    - from: "prisma.track.create"
      to: "logger.logEnrichment"
      via: "post-creation logging"
      pattern: "track\\.create.*logEnrichment"
---

<objective>
Instrument all track creation paths with LlamaLog logging using parent/root job hierarchy.

Purpose: Track creation provenance with granular logging (one entry per track) for complete entity lineage.

Output: All track creation paths log to LlamaLog with correct job hierarchy.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-related-entity-tracking/29-CONTEXT.md
@.planning/phases/29-related-entity-tracking/29-RESEARCH.md

@src/lib/logging/llama-logger.ts
@src/lib/queue/processors/enrichment-processor.ts
@src/lib/spotify/mappers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track Logging in Enrichment Processor</name>
  <files>src/lib/queue/processors/enrichment-processor.ts</files>
  <action>
Find the track creation during bulk track processing (around line 2300-2320):

1. Import createLlamaLogger if not already imported

2. After `const newTrack = await (prisma.track as any).create(...)` (around line 2300), add logging:
   ```typescript
   // Log track creation to LlamaLog
   const llamaLogger = createLlamaLogger(prisma);
   const trackJobId = `track-${newTrack.id}`;
   try {
     await llamaLogger.logEnrichment({
       entityType: 'TRACK',
       entityId: newTrack.id,
       operation: 'track:created:enrichment',
       category: 'CREATED',
       sources: ['MUSICBRAINZ'],
       status: 'SUCCESS',
       fieldsEnriched: ['title', 'trackNumber', 'durationMs', 'musicbrainzId', 'isrc', 'youtubeUrl'].filter(
         f => newTrack[f] !== null && newTrack[f] !== undefined
       ),
       jobId: trackJobId,
       parentJobId: jobId, // enrichment job ID
       rootJobId: data.rootJobId || jobId, // passed from album or use enrichment job
       isRootJob: false,
       dataQualityAfter: 'HIGH',
       metadata: {
         albumId,
         trackNumber,
         discNumber,
         mbRecordingId: mbRecording.id,
       },
     });
   } catch (err) {
     console.warn('[LlamaLog] Failed to log track creation:', err);
   }
   ```

3. For track creation failures (in the catch block around line 2360), add FAILED logging:
   ```typescript
   // Log track creation failure
   try {
     const llamaLogger = createLlamaLogger(prisma);
     await llamaLogger.logEnrichment({
       entityType: 'TRACK',
       entityId: null,
       operation: 'track:failed:enrichment',
       category: 'FAILED',
       sources: ['MUSICBRAINZ'],
       status: 'FAILED',
       fieldsEnriched: [],
       parentJobId: jobId,
       rootJobId: data.rootJobId || jobId,
       isRootJob: false,
       errorMessage: trackError instanceof Error ? trackError.message : String(trackError),
       metadata: {
         albumId,
         attemptedTitle: mbRecording.title,
         attemptedTrackNumber: trackNumber,
       },
     });
   } catch (logErr) {
     console.warn('[LlamaLog] Failed to log track failure:', logErr);
   }
   ```

Note: The enrichment job data should include rootJobId. If not present, the processor uses its own jobId as fallback. This will be improved as the flow is fully instrumented.
  </action>
  <verify>pnpm type-check passes, enrichment-processor.ts contains 'track:created:enrichment' and 'track:failed:enrichment'</verify>
  <done>Enrichment processor logs track creation with granular per-track entries</done>
</task>

<task type="auto">
  <name>Task 2: Track Logging in Spotify Mappers</name>
  <files>src/lib/spotify/mappers.ts</files>
  <action>
Find the createTrackRecord function (around line 663):

1. Import createLlamaLogger if not already imported:
   import { createLlamaLogger } from '@/lib/logging/llama-logger';

2. The createTrackRecord function needs context about the parent job. Modify the function signature to accept optional job context:
   ```typescript
   export async function createTrackRecord(
     trackData: TrackCreationData,
     jobContext?: {
       parentJobId?: string;
       rootJobId?: string;
     }
   ): Promise<string> {
   ```

3. After `const track = await prisma.track.create(...)`, add logging:
   ```typescript
   // Log track creation to LlamaLog
   const llamaLogger = createLlamaLogger(prisma);
   const trackJobId = `track-${track.id}`;
   try {
     await llamaLogger.logEnrichment({
       entityType: 'TRACK',
       entityId: track.id,
       operation: 'track:created:spotify-sync',
       category: 'CREATED',
       sources: ['SPOTIFY'],
       status: 'SUCCESS',
       fieldsEnriched: ['title', 'trackNumber', 'discNumber', 'durationMs', 'spotifyId', 'explicit', 'previewUrl'],
       jobId: trackJobId,
       parentJobId: jobContext?.parentJobId || null,
       rootJobId: jobContext?.rootJobId || null,
       isRootJob: false,
       dataQualityAfter: 'LOW',
       metadata: {
         albumId: trackData.albumId,
         trackNumber: trackData.trackNumber,
         spotifyId: trackData.spotifyId,
       },
     });
   } catch (err) {
     console.warn('[LlamaLog] Failed to log track creation:', err);
   }
   ```

4. Update callers of createTrackRecord to pass job context. Find processSpotifyTracks (around line 700) and update the call:
   ```typescript
   const trackId = await createTrackRecord(trackData, {
     parentJobId: metadataOptions?.jobId,
     rootJobId: metadataOptions?.jobId, // For Spotify sync, album job is the root
   });
   ```

5. The processSpotifyTracks function also needs the jobContext parameter. Update its signature and pass through to createTrackRecord.
  </action>
  <verify>pnpm type-check passes, mappers.ts contains 'track:created:spotify-sync'</verify>
  <done>Spotify mappers log track creation with job hierarchy</done>
</task>

</tasks>

<verification>
- [ ] pnpm type-check passes
- [ ] enrichment-processor.ts contains 'track:created:enrichment'
- [ ] enrichment-processor.ts contains 'track:failed:enrichment'
- [ ] spotify/mappers.ts contains 'track:created:spotify-sync'
- [ ] All track creation paths have parentJobId and rootJobId
- [ ] Granular logging: one log per track, not summary counts
</verification>

<success_criteria>
- RELATE-03: Track creation logged as child of album creation/enrichment
- RELATE-04: Track creation has parentJobId pointing to root job (or enrichment job)
- RELATE-05: Child creations have isRootJob: false
- Granular logging: Each track gets individual log entry
- Failure logging: Track creation failures logged with FAILED category
</success_criteria>

<output>
After completion, create .planning/phases/29-related-entity-tracking/29-04-SUMMARY.md
</output>
