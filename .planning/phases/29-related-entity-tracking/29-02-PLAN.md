---
phase: 29-related-entity-tracking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/logging/llama-logger.ts
autonomous: true

must_haves:
  truths:
    - "LlamaLogData interface accepts rootJobId parameter"
    - "logEnrichment() writes rootJobId to database"
    - "rootJobId defaults to jobId when isRootJob is true"
  artifacts:
    - path: "src/lib/logging/llama-logger.ts"
      provides: "rootJobId support in LlamaLogger"
      contains: "rootJobId"
  key_links:
    - from: "LlamaLogData.rootJobId"
      to: "prisma.llamaLog.create"
      via: "logEnrichment method"
      pattern: "rootJobId.*data\\.rootJobId"
---

<objective>
Add rootJobId to LlamaLogger interface and implementation.

Purpose: Enable callers to pass rootJobId for job hierarchy tracking, with auto-computation for root jobs.

Output: LlamaLogger accepts and writes rootJobId field correctly.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-related-entity-tracking/29-CONTEXT.md

@src/lib/logging/llama-logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rootJobId to LlamaLogData Interface</name>
  <files>src/lib/logging/llama-logger.ts</files>
  <action>
1. Add rootJobId field to LlamaLogData interface (after parentJobId):
   - Add field: rootJobId?: string | null
   - Add JSDoc: "Root job ID for hierarchy queries (original album job). Auto-computed for root jobs."
   - Update existing parentJobId comment from "root job ID in flat structure" to "immediate parent"

2. Update logEnrichment() to handle rootJobId:
   - After the isRootJob computation, add rootJobId computation:
     const rootJobId = data.rootJobId ?? (isRootJob ? data.jobId : null);

3. Add rootJobId to the prisma.llamaLog.create data object:
   - Add line: rootJobId,

4. Update console log to include rootJobId indicator when present:
   - Add rootInfo variable showing truncated rootJobId
   - Append to log message
  </action>
  <verify>pnpm type-check passes - LlamaLogData interface and logEnrichment signature are valid</verify>
  <done>LlamaLogData has rootJobId field, logEnrichment writes it to database with auto-computation for root jobs</done>
</task>

<task type="auto">
  <name>Task 2: Validate Existing Callers</name>
  <files>src/lib/logging/llama-logger.ts</files>
  <action>
1. Search for existing logEnrichment callers to understand current usage

2. Verify no breaking changes:
   - rootJobId is optional with nullable type
   - Auto-computed for root jobs (isRootJob: true)
   - Callers not passing rootJobId will get null for child jobs (acceptable for now, to be instrumented in Plans 03/04)

3. Run type-check to ensure all callers compile
  </action>
  <verify>All existing callers compile without errors</verify>
  <done>Backward compatibility confirmed, existing callers work without changes</done>
</task>

</tasks>

<verification>
- [ ] LlamaLogData interface includes rootJobId?: string | null
- [ ] logEnrichment() computes rootJobId = jobId for root jobs
- [ ] logEnrichment() writes rootJobId to database
- [ ] pnpm type-check passes
- [ ] Console log shows rootJobId when present
</verification>

<success_criteria>
- LlamaLogData has rootJobId field with proper JSDoc
- Root jobs automatically get rootJobId = jobId
- Child jobs receive caller-provided rootJobId or null
- All existing code compiles (backward compatible)
</success_criteria>

<output>
After completion, create .planning/phases/29-related-entity-tracking/29-02-SUMMARY.md
</output>
