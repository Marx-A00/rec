---
phase: 29-related-entity-tracking
plan: 03
type: execute
wave: 2
depends_on: [29-01, 29-02]
files_modified:
  - src/lib/graphql/resolvers/mutations.ts
  - src/lib/queue/processors/enrichment-processor.ts
  - src/lib/queue/processors/musicbrainz-processor.ts
  - src/lib/spotify/mappers.ts
autonomous: true

must_haves:
  truths:
    - "Artist creation from addAlbum mutation is logged with parentJobId and rootJobId"
    - "Artist creation from enrichment processor is logged with parentJobId and rootJobId"
    - "Artist creation from sync operations is logged with parentJobId and rootJobId"
    - "LINKED category used when associating existing artists"
    - "CREATED category used when creating new artists"
  artifacts:
    - path: "src/lib/graphql/resolvers/mutations.ts"
      provides: "Artist creation logging in addAlbum"
      contains: "artist:created"
    - path: "src/lib/queue/processors/enrichment-processor.ts"
      provides: "Track-artist creation logging"
      contains: "artist:created:track-child"
    - path: "src/lib/queue/processors/musicbrainz-processor.ts"
      provides: "Sync artist creation logging"
      contains: "artist:created"
    - path: "src/lib/spotify/mappers.ts"
      provides: "Spotify artist creation logging"
      contains: "artist:created"
  key_links:
    - from: "prisma.artist.create"
      to: "logger.logEnrichment"
      via: "post-creation logging"
      pattern: "artist\\.create.*logEnrichment"
---

<objective>
Instrument all artist creation paths with LlamaLog logging using parent/root job hierarchy.

Purpose: Track artist creation provenance, distinguishing between new entity creation (CREATED) and existing entity association (LINKED).

Output: All 8 artist creation paths log to LlamaLog with correct job hierarchy.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-related-entity-tracking/29-CONTEXT.md
@.planning/phases/29-related-entity-tracking/29-RESEARCH.md

@src/lib/logging/llama-logger.ts
@src/lib/graphql/resolvers/mutations.ts
@src/lib/queue/processors/enrichment-processor.ts
@src/lib/queue/processors/musicbrainz-processor.ts
@src/lib/spotify/mappers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Artist Logging in addAlbum Mutation</name>
  <files>src/lib/graphql/resolvers/mutations.ts</files>
  <action>
In the addAlbum mutation (around line 780-820), find the artist creation/linking section:

1. At the start of addAlbum, generate album job ID:
   const albumJobId = `album-${album.id}`;
   (Note: album.id is available after album creation, so capture after album.create)

2. After the existing `await logActivity(...)` for new artist creation (~line 815), add:
   ```typescript
   // Log artist creation to LlamaLog
   try {
     await logger.logEnrichment({
       entityType: 'ARTIST',
       entityId: newArtist.id,
       operation: 'artist:created:album-child',
       category: 'CREATED',
       sources: ['ADMIN', 'MUSICBRAINZ'],
       status: 'SUCCESS',
       fieldsEnriched: ['name'],
       parentJobId: albumJobId,
       rootJobId: albumJobId,
       isRootJob: false,
       userId: user.id,
       dataQualityAfter: 'LOW',
     });
   } catch (err) {
     console.warn('[LlamaLog] Failed to log artist creation:', err);
   }
   ```

3. For existing artist case (when `existingArtist` is found, ~line 789), add LINKED logging:
   ```typescript
   // Log artist linking to LlamaLog
   try {
     await logger.logEnrichment({
       entityType: 'ARTIST',
       entityId: existingArtist.id,
       operation: 'artist:linked:album-association',
       category: 'LINKED',
       sources: ['ADMIN'],
       status: 'SUCCESS',
       fieldsEnriched: [],
       parentJobId: albumJobId,
       rootJobId: albumJobId,
       isRootJob: false,
       userId: user.id,
       metadata: {
         albumId: album.id,
         existingEntity: true,
       },
     });
   } catch (err) {
     console.warn('[LlamaLog] Failed to log artist linking:', err);
   }
   ```

4. Ensure albumJobId is captured after album.create and before the artist loop. The album creation already logs with isRootJob: true, so artists are children.
  </action>
  <verify>pnpm type-check passes, mutations.ts contains 'artist:created:album-child' and 'artist:linked:album-association'</verify>
  <done>addAlbum mutation logs both artist creation (CREATED) and artist linking (LINKED)</done>
</task>

<task type="auto">
  <name>Task 2: Artist Logging in Enrichment Processor</name>
  <files>src/lib/queue/processors/enrichment-processor.ts</files>
  <action>
Find the artist creation during track enrichment (around line 2337):

1. Import createLlamaLogger if not already imported:
   import { createLlamaLogger } from '@/lib/logging/llama-logger';

2. After `dbArtist = await prisma.artist.create(...)` (around line 2337), add:
   ```typescript
   // Log artist creation for track
   const llamaLogger = createLlamaLogger(prisma);
   try {
     await llamaLogger.logEnrichment({
       entityType: 'ARTIST',
       entityId: dbArtist.id,
       operation: 'artist:created:track-child',
       category: 'CREATED',
       sources: ['MUSICBRAINZ'],
       status: 'SUCCESS',
       fieldsEnriched: ['name', 'musicbrainzId'],
       parentJobId: jobId, // enrichment job ID
       rootJobId: data.rootJobId || jobId, // passed from album creation or use enrichment job
       isRootJob: false,
       dataQualityAfter: 'MEDIUM',
       metadata: {
         trackId: newTrack.id,
         trackTitle: mbRecording.title,
       },
     });
   } catch (err) {
     console.warn('[LlamaLog] Failed to log artist creation:', err);
   }
   ```

3. For the existing artist case (when dbArtist is found), add LINKED logging after the trackArtist.create:
   ```typescript
   // Log artist linking to track (only if artist already existed)
   // Note: Check if this was an existing artist find, not a new creation
   ```

The enrichment processor should pass rootJobId in job data. If not present, use the current jobId as fallback (acceptable for now - will be improved as flows are instrumented).
  </action>
  <verify>pnpm type-check passes, enrichment-processor.ts contains 'artist:created:track-child'</verify>
  <done>Enrichment processor logs artist creation during track enrichment</done>
</task>

<task type="auto">
  <name>Task 3: Artist Logging in MusicBrainz Processor</name>
  <files>src/lib/queue/processors/musicbrainz-processor.ts</files>
  <action>
Find the artist creation during MusicBrainz sync (around line 226):

1. After `dbArtist = await prisma.artist.create(...)` (line 226), add artist creation logging:
   ```typescript
   // Log artist creation for MusicBrainz sync
   try {
     await llamaLogger.logEnrichment({
       entityType: 'ARTIST',
       entityId: dbArtist.id,
       operation: 'artist:created:musicbrainz-sync',
       category: 'CREATED',
       sources: ['MUSICBRAINZ'],
       status: 'SUCCESS',
       fieldsEnriched: ['name', 'musicbrainzId'],
       parentJobId: data.requestId || 'mb-sync-batch',
       rootJobId: data.requestId || 'mb-sync-batch', // Sync batch is the root
       isRootJob: false,
       dataQualityAfter: 'MEDIUM',
       metadata: {
         syncSource: 'musicbrainz_new_releases',
         artistMbId: artist.id,
       },
     });
   } catch (err) {
     console.warn('[LlamaLog] Failed to log artist creation:', err);
   }
   ```

2. llamaLogger should already be created before the album creation logging (from Phase 28). Reuse that instance.

Note: In MusicBrainz sync, the artist is created BEFORE the album (as album needs artistId). The parentJobId points to the sync batch, and the subsequent album creation will also have the same parentJobId. This creates sibling relationships which is correct for sync operations.
  </action>
  <verify>pnpm type-check passes, musicbrainz-processor.ts contains 'artist:created:musicbrainz-sync'</verify>
  <done>MusicBrainz sync logs artist creation with sync batch as parent</done>
</task>

</tasks>

<verification>
- [ ] pnpm type-check passes
- [ ] mutations.ts contains 'artist:created:album-child' and 'artist:linked:album-association'
- [ ] enrichment-processor.ts contains 'artist:created:track-child'
- [ ] musicbrainz-processor.ts contains 'artist:created:musicbrainz-sync'
- [ ] All artist creation paths have parentJobId and rootJobId
- [ ] LINKED category used for existing entity associations
</verification>

<success_criteria>
- RELATE-01: Artist creation logged as child of album creation (covered by addAlbum, enrichment)
- RELATE-02: Artist creation has parentJobId pointing to album's jobId (or enrichment/sync job)
- RELATE-05: Child creations have isRootJob: false
- LINKED vs CREATED categories correctly distinguish new vs existing entities
</success_criteria>

<output>
After completion, create .planning/phases/29-related-entity-tracking/29-03-SUMMARY.md
</output>
